<!DOCTYPE html>
<html lang="es">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
Â  Â  <meta name="apple-mobile-web-app-capable" content="yes">
Â  Â  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
Â  Â  <meta name="apple-mobile-web-app-title" content="NacionalizaciÃ³n CR">
Â  Â  <title>CÃ¡lculo de Impuestos con VIN</title>

Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

Â  Â  <script src="https://cdn.jsdelivr.net/npm/@zxing/browser@latest/umd/zxing-browser.min.js"></script>

Â  Â  <style>
Â  Â  Â  Â  * { margin: 0; padding: 0; box-sizing: border-box; }
Â  Â  Â  Â  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(to bottom right, #e0f2fe, #e0e7ff); }
Â  Â  Â  Â  .header { background: linear-gradient(135deg, #2563eb 0%, #4f46e5 100%); color: white; padding: 16px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
Â  Â  Â  Â  .header-title { display: flex; align-items: center; gap: 8px; }
Â  Â  Â  Â  .header-logo { width: 36px; height: 36px; }
Â  Â  Â  Â  .header-title h1 {
Â  Â  Â  Â  Â  Â  font-size: 18px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  color: white; /* TÃ­tulo en blanco para mÃ¡ximo contraste */
Â  Â  Â  Â  Â  Â  text-shadow: 0 1px 3px rgba(0,0,0,0.25);
Â  Â  Â  Â  }
Â  Â  Â  Â  .header-title p {
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  color: #fecdd3; /* Tono rojo-rosado profesional */
Â  Â  Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  }
Â  Â  Â  Â  .header-buttons { display: flex; gap: 8px; }
Â  Â  Â  Â  button { border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }

Â  Â  Â  Â  /* Estilos de Botones */
Â  Â  Â  Â  .btn-icon { background: rgba(255,255,255,0.2); color: white; width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 16px; }
Â  Â  Â  Â  .btn-icon:active { background: rgba(255,255,255,0.3); }

Â  Â  Â  Â  .btn-header { background: rgba(255,255,255,0.2); color: white; width: auto; padding: 8px 12px; font-size: 12px; }
Â  Â  Â  Â  .btn-header.active { background: #fbbf24; color: #1f2937; }

Â  Â  Â  Â  .btn-secondary { background: #e5e7eb; color: #374151; padding: 12px; }
Â  Â  Â  Â  .btn-secondary:active { background: #d1d5db; }

Â  Â  Â  Â  .btn-primary { background: linear-gradient(135deg, #2563eb 0%, #4f46e5 100%); color: white; grid-column: 1 / -1; padding: 12px; }
Â  Â  Â  Â  .btn-primary:disabled { background: #d1d5db; cursor: not-allowed; }

Â  Â  Â  Â  .btn-result { background: rgba(255,255,255,0.2); color: white; padding: 12px; font-size: 12px; font-weight: 600; }
Â  Â  Â  Â  .btn-result:active { background: rgba(255,255,255,0.3); }

Â  Â  Â  Â  .btn-danger-light { background: #fee2e2; color: #dc2626; padding: 4px 8px; font-size: 11px; border-radius: 4px; }
Â  Â  Â  Â  .btn-info-light { background: #dbeafe; color: #1e40af; padding: 12px; border-radius: 8px; }
Â  Â  Â  Â  .btn-success-light { background: #dcfce7; color: #15803d; padding: 12px; border-radius: 8px; }
Â  Â  Â  Â  .btn-update-tc { background: #dbeafe; color: #2563eb; font-size: 11px; padding: 6px 10px; font-weight: bold; }
Â  Â  Â  Â  .btn-update-tc:active { background: #bfdbfe; }

Â  Â  Â  Â  /* Contenedores y Tarjetas */
Â  Â  Â  Â  .container { max-width: 500px; margin: 0 auto; padding: 16px; }
Â  Â  Â  Â  .card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
Â  Â  Â  Â  .card-title { font-size: 16px; font-weight: bold; margin-bottom: 12px; color: #1f2937; }

Â  Â  Â  Â  /* Formulario */
Â  Â  Â  Â  .form-group { margin-bottom: 12px; }
Â  Â  Â  Â  .form-group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
Â  Â  Â  Â  label { display: block; font-size: 12px; font-weight: 600; color: #374151; }
Â  Â  Â  Â  input { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; font-family: inherit; }
Â  Â  Â  Â  input:focus { outline: none; border-color: #2563eb; background: #f0f9ff; }
Â  Â  Â  Â  .help-text { font-size: 11px; color: #6b7280; margin-top: 4px; display: flex; align-items: center; gap: 6px;}
Â  Â  Â  Â  .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }

Â  Â  Â  Â  /* NUEVA FICHA INFORMATIVA VIN */
Â  Â  Â  Â  .info-card { background-color: #eff6ff; border: 2px solid #93c5fd; padding: 12px; margin-top: 16px; }
Â  Â  Â  Â  .info-card-title { font-size: 14px; font-weight: bold; color: #1e40af; margin-bottom: 10px; }
Â  Â  Â  Â  .info-card .detail-row { padding: 8px 0; font-size: 14px; }
Â  Â  Â  Â  .info-card .detail-label { color: #374151; }
Â  Â  Â  Â  .info-card .detail-value { color: #1f2937; }

Â  Â  Â  Â  /* SPINNER DE CARGA */
Â  Â  Â  Â  .spinner {
Â  Â  Â  Â  Â  Â  width: 14px; height: 14px;
Â  Â  Â  Â  Â  Â  border: 2px solid #93c5fd; border-top-color: #3b82f6;
Â  Â  Â  Â  Â  Â  border-radius: 50%; animation: spin 1s linear infinite;
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes spin { to { transform: rotate(360deg); } }

Â  Â  Â  Â  /* Resultados y Detalles */
Â  Â  Â  Â  .result-card { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; margin-bottom: 16px; padding: 16px; border-radius: 12px; }
Â  Â  Â  Â  .result-amount { font-size: 32px; font-weight: bold; margin-bottom: 16px; }
Â  Â  Â  Â  .result-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

Â  Â  Â  Â  .detail-row { display: flex; justify-content: space-between; padding: 10px 0; font-size: 13px; border-bottom: 1px solid #e5e7eb; }
Â  Â  Â  Â  .detail-row.subtotal { font-weight: bold; color: #1e40af; }
Â  Â  Â  Â  .detail-label { color: #6b7280; }
Â  Â  Â  Â  .detail-value { font-weight: 600; color: #1f2937; }
Â  Â  Â  Â  .section-header { background: #dbeafe; color: #1e40af; padding: 8px 12px; border-radius: 6px; font-size: 11px; font-weight: bold; margin-top: 12px; margin-bottom: 8px; }
Â  Â  Â  Â  .total-row { background: #f0fdf4; padding: 12px; border-radius: 6px; margin-top: 12px; font-weight: bold; display: flex; justify-content: space-between; font-size: 16px; }

Â  Â  Â  Â  /* Historial y Comparador */
Â  Â  Â  Â  .comparison-card { background: white; border: 2px solid #93c5fd; border-radius: 8px; padding: 12px; margin-bottom: 12px; cursor: pointer; }
Â  Â  Â  Â  .comparison-card:active { background: #eff6ff; border-color: #3b82f6; }
Â  Â  Â  Â  .comparison-card.selected { border-color: #2563eb; background: #eff6ff; border-width: 3px; }

Â  Â  Â  Â  .hidden { display: none !important; }

Â  Â  Â  Â  /* --- *** INICIO CORRECCIÃ“N CSS SCANNER *** --- */
Â  Â  Â  Â  #scanner-container {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  background: #000; /* Fondo negro sÃ³lido */
Â  Â  Â  Â  Â  Â  z-index: 200;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  #videoElement {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 50%;
Â  Â  Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  object-fit: cover; /* Llena la pantalla, mantiene aspecto */
Â  Â  Â  Â  Â  Â  transform: translate(-50%, -50%);
Â  Â  Â  Â  Â  Â  z-index: 201;
Â  Â  Â  Â  }
Â  Â  Â  Â  #scanner-overlay {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  z-index: 202; /* Sobre el video */
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  #scanner-viewfinder {
Â  Â  Â  Â  Â  Â  width: 90%; /* Ancho, para cÃ³digos de barras horizontales */
Â  Â  Â  Â  Â  Â  max-width: 600px;
Â  Â  Â  Â  Â  Â  height: 100px; /* Alargado */
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  border: 2px solid rgba(255, 255, 255, 0.7);
Â  Â  Â  Â  Â  Â  /* El truco del "recorte" (dimmer) */
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 0 9999px rgba(0,0,0,0.7);Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .scanner-red-line {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 2px;
Â  Â  Â  Â  Â  Â  background: #dc2626;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 8px #dc2626;
Â  Â  Â  Â  Â  Â  top: 50%;
Â  Â  Â  Â  Â  Â  transform: translateY(-50%);
Â  Â  Â  Â  }
Â  Â  Â  Â  .scanner-text {
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  margin-top: 24px;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  text-shadow: 0 1px 2px rgba(0,0,0,0.5);
css
Â  Â  Â  Â  }
Â  Â  Â  Â  #btnStopScan {
Â  Â  Â  Â  Â  Â  margin-top: 24px;
Â  Â  Â  Â  Â  Â  padding: 12px 24px;
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  Â  Â  background: rgba(255,255,255,0.2);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  border: 1px solid rgba(255,255,255,0.5);
Â  Â  Â  Â  }
Â  Â  Â  Â  #btnStopScan:active {
Â  Â  Â  Â  Â  Â  background: rgba(255,255,255,0.3);
Â  Â  Â  Â  }
Â  Â  Â  Â  /* --- *** FIN CORRECCIÃ“N CSS SCANNER *** --- */
Â  Â  </style>
</head>
<body>
Â  Â  <div class="header">
Â  Â  Â  Â  <div class="header-title">
Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="white" class="header-logo">
Â  Â  Â  Â  Â  Â  Â  Â  <path d="M136.1,234.4c-15,0-27.2,12.2-27.2,27.2s12.2,27.2,27.2,27.2s27.2-12.2,27.2-27.2S151.1,234.4,136.1,234.4z M375.9,234.4
Â  Â  Â  Â  Â  Â  Â  Â  c-15,0-27.2,12.2-27.2,27.2s12.2,27.2,27.2,27.2s27.2-12.2,27.2-27.2S390.9,234.4,375.9,234.4z M464,176H48c-23.2,0-41,14.3-46.8,34.4
Â  Â  Â  Â  Â  Â  Â  Â  c-2.4,8.2-3.1,16.7-2.9,25.2v122.3c0,23.3,18.9,42.2,42.2,42.2H96v21.1c0,11.7,9.5,21.1,21.1,21.1h21.1c11.7,0,21.1-9.5,21.1-21.1
Â  Â  Â  Â  Â  Â  Â  Â  v-21.1h192v21.1c0,11.7,9.5,21.1,21.1,21.1h21.1c11.7,0,21.1-9.5,21.1-21.1v-21.1h53.8c23.3,0,42.2-18.9,42.2-42.2V235.5
Â  Â  Â  Â  Â  Â  Â  Â  c0.3-8.4-0.5-16.9-2.9-25.2C505,190.3,487.2,176,464,176z M144,304c-22.1,0-40-17.9-40-40s17.9-40,40-40s40,17.9,40,40S166.1,304,144,304
Â  Â  Â  Â  Â  Â  Â  Â  z M368,304c-22.1,0-40-17.9-40-40s17.9-40,40-40s40,17.9,40,40S390.1,304,368,304z M488,235.5c-0.1,4.5-1.1,8.9-2.9,12.9
Â  Â  Â  Â  Â  Â  Â  Â  c-4.3,9.5-13.4,15.6-23.7,15.6h-48.4c-6-30.8-32.1-53.5-63.5-56.1l48.6-48.6c3.3-3.3,3.3-8.6,0-11.8l-15.8-15.8
Â  Â  Â  Â  Â  Â  Â  Â  c-3.3-3.3-8.6-3.3-11.8,0l-65,65.1c-1.3,1.3-2.3,2.8-2.9,4.4c-11.8-1.7-23.9-2.6-36.1-2.6s-24.3,0.9-36.1,2.6
Â  Â  Â  Â  Â  Â  Â  Â  c-0.6-1.6-1.6-3.1-2.9-4.4l-65-65.1c-3.3-3.3-8.6-3.3-11.8,0l-15.8,15.8c-3.3-3.3-3.3,8.6,0,11.8l48.6,48.6
Â  Â  Â  Â  Â  Â  Â  Â  c-31.4,2.6-57.5,25.3-63.5,56.1H48.5c-10.3,0-19.4-6.2-23.7-15.6c-1.9-4-2.8-8.4-2.9-12.9V235c0-0.2,0-0.3,0-0.5
Â  Â  Â  Â  Â  Â  Â  Â  c0-8.5,3.4-16.7,9.4-22.6c6-6,14.1-9.4,22.6-9.4H464c8.5,0,16.6,3.4,22.6,9.4c6,6,9.4,14.1,9.4,22.6C488,235.1,488,235.3,488,235.5
Â  Â  Â  Â  Â  Â  Â  Â  z"/>
Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <h1>CÃ¡lculo de Impuestos</h1>
Â  Â  Â  Â  Â  Â  Â  Â  <p>ImportaciÃ³n de VehÃ­culos</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="header-buttons">
Â  Â  Â  Â  Â  Â  <button class="btn-header" id="btnComparar">Compare</button>
Â  Â  Â  Â  Â  Â  <button class="btn-header" id="btnHistorial">Historial</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="scanner-container" class="hidden">
Â  Â  Â  Â  <video id="videoElement" playsinline></video>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="scanner-overlay">
Â  Â  Â  Â  Â  Â  <div id="scanner-viewfinder">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="scanner-red-line"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="scanner-text">Centre el cÃ³digo de barras en la lÃ­nea roja</div>
Â  Â  Â  Â  Â  Â  <button id="btnStopScan">Cancelar</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div class="container">
Â  Â  Â  Â  <div id="comparador" class="card hidden">
Â  Â  Â  Â  Â  Â  <div class="card-title">Comparar VehÃ­culos</div>
Â  Â  Â  Â  Â  Â  <div id="comparacionContent"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="historialCard" class="card hidden">
Â  Â  Â  Â  Â  Â  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-title" style="margin: 0;">Historial</div>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnLimpiarHistorial" class="btn-danger-light">Limpiar</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="historialContent"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  <div class="card-title">Ingrese datos del VehÃ­culo</div>

section-header
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="vin">VIN Number</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="vin" placeholder="Ej: 5FNRL6H73LB123456" maxlength="17" autocapitalize="characters">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="help-text" id="vinStatus"></div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="button-group" style="margin-top: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnScanVIN" class="btn-secondary">ğŸ“¸ Escanear VIN</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnLimpiarVIN" class="btn-danger-light" style="padding: 12px;">Limpiar VIN</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="ano">AÃ±o del VehÃ­culo</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="ano" placeholder="2022" min="1980">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="help-text" id="ayudaAno"></div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="vinInfoCard" class="card info-card hidden">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-title info-card-title">InformaciÃ³n del VehÃ­culo</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row"><span class="detail-label">Marca</span><span class="detail-value" id="vinMake"></span></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row"><span class="detail-label">Modelo</span><span class="detail-value" id="vinModel"></span></div>
Methods
Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row"><span class="detail-label">VersiÃ³n</span><span class="detail-value" id="vinTrim"></span></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row"><span class="detail-label">Motor</span><span class="detail-value" id="vinEngine"></span></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row" style="border-bottom: none;"><span class="detail-label">PaÃ­s</span><span class="detail-value" id="vinCountry"></span></div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <hr style="border:none; border-top: 1px solid #e5e7eb; margin: 20px 0;">

Â  Â  Â  Â  Â  Â  <div class="card-title" style="font-size: 14px; margin-bottom: 8px;">Convertidor de Distancia</div>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="millaje">Millaje / Kilometraje</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="millaje" placeholder="30000">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="help-text">El color indica si estÃ¡ sobre (rojo) o bajo (verde) el promedio para el aÃ±o del vehÃ­culo.</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="button-group">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-secondary" id="btnMillasAKm">Millas a Kms</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-secondary" id="btnKmsAMillas">Kms a Millas</button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="millajeInfoCard" class="card info-card hidden" style="margin-top: 16px;">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-title info-card-title">Resultado de ConversiÃ³n</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-label" id="millajeResultadoLabel"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-value" id="millajeResultadoValor"></span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row" style="border-bottom: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-label" id="millajePromedioLabel"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-value" id="millajePromedioValor"></span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="millajePromedioStatus" style="font-size: 12px; font-weight: bold; text-align: center; margin-top: 10px;"></div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <hr style="border:none; border-top: 1px solid #e5e7eb; margin: 20px 0;">

Â  Â  Â  Â  Â  Â  <div class="card-title" style="font-size: 14px; margin-bottom: 8px;">Herramienta: CÃ¡lculo de Traspaso</div>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="valorFiscal">Valor Fiscal (â‚¡)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="valorFiscal" placeholder="10000000">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button class="btn-primary" id="btnCalcularTraspaso" style="width: 100%;">Calcular Traspaso</button>
Â  Â  Â  Â  Â  Â  <div id="resultadoTraspaso" style="margin-top: 12px;"></div>

Â  Â  Â  Â  Â  Â  <hr style="border:none; border-top: 1px solid #e5e7eb; margin: 20px 0;">
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="valor">Valor (USD)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="valor" placeholder="25000">
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="flete">Flete (USD)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="flete" placeholder="1500">
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="tipoCambio">Tipo de Cambio (â‚¡/USD)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnActualizarTC" class="btn-update-tc">Actualizar TC</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="tipoCambio" placeholder="520">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="help-text" id="tipoCambioHelp"></div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="button-group">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-secondary" id="btnLimpiarFormulario">Limpiar</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" id="btnCalcular">Calcular</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="resultado" class="hidden">
Â  Â  Â  Â  Â  Â  <div class="result-card">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;">COSTO TOTAL</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="result-amount" id="resultadoTotal"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="result-buttons">
Â  Baden-WÃ¼rttemberg Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-result" id="btnVerDetalle">Ver Detalle</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-result" id="btnGuardarHistorial">Guardar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="detalle" class="card hidden">
Methods
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-title">Desglose</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="detalleContent"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="button-group" style="margin-top: 16px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnDescargar" class="btn-info-light">Exportar (PDF)</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnWhatsApp" class="btn-success-light">WhatsApp</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="text-align: center; font-size: 11px; color: #6b7280; margin-top: 20px; margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  <p>TC Venta BCCR: <span id="tcFooter">N/A</span></p>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  // --- VARIABLES GLOBALES Y CONSTANTES ---
Â  Â  Â  Â  let historial = JSON.parse(localStorage.getItem('impuestosHistorial')) || [];
Â  Â  Â  Â  let modoComparacion = false;
Â  Â  Â  Â  let vehiculosSeleccionados = new Set();
Â  Â  Â  Â  let calculoActual = null;
Â  Â  Â  Â  let vinDecodeTimeout;
Â  Â  Â  Â  let codeReader = null; // Variable global para el scanner

Â  Â  Â  Â  const anoActual = new Date().getFullYear();

Â  Â  Â  Â  const COSTOS_FIJOS = {
Â  Â  Â  Â  Â  Â  SEGURO_1: 0.011, SEGURO_2: 0.007, PAPELEO_USA: 250,
Â  Â  Â  Â  Â  Â  DECLARACION_CR: 106000, DEKRA: 45000, ALMACENAMIENTO: 65000
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- CONSTANTES HERRAMIENTAS ---
Â  Â  Â  Â  const MILLAS_POR_KM = 0.621371;
Â  Â  Â  Â  const KM_POR_MILLA = 1.60934;
Â  Â  Â  Â  const PROMEDIO_MILLAS_ANO = 15000;
Â  Â  Â  Â  const PROMEDIO_KMS_ANO = 17000;
Â  Â  Â  Â  const PORCENTAJE_TIMBRES = 0.035;
Â  Â  Â  Â  const HONORARIOS_TRASPASO = 65000;

section-header
Â  Â  Â  Â  // --- MANEJO DE EVENTOS ---
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  Â  Â  document.getElementById('ano').addEventListener('change', validarAno);
Â  Â  Â  Â  Â  Â  document.getElementById('vin').addEventListener('input', handleVinInput);
Â  Â  Â  Â  Â  Â  document.getElementById('btnCalcular').addEventListener('click', calcular);
Â  Â  Â  Â  Â  Â  document.getElementById('btnLimpiarFormulario').addEventListener('click', limpiarFormulario);
Â  Â  Â  Â  Â  Â  document.getElementById('btnLimpiarVIN').addEventListener('click', limpiarVIN);
Â  Â  Â  Â  Â  Â  document.getElementById('btnVerDetalle').addEventListener('click', mostrarDetalle);
button
Â  Â  Â  Â  Â  Â  document.getElementById('btnGuardarHistorial').addEventListener('click', guardarHistorial);
Â  Â  Â  Â  Â  Â  document.getElementById('btnDescargar').addEventListener('click', descargarPDF);
Â  Â  Â  Â  Â  Â  document.getElementById('btnWhatsApp').addEventListener('click', enviarWhatsApp);
Â  Â  Â  Â  Â  Â  document.getElementById('btnHistorial').addEventListener('click', toggleHistorial);
Â  Â  Â  Â  Â  Â  document.getElementById('btnLimpiarHistorial').addEventListener('click', limpiarHistorial);
Â  Â  Â  Â  Â  Â  document.getElementById('btnComparar').addEventListener('click', toggleComparacion);
Â  Â  Â  Â  Â  Â  document.getElementById('btnActualizarTC').addEventListener('click', fetchTipoDeCambio);
Â  Â  Â  Â  Â  Â  document.getElementById('btnMillasAKm').addEventListener('click', convertirMillaje);
Â  Â  Â  Â  Â  Â  document.getElementById('btnKmsAMillas').addEventListener('click', convertirMillaje);
Â  Â  Â  Â  Â  Â  document.getElementById('btnCalcularTraspaso').addEventListener('click', calcularTraspaso);

Â  Â  Â  Â  Â  Â  // --- LISTENERS SCANNER ---
Â  Â  Â  Â  Â  Â  document.getElementById('btnScanVIN').addEventListener('click', iniciarScanner);
Â  Â  Â  Â  Â  Â  document.getElementById('btnStopScan').addEventListener('click', detenerScanner);

Â  Â  Â  Â  Â  Â  document.getElementById('ano').max = anoActual + 1;
Â  Â  Â  Â  Â  Â  actualizarHistorialUI();
Â  Â  Â  Â  Â  Â  fetchTipoDeCambio();
Â  Â  Â  Â  });

Â  Â  Â  Â  // --- FUNCIONES DE FORMATO ---
Â  Â  Â  Â  function formatUSD(num) { return '$' + Math.round(num).toLocaleString('en-US'); }
Â  Â  Â  Â  function formatCRC(num) { return 'â‚¡' + Math.round(num).toLocaleString('es-CR'); }

Â  Â  Â  Â  // --- LÃ“GICA DE CÃLCULO Y VALIDACIÃ“N ---
Â  Â  Â  Â  function validarAno() {
Â  Â  Â  Â  Â  Â  const anoInput = document.getElementById('ano');
Â  Â  Â  Â  Â  Â  const ayudaAno = document.getElementById('ayudaAno');
Â  Â  Â  Â  Â  Â  const ano = parseInt(anoInput.value);
Â  Â  Â  Â  Â  Â  if (!ano || ano < 1980 || ano > anoActual + 1) {
Â  Â  Â  Â  Â  Â  Â  Â  anoInput.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  ayudaAno.textContent = 'AÃ±o invÃ¡lido';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  const antiguedad = anoActual - ano;
Â  Â  Â  Â  Â  Â  Â  Â  const porcentaje = antiguedad <= 6 ? '48.37%' : '68.37%';
Â  Â  Â  Â  Â  Â  Â  Â  ayudaAno.textContent = `${antiguedad} aÃ±os | Impuesto: ${porcentaje}`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function calcular() {
Â  Â  Â  Â  Â  Â  const ano = parseInt(document.getElementById('ano').value);
section-header
Â  Â  Â  Â  Â  Â  const valor = parseFloat(document.getElementById('valor').value) || 0;
Â  Â  Â  Â  Â  Â  const flete = parseFloat(document.getElementById('flete').value) || 0;
Â  Â  Â  Â  Â  Â  const tc = parseFloat(document.getElementById('tipoCambio').value) || 0;
Â  Â  Â  Â  Â  Â  if (!ano || !valor || !flete || !tc) { alert('Completa todos los campos'); return; }
Â  Â  Â  Â  Â  Â  const antiguedad = anoActual - ano;
Â  Â  Â  Â  Â  Â  const porcentajeImpuesto = antiguedad <= 6 ? 0.4837 : 0.6837;
Â  Â  Â  Â  Â  Â  const valorPlusFlete = valor + flete;
Â  Â  Â  Â  Â  Â  const totalSeguros = valorPlusFlete * (COSTOS_FIJOS.SEGURO_1 + COSTOS_FIJOS.SEGURO_2);
section-header
Â  Â  Â  Â  Â  Â  const baseImpuestos = valorPlusFlete + totalSeguros;
Â  Â  Â  Â  Â  Â  const impuestosUSD = baseImpuestos * porcentajeImpuesto;
Â  Â  Â  Â  Â  Â  const subtotalVehiculoCRC = valorPlusFlete * tc;
Â  Â  Â  Â  Â  Â  const impuestosCRC = impuestosUSD * tc;
Â  Â  Â  Â  Â  Â  const papeleoUSACRC = COSTOS_FIJOS.PAPELEO_USA * tc;
Â  Â  Â  Â  Â  Â  const gastosFijosCRC = COSTOS_FIJOS.DECLARACION_CR + COSTOS_FIJOS.DEKRA + COSTOS_FIJOS.ALMACENAMIENTO;
Â  Â  Â  Â  Â  Â  const totalColones = subtotalVehiculoCRC + impuestosCRC + papeleoUSACRC + gastosFijosCRC;
Â  Â  Â  Â  Â  Â  calculoActual = { ano, valor, flete, antiguedad, totalSeguros, baseImpuestos, impuestosUSD, papeleoUSA: COSTOS_FIJOS.PAPELEO_USA, declaracion: COSTOS_FIJOS.DECLARACION_CR, dekra: COSTOS_FIJOS.DEKRA, almacenamiento: COSTOS_FIJOS.ALMACENAMIENTO, tc, totalColones, fecha: new Date().toLocaleString('es-CR') };
Â  Â  Â  Â  Â  Â  document.getElementById('resultadoTotal').textContent = formatCRC(totalColones);
Â  Â  Â  Â  Â  Â  document.getElementById('resultado').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById('tcFooter').textContent = tc;
Â  Â  Â  Â  }

Â  Â  Â  Â  function mostrarDetalle() {
Â  Â  Â  Â  Â  Â  if (!calculoActual) return;
Â  Â  Â  Â  Â  Â  const d = calculoActual;
Â  Â  Â  Â  Â  Â  const gastosAdminColones = (d.papeleoUSA * d.tc) + d.declaracion + d.dekra + d.almacenamiento;
Â  Â  Â  Â  Â  Â  let html = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="section-header">VALORES EN DÃ“LARES</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row"><span class="detail-label">Valor vehÃ­culo</span><span class="detail-value">${formatUSD(d.valor)}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row"><span class="detail-label">Flete</span><span class="detail-value">${formatUSD(d.flete)}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row"><span class="detail-label">Seguros</span><span class="detail-value">${formatUSD(d.totalSeguros)}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row subtotal"><span class="detail-label">Base Impuestos (USD)</span><span class="detail-value">${formatUSD(d.baseImpuestos)}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="section-header">VALORES EN COLONES</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row"><span class="detail-label">Montos del VehÃ­culo</span><span class="detail-value">${formatCRC((d.valor + d.flete) * d.tc)}</span></div>
section-header
Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row"><span class="detail-label">Impuestos</span><span class="detail-value">${formatCRC(d.impuestosUSD * d.tc)}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row"><span class="detail-label">Gastos Administrativos</span><span class="detail-value">${formatCRC(gastosAdminColones)}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="total-row"><span>GRAN TOTAL</span><span>${formatCRC(d.totalColones)}</span></div>`;
Â  Â  Â  Â  Â  Â  document.getElementById('detalleContent').innerHTML = html;
Â  Â  Â  Â  Â  Â  document.getElementById('detalle').classList.remove('hidden');
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- FUNCIONES (HERRAMIENTAS) ---
Â  Â  Â  Â  function convertirMillaje(event) {
Â  Â  Â  Â  Â  Â  const valorInput = parseFloat(document.getElementById('millaje').value);
Â  Â  Â  Â  Â  Â  const ano = parseInt(document.getElementById('ano').value);
Â  Â  Â  Â  Â  Â  const resultadoCard = document.getElementById('millajeInfoCard');
Â  Â  Â  Â  Â  Â  const resultadoLabel = document.getElementById('millajeResultadoLabel');
Â  Â  Â  Â  Â  Â  const resultadoValor = document.getElementById('millajeResultadoValor');
Â  Â  Â  Â  Â  Â  const promedioLabel = document.getElementById('millajePromedioLabel');
Â  Â  Â  Â  Â  Â  const promedioValor = document.getElementById('millajePromedioValor');
Â  Â  Â  Â  Â  Â  const promedioStatus = document.getElementById('millajePromedioStatus');
Â  Â  Â  Â  Â  Â  function mostrarError(mensaje) {
Â  Â  Â  Â  Â  Â  Â  Â  resultadoCard.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  resultadoLabel.textContent = 'Error';
Â  Â  Â  Â  Â  Â  Â  Â  resultadoValor.textContent = '-';
Â  Â  Â  Â  Â  Â  Â  Â  promedioLabel.textContent = 'Error';
Â  Â  Â  Â  Â  Â  Â  Â  promedioValor.textContent = '-';
Â  Â  Â  Â  Â  Â  Â  Â  promedioStatus.textContent = mensaje;
Â  Â  Â  Â  Â  Â  Â  Â  promedioStatus.style.color = '#dc2626';
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  if (!valorInput || valorInput < 0) { mostrarError('Ingrese un valor de millaje vÃ¡lido'); return; }
Â  Â  Â  Â  Â  Â  if (!ano || ano < 1980 || ano > anoActual + 1) { mostrarError('Ingrese un aÃ±o de vehÃ­culo vÃ¡lido'); return; }
Â  Â  Â  Â  Â  Â  const antiguedad = Math.max(1, anoActual - ano);
Â  Â  Â  Â  Â  Â  let resultadoNum, promedio, esSobrePromedio, promedioPorAno;
Â  Â  Â  Â  Â  Â  if (event.target.id === 'btnMillasAKm') {
Â  Â  Â  Â  Â  Â  Â  Â  resultadoNum = valorInput * KM_POR_MILLA;
Â  Â  Â  Â  Â  Â  Â  Â  promedio = PROMEDIO_MILLAS_ANO * antiguedad;
Â  Â  Â  Â  Â  Â  Â  Â  esSobrePromedio = valorInput > promedio;
Â  Â  Â  Â  Â  Â  Â  Â  promedioPorAno = valorInput / antiguedad;
section-header
Â  Â  Â  Â  Â  Â  Â  Â  resultadoLabel.textContent = "Total KMs";
Â  Â  Â  Â  Â  Â  Â  Â  resultadoValor.textContent = Math.round(resultadoNum).toLocaleString('es-CR');
Â  Â  Â  Â  Â  Â  Â  Â  promedioLabel.textContent = "Promedio (Millas/AÃ±o)";
Â  Â  Â  Â  Â  Â  Â  Â  promedioValor.textContent = Math.round(promedioPorAno).toLocaleString('en-US');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  resultadoNum = valorInput * MILLAS_POR_KM;
Â  Â  Â  Â  Â  Â  Â  Â  promedio = PROMEDIO_KMS_ANO * antiguedad;
Â  Â  Â  Â  Â  Â  Â  Â  esSobrePromedio = valorInput > promedio;
Â  Â  Â  Â  Â  Â  Â  Â  promedioPorAno = valorInput / antiguedad;
s
Â  Â  Â  Â  Â  Â  Â  Â  resultadoLabel.textContent = "Total Millas";
Â  Â  Â  Â  Â  Â  Â  Â  resultadoValor.textContent = Math.round(resultadoNum).toLocaleString('en-US');
Â  Â  Â  Â  Â  Â  Â  Â  promedioLabel.textContent = "Promedio (KMs/AÃ±o)";
Â  Â  Â  Â  Â  Â  Â  Â  promedioValor.textContent = Math.round(promedioPorAno).toLocaleString('es-CR');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  promedioStatus.textContent = esSobrePromedio ? 'Sobre el promedio' : 'Debajo del promedio';
Â  Â  Â  Â  Â  Â  promedioStatus.style.color = esSobrePromedio ? '#dc2626' : '#15803d';
Â  Â  Â  Â  Â  Â  resultadoCard.classList.remove('hidden');
Â  Â  Â  Â  }

Â  Â  Â  Â  function calcularTraspaso() {
Â  Â  Â  Â  Â  Â  const valorFiscal = parseFloat(document.getElementById('valorFiscal').value);
Â  Â  Â  Â  Â  Â  const resultadoEl = document.getElementById('resultadoTraspaso');
Â  Â  Â  Â  Â  Â  if (!valorFiscal || valorFiscal <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  resultadoEl.textContent = 'Ingrese un valor fiscal vÃ¡lido';
section-header
Â  Â  Â  Â  Â  Â  Â  Â  resultadoEl.style.color = '#dc2626';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const timbres = valorFiscal * PORCENTAJE_TIMBRES;
Â  Â  Â  Â  Â  Â  const total = timbres + HONORARIOS_TRASPASO;
Â  Â  Â  Â  Â  Â  resultadoEl.style.color = '#1f2937';
Â  Â  Â  Â  Â  Â  resultadoEl.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row"><span class="detail-label">Timbres (3.5%)</span><span class="detail-value">${formatCRC(timbres)}</span></div>
Methods
Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row" style="border:none;"><span class="detail-label">Honorarios</span><span class="detail-value">${formatCRC(HONORARIOS_TRASPASO)}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="total-row" style="margin-top: 8px;"><span>TOTAL APROX.</span><span>${formatCRC(total)}</span></div>`;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- LÃ“GICA DE HISTORIAL Y COMPARACIÃ“N ---
Â  Â  Â  Â  function guardarHistorial() { if (!calculoActual) return; historial.unshift({id: Date.now(), ...calculoActual }); localStorage.setItem('impuestosHistorial', JSON.stringify(historial)); alert('Guardado'); actualizarHistorialUI(); }
Â  Â  Â  Â  function actualizarHistorialUI() { const card = document.getElementById('historialCard'); const content = document.getElementById('historialContent'); if (historial.length === 0) { card.classList.add('hidden'); return; } card.classList.remove('hidden'); let html = ''; historial.forEach(item => { const isSelected = vehiculosSeleccionados.has(item.id); const cardClass = isSelected ? 'comparison-card selected' : 'comparison-card'; html += `<div class="${cardClass}" data-id="${item.id}"><div>${item.ano} | ${formatUSD(item.valor)} + ${formatUSD(item.flete)}</div><div style="font-size: 12px; color: #6b7280; margin-top: 4px;">${item.fecha}</div><div style="font-weight: bold; color: #2563eb; margin-top: 4px;">${formatCRC(item.totalColones)}</div>${isSelected ? '<div style="font-size: 11px; color: #2563eb; margin-top: 4px;">Seleccionado</div>' : ''}</div>`; }); content.innerHTML = html; content.querySelectorAll('.comparison-card').forEach(card => { card.addEventListener('click', () => seleccionarComparacion(Number(card.dataset.id))); }); }
s
Â  Â  Â  Â  function seleccionarComparacion(id) { if (!modoComparacion) return; if (vehiculosSeleccionados.has(id)) { vehiculosSeleccionados.delete(id); } else if (vehiculosSeleccionados.size < 2) { vehiculosSeleccionados.add(id); } actualizarHistorialUI(); mostrarComparacion(); }
Â  Â  Â  Â  function mostrarComparacion() { const comp = document.getElementById('comparador'); if (vehiculosSeleccionados.size < 2) { comp.classList.add('hidden'); return; } const sel = historial.filter(v => vehiculosSeleccionados.has(v.id)); let html = ''; sel.forEach((v, idx) => { html += `<div style="border: none; margin-bottom: 12px;"><div style="font-weight: bold; color: #1e40af; margin-bottom: 8px;">VehÃ­culo ${idx + 1}</div><div style="font-size: 12px; padding: 8px; background: #f3f4f6; border-radius: 6px;">AÃ±o: ${v.ano}<br>Valor: ${formatUSD(v.valor)}<br>Flete: ${formatUSD(v.flete)}<br><br><strong>${formatCRC(v.totalColones)}</strong></div></div>`; }); if (sel.length === 2) { const diff = Math.abs(sel[0].totalColones - sel[1].totalColones); html += `<div style="background: #eff6ff; padding: 12px; border-radius: 8px; text-align: center; font-weight: bold; color: #1e40af;">Diferencia: ${formatCRC(diff)}</div>`; } document.getElementById('comparacionContent').innerHTML = html; comp.classList.remove('hidden');}
Â  Â  Â  Â  function toggleComparacion() { modoComparacion = !modoComparacion; document.getElementById('btnComparar').classList.toggle('active', modoComparacion); vehiculosSeleccionados.clear(); if (!modoComparacion) document.getElementById('comparador').classList.add('hidden'); actualizarHistorialUI(); }
section-header
Â  Â  Â  Â  function toggleHistorial() { document.getElementById('historialCard').classList.toggle('hidden'); }
Â  Â  Â  Â  function limpiarHistorial() { if (confirm('Â¿EstÃ¡s seguro de que deseas borrar todo el historial?')) { historial = []; vehiculosSeleccionados.clear(); localStorage.removeItem('impuestosHistorial'); actualizarHistorialUI(); document.getElementById('comparador').classList.add('hidden'); } }

Â  Â  Â  Â  // --- LÃ“GICA DE API (VIN Y TIPO DE CAMBIO) ---
Â  Â  Â  Â  function handleVinInput() {
Â  Â  Â  Â  Â  Â  Â console.log("handleVinInput triggered!"); // Log para verificar ejecuciÃ³n
Â  Â  Â  Â  Â  Â  clearTimeout(vinDecodeTimeout);
Â  Â  Â  Â  Â  Â  const vin = this.value.toUpperCase().trim();
Â  Â  Â  Â  Â  Â  const vinStatus = document.getElementById('vinStatus');
Â  Â  Â  Â  Â  Â  limpiarFichaVIN();

Â  Â  Â  Â  Â  Â  if (vin.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  vinStatus.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (vin.length < 17) {
Â  Â  Â  Â  Â  Â  Â  Â  vinStatus.innerHTML = `<span>VIN debe tener 17 caracteres (${vin.length}/17)</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (vin.length === 17) {
s
Â  Â  Â  Â  Â  Â  Â  Â  console.log("VIN tiene 17 caracteres, iniciando decodificaciÃ³n..."); // Log
Â  Â  Â  Â  Â  Â  Â  Â  vinStatus.innerHTML = `<div class="spinner"></div><span>Decodificando VIN...</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  vinDecodeTimeout = setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("setTimeout ejecutando fetchVinData..."); // Log
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fetchVinData(vin);
Â  Â  Â  Â  Â  Â  Â  Â  }, 500); // 500ms de espera
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  async function fetchVinData(vin) {
Â  Â  Â  Â  Â  Â  Â console.log(`fetchVinData llamado con VIN: ${vin}`); // Log
Â  Â  Â  Â  Â  Â  const vinStatus = document.getElementById('vinStatus');
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const apiUrl = `https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVinValues/${vin}?format=json`;
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Consultando API: ${apiUrl}`); // Log
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(apiUrl);
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Respuesta recibida, status: ${response.status}`); // Log
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Respuesta de red no fue OK (${response.status})`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  console.log("Datos recibidos de la API:", data); // Log

Â  Â  Â  Â  Â  Â  Â  Â  if (data && data.Results && data.Results[0]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data.Results[0].ErrorCode === "0") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const vehicleInfo = data.Results[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  vinStatus.innerHTML = '<span style="color: #059669;">âœ“ VIN decodificado</span>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayVinData(vehicleInfo);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (vehicleInfo.ModelYear) {
s
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('ano').value = vehicleInfo.ModelYear;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('ano').dispatchEvent(new Event('change'));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  vinStatus.innerHTML = `<span style="color: #dc2626;">Error: ${data.Results[0].ErrorText || "VIN no encontrado"}</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  limpiarFichaVIN();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("Formato de respuesta inesperado de la API.");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error fetching VIN data:', error);
Â  Â  Â  Â  Â  Â  Â  Â  vinStatus.innerHTML = `<span style="color: #dc2626;">Error al decodificar: ${error.message}. Revisa conexiÃ³n.</span>`;
s
Â  Â  Â  Â  Â  Â  Â  Â  limpiarFichaVIN();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  async function fetchTipoDeCambio() {
Â  Â  Â  Â  Â  Â  Â const tcInput = document.getElementById('tipoCambio');
Â  Â  Â  Â  Â  Â  const tcHelp = document.getElementById('tipoCambioHelp');
Â  Â  Â  Â  Â  Â  tcHelp.innerHTML = `<div class="spinner"></div><span>Actualizando TC desde BCCR...</span>`;
Â  Â  Â  Â  Â  Â  const url = `https://api.hacienda.go.cr/indicadores/tc`;
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(url);
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error('Error de red al consultar la API de Hacienda');
Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  const valorVenta = data?.dolar?.venta?.valor;
Â  Â  Â  Â  Â  Â  Â  Â  if (valorVenta) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tcInput.value = parseFloat(valorVenta).toFixed(2);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const fecha = new Date(data.dolar.venta.fecha).toLocaleString('es-CR');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tcHelp.innerHTML = `<span style="color:#059669">âœ“ Actualizado (BCCR Ref.): ${fecha}</span>`;
s
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('La respuesta de la API no contiene el formato esperado.');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error fetching TC:", error);
Methods
Â  Â  Â  Â  Â  Â  Â  Â  tcHelp.innerHTML = `<span style="color:#dc2626">Error al actualizar TC. IngrÃ©selo manual.</span>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  function displayVinData(data) {
Â  Â  Â  Â  Â  Â  Â let engineInfo = data.EngineCylinders ? `${data.EngineCylinders} Cilindros` : '';
s
Â  Â  Â  Â  Â  Â  if (data.DisplacementL) engineInfo += ` ${data.DisplacementL}L`;
Â  Â  Â  Â  Â  Â  document.getElementById('vinMake').textContent = data.Make || 'No disponible';
Â  Â  Â  Â  Â  Â  document.getElementById('vinModel').textContent = data.Model || 'No disponible';
Â  Â  Â  Â  Â  Â  document.getElementById('vinTrim').textContent = data.Trim || 'No disponible';
Â  Â  Â  Â  Â  Â  document.getElementById('vinEngine').textContent = engineInfo.trim() || 'No disponible';
Â  Â  Â  Â  Â  Â  document.getElementById('vinCountry').textContent = data.PlantCountry || 'No disponible';
Â  Â  Â  Â  Â  Â  document.getElementById('vinInfoCard').classList.remove('hidden');
s
Â  Â  Â  Â  Â }

Â  Â  Â  Â  // --- FUNCIONES DE EXPORTACIÃ“N Y AYUDA ---
Â  Â  Â  Â  function generarTextoDesglose(esParaWhatsapp = false) {
Â  Â  Â  Â  Â  Â  if (!calculoActual) return "";
Â  Â  Â  Â  Â  Â  const d = calculoActual;
Â  Â  Â  Â  Â  Â  const gastosAdminColones = (d.papeleoUSA * d.tc) + d.declaracion + d.dekra + d.almacenamiento;
Â  Â  Â  Â  Â  Â  const b = esParaWhatsapp ? '*' : '';
Â  Â  Â  Â  Â  Â  const line = '---------------------------------';
Â  Â  Â  Â  Â  Â  const doubleLine = '=====================';
Â  Â  Â  Â  Â  Â  const texto = `
${b}CÃLCULO DE IMPUESTOS CR${b}
${doubleLine}

${b}VALORES EN DÃ“LARES${b}
${line}
Valor vehÃ­culo: ${formatUSD(d.valor)}
Flete: ${formatUSD(d.flete)}
Seguros: ${formatUSD(d.totalSeguros)}
${b}Base Impuestos (USD): ${formatUSD(d.baseImpuestos)}${b}

${b}VALORES EN COLONES${b}
${line}
Montos del VehÃ­culo: ${formatCRC((d.valor + d.flete) * d.tc)}
Impuestos: ${formatCRC(d.impuestosUSD * d.tc)}
Gastos Administrativos: ${formatCRC(gastosAdminColones)}
${doubleLine}
${b}GRAN TOTAL: ${formatCRC(d.totalColones)}${b}
${doubleLine}

TC: ${d.tc} | Fecha: ${d.fecha}
Â  Â  Â  Â  Â  Â  `.trim().split('\n').map(line => line.trim()).join('\n');
Â  Â  Â  Â  Â  Â  return texto;
Â  Â  Â  Â  }
Â  Â  Â  Â  function descargarPDF() {
Â  Â  Â  Â  Â  Â  if (!calculoActual) { alert('Primero calcula un vehÃ­culo'); return; }
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const { jsPDF } = window.jspdf;
Â  Â  Â  Â  Â  Â  Â  Â  const doc = new jsPDF();
Â  Â  Â  Â  Â  Â  Â  Â  const contenido = generarTextoDesglose();
Â  Â  Â  Â  Â  Â  Â  Â  doc.setFont("Helvetica", "normal");
section-header
Â  Â  Â  Â  Â  Â  Â  Â  doc.setFontSize(10);
Â  Â  Â  Â  Â  Â  Â  Â  doc.text(contenido, 10, 15);
Â  Â  Â  Â  Â  Â  Â  Â  doc.save(`Nacionalizacion-${calculoActual.ano}.pdf`);
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al generar PDF:", e);
section-header
Â  Â  Â  Â  Â  Â  Â  Â  alert("No se pudo generar el PDF. AsegÃºrate de tener conexiÃ³n a internet.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  function enviarWhatsApp() {
Â  Â  Â  Â  Â  Â  if (!calculoActual) { alert('Primero calcula un vehÃ­culo'); return; }
section-header
Â  Â  Â  Â  Â  Â  const mensaje = generarTextoDesglose(true);
Â  Â  Â  Â  Â  Â  const whatsappURL = 'https://wa.me/?text=' + encodeURIComponent(mensaje);
Â  Â  Â  Â  Â  Â  window.open(whatsappURL, '_blank');
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- FUNCIONES DE LIMPIEZA ---
Â  Â  Â  Â  function limpiarFichaVIN() { document.getElementById('vinInfoCard').classList.add('hidden'); }
s
Â  Â  Â  Â  function limpiarFormulario() {
Â  Â  Â  Â  Â  Â  document.getElementById('ano').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('valor').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('flete').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('resultado').classList.add('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById('detalle').classList.add('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById('ayudaAno').textContent = '';
Â  Â  Â  Â  Â  Â  document.getElementById('millajeInfoCard').classList.add('hidden');
s
Â  Â  Â  Â  Â  Â  document.getElementById('resultadoTraspaso').innerHTML = '';
Â  Â  Â  Â  Â  Â  document.getElementById('millaje').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('valorFiscal').value = '';
Â  Â  Â  Â  Â  Â  limpiarVIN();
Â  Â  Â  Â  }
Â  Â  Â  Â  function limpiarVIN() {
Â  Â  Â  Â  Â  Â  document.getElementById('vin').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('vinStatus').innerHTML = '';
s
Â  Â  Â  Â  Â  Â  limpiarFichaVIN();
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- *** INICIO: CÃ“DIGO DEL SCANNER (VERSIÃ“N CORREGIDA Y ROBUSTA) *** ---

Â  Â  Â  Â  async function iniciarScanner() {
Â  Â  Â  Â  Â  Â  const videoElement = document.getElementById('videoElement');
Â  Â  Â  Â  Â  Â  const scannerContainer = document.getElementById('scanner-container');

Â  Â  Â  Â  Â  Â  // 1. Asegurarse de detener cualquier instancia anterior
Â  Â  Â  Â  Â  Â  detenerScanner(); 

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // --- Bloquear OrientaciÃ³n (esto estÃ¡ bien) ---
Â  Â  Â  Â  Â  Â  Â  Â  if (typeof screen.orientation.lock === 'function') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await screen.orientation.lock('landscape');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("OrientaciÃ³n bloqueada a horizontal.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn("No se pudo bloquear la orientaciÃ³n:", e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // 2. Validar que la librerÃ­a estÃ© cargada (esto estÃ¡ bien)
Â  Â  Â  Â  Â  Â  Â  Â  if (typeof ZXingBrowser === 'undefined' || ZXingBrowser === null) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('La librerÃ­a de escaneo (ZXingBrowser) no se ha cargado.');
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // 3. Configurar las pistas (esto estÃ¡ bien)
Â  Â  Â  Â  Â  Â  Â  Â  const hints = new Map();
Â  Â  Â  Â  Â  Â  Â  Â  const formats = [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ZXingBrowser.BarcodeFormat.CODE_39,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ZXingBrowser.BarcodeFormat.CODE_128,
Â  Â  Â  Â  Â  Â  Â  Â  ];
Â  Â  Â  Â  Â  Â  Â  Â  hints.set(1, formats); // 1 = POSSIBLE_FORMATS
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // 4. Inicializar el lector
Â  Â  Â  Â  Â  Â  Â  Â  codeReader = new ZXingBrowser.BrowserMultiFormatReader(hints);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // 5. Mostrar el contenedor del scanner
Â  Â  Â  Â  Â  Â  Â  Â  scannerContainer.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  console.log("Scanner iniciado, solicitando permiso de cÃ¡mara...");

Â  Â  Â  Â  Â  Â  Â  Â  // 6. Obtener el stream
Â  Â  Â  Â  Â  Â  Â  Â  const constraints = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  video: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  facingMode: 'environment',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // --- *** CORRECCIÃ“N DE TYPO ESTABA AQUÃ *** ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aspectRatio: { ideal: 1.7777777778 } // 16:9 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  const stream = await navigator.mediaDevices.getUserMedia(constraints);

Â  Â  Â  Â  Â  Â  Â  Â  // 7. Asignar el stream al video
Â  Â  Â  Â  Â  Â  Â  Â  videoElement.srcObject = stream;
Â  Â  Â  Â  Â  Â  Â  Â  // --- *** CORRECCIÃ“N DE TYPO ESTABA AQUÃ (se eliminÃ³ "AlemÃ¡n") *** ---
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // --- *** INICIO DE LA CORRECCIÃ“N CRÃTICA DE LÃ“GICA *** ---
Â  Â  Â  Â  Â  Â  Â  Â  // Creamos una Promise que se resolverÃ¡ SÃ“LO cuando el video estÃ© reproduciÃ©ndose
Â  Â  Â  Â  Â  Â  Â  Â  const decodePromise = new Promise((resolve, reject) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  videoElement.onloadedmetadata = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("Metadatos cargados, intentando reproducir...");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Intentamos reproducir el video
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  videoElement.play().then(() => {
s
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("Video reproduciendo. Llamando a decodeOnce...");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // AHORA que el video estÃ¡ reproduciendo, llamamos a decodeOnce
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  codeReader.decodeOnceFromVideoElement(videoElement)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // --- *** CORRECCIÃ“N DE TYPO ESTABA AQUÃ (se eliminÃ³ "AlemÃ¡n") *** ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .then(resolve) // Resuelve la Promise principal con el resultado
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .catch(reject); // Rechaza si decodeOnce falla
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).catch(reject); // Rechaza si play() falla
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Manejar error si el video no carga
description
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  videoElement.onerror = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reject(new Error("No se pudo cargar el stream de video."));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  // 8. Esperar el resultado de la decodificaciÃ³n
Â  Â  Â  Â  Â  Â  Â  Â  // Esta lÃ­nea ahora esperarÃ¡ a que el video se reproduzca Y a que decodeOnce termine
Â  Â  Â  Â  Â  Â  Â  Â  const result = await decodePromise;
Â  Â  Â  Â  Â  Â  Â  Â  // --- *** FIN DE LA CORRECCIÃ“N CRÃTICA DE LÃ“GICA *** ---

section-header
Â  Â  Â  Â  Â  Â  Â  Â  // 9. Procesar el resultado
Â  Â  Â  Â  Â  Â  Â  Â  if (result) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("CÃ³digo encontrado:", result.text);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('vin').value = result.text;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Disparamos el 'input' para que se ejecute la decodificaciÃ³n del VIN
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('vin').dispatchEvent(new Event('input')); 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // 10. Detener el scanner (siempre se ejecuta despuÃ©s de un Ã©xito)
s
Â  Â  Â  Â  Â  Â  Â  Â  detenerScanner();

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  // 11. Manejo de errores mejorado
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al iniciar el scanner: ", error);
Â  Â  Â  Â  Â  Â  Â  Â  let errorMsg = `Error al iniciar el scanner: ${error.message}`;

Â  Â  Â  Â  Â  Â  Â  Â  if (error.name === 'NotFoundException') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorMsg = 'Escaneo cancelado o no se encontrÃ³ cÃ³digo.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(errorMsg); // No es necesario alertar al usuario por esto
Â  Â  Â  Â  Â  Â  Â  Â  } else if (error.name === 'NotAllowedError') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorMsg = "Debes dar permiso a la cÃ¡mara para escanear.";
section-header
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(errorMsg);
Â  Â  Â  Â  Â  Â  Â  Â  } else if (error.name === 'NotFoundError' || error.name === 'OverconstrainedError') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorMsg = "No se pudo encontrar una cÃ¡mara trasera. Intenta en un dispositivo mÃ³vil.";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(errorMsg);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Otro tipo de error
s
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(errorMsg);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Asegurarnos de cerrar si hubo un error
Â  Â  Â  Â  Â  Â  Â  Â  detenerScanner();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function detenerScanner() {
section-header
Â  Â  Â  Â  Â  Â  if (codeReader) {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  codeReader.reset();
s
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("Scanner reseteado.");
Â  Â  Â  Â  Â  Â  Â  Â  } catch (resetError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al resetear el scanner:", resetError);
s
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const videoElement = document.getElementById('videoElement');
Â  Â  Â  Â  Â  Â  if (videoElement && videoElement.srcObject) {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tracks = videoElement.srcObject.getTracks();
s
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tracks.forEach(track => track.stop());
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("Tracks de video detenidos.");
Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al detener tracks:", e);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  videoElement.srcObject = null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  codeReader = null;
Methods
section-header

Â  Â  Â  Â  Â  Â  const scannerContainer = document.getElementById('scanner-container');
Â  Â  Â  Â  Â  Â  if (scannerContainer) {
Â  Â  Â  Â  Â  Â  Â  Â  scannerContainer.classList.add('hidden');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- *** INICIO CORRECCIÃ“N JS: Desbloquear OrientaciÃ³n *** ---
Â  Â  Â  Â  Â  Â  if (typeof screen.orientation.unlock === 'function') {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  t-size: 14px
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  screen.orientation.unlock();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("OrientaciÃ³n desbloqueada.");
Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn("No se pudo desbloquear la orientaciÃ³n:", e);
section-header
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // --- *** FIN CORRECCIÃ“N JS *** ---
Â  Â  Â  Â  }
Â  Â  Â  Â  // --- *** FIN: CÃ“DIGO DEL SCANNER *** ---

Â  Â  </script>
</body>
</html>
