<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nacionalización CR">

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="icon-192.png">

    <title>Cálculo de Impuestos con VIN</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@zxing/browser@latest/umd/zxing-browser.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-functions-compat.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(to bottom right, #e0f2fe, #e0e7ff); }
        .header { background: linear-gradient(135deg, #2563eb 0%, #4f46e5 100%); color: white; padding: 16px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .header-title { display: flex; align-items: center; gap: 8px; }
        .header-logo { width: 36px; height: 36px; }
        .header-title h1 {
            font-size: 18px;
            font-weight: bold;
            color: white; 
            text-shadow: 0 1px 3px rgba(0,0,0,0.25);
        }
        .header-title p {
            font-size: 12px;
            color: #86efac; 
            opacity: 1;
        }
        .header-buttons { display: flex; gap: 8px; }
        button { border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }

        .btn-icon { background: rgba(255,255,255,0.2); color: white; width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .btn-icon:active { background: rgba(255,255,255,0.3); }

        .btn-header { background: rgba(255,255,255,0.2); color: white; width: auto; padding: 8px 12px; font-size: 12px; }
        .btn-header.active { background: #fbbf24; color: #1f2937; }

        .btn-secondary { background: #e5e7eb; color: #374151; padding: 12px; }
        .btn-secondary:active, .btn-secondary:hover { background: #d1d5db; cursor: pointer; }
        
        .btn-secondary.active {
            background: #fbbf24;
            color: #1f2937;
        }

        .btn-primary { background: linear-gradient(135deg, #2563eb 0%, #4f46e5 100%); color: white; grid-column: 1 / -1; padding: 12px; }
        
        .btn-primary:disabled { 
            background: #d1d5db; 
            cursor: not-allowed; 
        }

        .btn-result { background: rgba(255,255,255,0.2); color: white; padding: 12px; font-size: 12px; font-weight: 600; }
        .btn-result:active { background: rgba(255,255,255,0.3); }

        .btn-danger-light { background: #fee2e2; color: #dc2626; padding: 4px 8px; font-size: 11px; border-radius: 4px; }
        .btn-info-light { background: #dbeafe; color: #1e40af; padding: 12px; border-radius: 8px; }
        .btn-success-light { background: #dcfce7; color: #15803d; padding: 12px; border-radius: 8px; }
        .btn-update-tc { background: #dbeafe; color: #2563eb; font-size: 11px; padding: 6px 10px; font-weight: bold; }
        .btn-update-tc:active { background: #bfdbfe; }

        .container { max-width: 500px; margin: 0 auto; padding: 16px; }
        .card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .card-title { font-size: 16px; font-weight: bold; margin-bottom: 12px; color: #1f2937; }

        .form-group { margin-bottom: 12px; }
        .form-group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        label { display: block; font-size: 12px; font-weight: 600; color: #374151; }
        input { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; font-family: inherit; }
        input:focus { outline: none; border-color: #2563eb; background: #f0f9ff; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        .help-text { font-size: 11px; color: #6b7280; margin-top: 4px; display: flex; align-items: center; gap: 6px;}
        .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }

        .info-card { background-color: #eff6ff; border: 2px solid #93c5fd; padding: 12px; margin-top: 16px; }
        .info-card-title { font-size: 14px; font-weight: bold; color: #1e40af; margin-bottom: 10px; }
        .info-card .detail-row { padding: 8px 0; font-size: 14px; }
        .info-card .detail-label { color: #374151; }
        .info-card .detail-value { color: #1f2937; }

        .spinner {
            width: 14px; height: 14px;
            border: 2px solid #93c5fd; border-top-color: #3b82f6;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .result-card { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; margin-bottom: 16px; padding: 16px; border-radius: 12px; }
        .result-amount { font-size: 32px; font-weight: bold; margin-bottom: 16px; }
        .result-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

        .detail-row { display: flex; justify-content: space-between; padding: 10px 0; font-size: 13px; border-bottom: 1px solid #e5e7eb; }
        .detail-row.subtotal { font-weight: bold; color: #1e40af; }
        .detail-label { color: #6b7280; }
        .detail-value { font-weight: 600; color: #1f2937; }
        .section-header { background: #dbeafe; color: #1e40af; padding: 8px 12px; border-radius: 6px; font-size: 11px; font-weight: bold; margin-top: 12px; margin-bottom: 8px; }
        .total-row { background: #f0fdf4; padding: 12px; border-radius: 6px; margin-top: 12px; font-weight: bold; display: flex; justify-content: space-between; font-size: 16px; }

        .comparison-card { background: white; border: 2px solid #93c5fd; border-radius: 8px; padding: 12px; margin-bottom: 12px; cursor: pointer; }
        .comparison-card:active { background: #eff6ff; border-color: #3b82f6; }
        .comparison-card.selected { border-color: #2563eb; background: #eff6ff; border-width: 3px; }
        
        .historial-vehicle-info { 
            font-size: 13px; 
            color: #4b5563; 
            margin-top: 4px; 
            font-weight: 500;
        }

        .hidden { display: none !important; }

        #scanner-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #videoElement {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: translate(-50%, -50%);
            z-index: 201;
        }
        #scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 202;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #scanner-viewfinder {
            width: 90%;
            max-width: 600px;
            height: 100px;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.7);
        }
        .scanner-red-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #dc2626;
            box-shadow: 0 0 8px #dc2626;
            top: 50%;
            transform: translateY(-50%);
        }
        .scanner-text {
            color: white;
            font-weight: 600;
            margin-top: 24px;
            font-size: 14px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        #btnStopScan {
            margin-top: 24px;
            padding: 12px 24px;
            font-size: 16px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.5);
            z-index: 203; 
        }
        #btnStopScan:active {
            background: rgba(255,255,255,0.3);
        }

        #toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            background: #2d3748; 
            color: white;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
        }

        #toast.show {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(0); 
        }
        
        #toast.success { background: #059669; }
        #toast.error   { background: #dc2626; }
        #toast.info    { background: #2563eb; }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f0f9ff; 
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            font-weight: bold;
            color: #1f2937;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            transition: background 0.2s ease-in-out;
        }

        .collapsible-header:hover { background: #e0f2fe; }
        .collapsible-header .arrow-icon {
            width: 18px;
            height: 18px;
            transition: transform 0.3s ease-in-out;
        }
        .collapsible-header.open .arrow-icon { transform: rotate(180deg); }
        .collapsible-content {
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        }
        .collapsible-content.open {
            max-height: 1000px;
            opacity: 1;
            margin-bottom: 12px; 
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-title">
            <img src="new-logo.png" alt="Logo" class="header-logo">
            <div>
                <h1>Calculadora</h1>
                <p>Importación de Vehículos</p>
            </div>
        </div>
        <div class="header-buttons" id="main-header-buttons" style="display: none;">
            <button class="btn-header" id="btnComparar">Compare</button>
            <button class="btn-header" id="btnHistorial">Historial</button>
        </div>
    </div>

    <div id="scanner-container" class="hidden">
        <video id="videoElement" playsinline></video>
        <div id="scanner-overlay">
            <div id="scanner-viewfinder">
                <div class="scanner-red-line"></div>
            </div>
            <div class="scanner-text">Centre el código de barras en la línea roja</div>
            <button id="btnStopScan">Cancelar</button>
        </div>
    </div>
    
    <div class="container">
        
        <div id="auth-section" class="card" style="display: none;">
            <div id="login-form" autocomplete="off">
                <div class="card-title">Iniciar Sesión</div>
                <div class="form-group"><label for="loginEmail">Correo Electrónico</label><input type="email" id="loginEmail" placeholder="usuario@ejemplo.com" autocomplete="off"></div>
                <div class="form-group"><label for="loginPassword">Contraseña</label><input type="password" id="loginPassword" autocomplete="new-password"></div>

                <div class="form-group" style="display: flex; align-items: center; justify-content: space-between; margin-top: 10px; margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="rememberMe" style="width: auto; height: auto; margin-right: 5px;">
                        <label for="rememberMe" style="margin-bottom: 0; font-size: 14px; color: #374151;">Recordar usuario</label>
                    </div>
                </div>
                <button id="btnLogin" class="btn-primary" style="width: 100%;">Ingresar</button>
                
                <button type="button" id="btnForgotPassword" style="background:none; border:none; color:#2563eb; font-size: 12px; cursor:pointer; margin-top: 10px; padding: 4px; width: 100%; text-align: center;">
                    ¿Olvidaste tu contraseña?
                </button>
                
                <p id="loginError" style="color: red; font-size: 12px; margin-top: 8px; text-align: center; min-height: 16px;"></p>
            </div>
        </div>

        <div id="app-content" style="display: none;">

            <div id="userInfoDisplay" class="card" style="display: none; background-color: #f3f4f6; border: 1px solid #d1d5db; margin-bottom: 16px; padding: 12px;">
                 <div style="font-size: 14px; color: #374151;">Usuario: <strong id="userInfoEmail" style="color: #1f2937;"></strong></div>
                 <div style="font-size: 14px; color: #374151; margin-top: 4px;">Vigencia: <strong id="userInfoExpiry" style="color: #15803d;"></strong></div>
            </div>
            
            <div id="comparador" class="card hidden">
                <div class="card-title">Comparar Vehículos</div>
                <div id="comparacionContent"></div>
            </div>

            <div id="historialCard" class="card hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div class="card-title" style="margin: 0;">Historial</div>
                    <button id="btnLimpiarHistorial" class="btn-danger-light">Limpiar</button>
                </div>
                <div id="historialContent"></div>
            </div>

            <div class="card">
                <div class="card-title">Ingrese datos del Vehículo</div>

                <div class="form-group">
                    <label for="vin">VIN Number</label>
                    <input type="text" id="vin" placeholder="Ej: 5FNRL6H73LB123456" maxlength="17" autocapitalize="characters">
                    <div class="help-text" id="vinStatus"></div>

                    <div class="button-group" style="margin-top: 8px;">
                        <button id="btnScanVIN" class="btn-secondary">║▌║ Escanear VIN</button>
                        <button id="btnLimpiarVIN" class="btn-danger-light" style="padding: 12px;">Limpiar VIN</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="ano">Año del Vehículo</label>
                    <input type="number" id="ano" placeholder="2022" min="1980" inputmode="numeric">
                    <div class="help-text" id="ayudaAno"></div>
                </div>

                <div id="vinInfoCard" class="card info-card hidden">
                    <div class="card-title info-card-title">Información del Vehículo</div>
                    <div class="detail-row"><span class="detail-label">Marca</span><span class="detail-value" id="vinMake"></span></div>
                    <div class="detail-row"><span class="detail-label">Modelo</span><span class="detail-value" id="vinModel"></span></div>
                    <div class="detail-row"><span class="detail-label">Versión</span><span class="detail-value" id="vinTrim"></span></div>
                    <div class="detail-row"><span class="detail-label">Motor</span><span class="detail-value" id="vinEngine"></span></div>
                    <div class="detail-row" style="border-bottom: none;"><span class="detail-label">País</span><span class="detail-value" id="vinCountry"></span></div>
                </div>

                <hr style="border:none; border-top: 1px solid #e5e7eb; margin: 20px 0;">

                <div class="collapsible-header" data-target="collapsible-millaje">
                    <span>Convertidor de Distancia</span>
                    <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor">
                        <path d="M207 416c11.3 0 22.1-4.3 30.2-12.3L400.2 248.2c12.1-12.1 12.1-31.7 0-43.8s-31.7-12.1-43.8 0L224 334.3 91.8 204.2c-12.1-12.1-31.7-12.1-43.8 0s-12.1 31.7 0 43.8L176.8 403.7c8.1 8 18.9 12.3 30.2 12.3z"/>
                    </svg>
                </div>
                <div id="collapsible-millaje" class="collapsible-content">
                    <div class="form-group">
                        <label for="millaje">Millaje / Kilometraje</label>
                        <input type="number" id="millaje" placeholder="30000" inputmode="numeric">
                        <div class="help-text">El color indica si está sobre (rojo) o bajo (verde) el promedio para el año del vehículo.</div>
                    </div>
                    <div class="button-group">
                        <button class="btn-secondary" id="btnMillasAKm">Millas a Kms</button>
                        <button class="btn-secondary" id="btnKmsAMillas">Kms a Millas</button>
                    </div>

                    <div id="millajeInfoCard" class="card info-card hidden" style="margin-top: 16px;">
                        <div class="card-title info-card-title">Resultado de Conversión</div>
                        <div class="detail-row">
                            <span class="detail-label" id="millajeResultadoLabel"></span>
                            <span class="detail-value" id="millajeResultadoValor"></span>
                        </div>
                        <div class="detail-row" style="border-bottom: none;">
                            <span class="detail-label" id="millajePromedioLabel"></span>
                            <span class="detail-value" id="millajePromedioValor"></span>
                        </div>
                        <div id="millajePromedioStatus" style="font-size: 12px; font-weight: bold; text-align: center; margin-top: 10px;"></div>
                    </div>
                    <hr style="border:none; border-top: 1px solid #e5e7eb; margin: 20px 0;">
                </div>
                
                <div class="collapsible-header" data-target="collapsible-traspaso">
                    <span>Cálculo de Traspaso</span>
                    <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor">
                        <path d="M207 416c11.3 0 22.1-4.3 30.2-12.3L400.2 248.2c12.1-12.1 12.1-31.7 0-43.8s-31.7-12.1-43.8 0L224 334.3 91.8 204.2c-12.1-12.1-31.7-12.1-43.8 0s-12.1 31.7 0 43.8L176.8 403.7c8.1 8 18.9 12.3 30.2 12.3z"/>
                    </svg>
                </div>
                <div id="collapsible-traspaso" class="collapsible-content">
                    <div class="form-group">
                        <label for="valorFiscal">Valor Fiscal (₡)</label>
                        <input type="number" id="valorFiscal" placeholder="10000000" inputmode="numeric">
                    </div>
                    <hr style="border:none; border-top: 1px dashed #cbd5e1; margin: 16px 0;">
                    <div class="form-group">
                        <label for="consultaPlacaInput">Consultar Valor Fiscal por Placa (RNP)</label>
                        <input type="text" id="consultaPlacaInput" placeholder="Ej: ABC123" maxlength="10" autocapitalize="characters" style="margin-bottom: 8px;">
                        <button id="btnConsultarPlaca" class="btn-secondary" style="width: 100%;">Consultar Placa</button>
                        <pre id="resultadoConsultaPlaca" style="margin-top: 10px; font-size: 11px; color: #4b5563; background: #f3f4f6; padding: 8px; border-radius: 4px; min-height: 40px; white-space: pre-wrap; word-wrap: break-word;"></pre>
                    </div>
                    <hr style="border:none; border-top: 1px dashed #cbd5e1; margin: 16px 0;">
                    <button class="btn-primary" id="btnCalcularTraspaso" style="width: 100%;">Calcular Traspaso</button>
                    <div id="resultadoTraspaso" style="margin-top: 12px;"></div>
                    <hr style="border:none; border-top: 1px solid #e5e7eb; margin: 20px 0;">
                </div>

                <div class="form-group">
                    <label for="valor">Valor (USD)</label>
                    <input type="number" id="valor" placeholder="25000" inputmode="numeric">
                </div>

                <div class="form-group">
                    <label for="flete">Flete (USD)</label>
                    <input type="number" id="flete" placeholder="1500" inputmode="numeric">
                </div>

                <div class="form-group">
                    <div class="form-group-header">
                        <label for="tipoCambio">Tipo de Cambio (₡/USD)</label>
                        <button id="btnActualizarTC" class="btn-update-tc">Actualizar TC</button>
                    </div>
                    <input type="number" id="tipoCambio" placeholder="520" inputmode="numeric">
                    <div class="help-text" id="tipoCambioHelp"></div>
                </div>

                <div class="button-group">
                    <button class="btn-secondary" id="btnLimpiarFormulario">Limpiar</button>
                    <button class="btn-primary" id="btnCalcular">Calcular</button>
                </div>
            </div>

            <div id="resultado" class="hidden">
                <div class="result-card">
                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;">COSTO TOTAL</div>
                    <div class="result-amount" id="resultadoTotal"></div>
                    <div class="result-buttons">
                        <button class="btn-result" id="btnVerDetalle">Ver Detalle</button>
                        <button class="btn-result" id="btnGuardarHistorial">Guardar</button>
                    </div>
                </div>

                <div id="detalle" class="card hidden">
                    <div class="card-title">Desglose</div>
                    <div id="detalleContent"></div>
                    <div class="button-group" style="margin-top: 16px;">
                        <button id="btnDescargar" class="btn-info-light">Exportar (PDF)</button>
                        <button id="btnWhatsApp" class="btn-success-light">WhatsApp</button>
                    </div>
                </div>
            </div>

            <div id="create-account-form-wrapper" class="card" style="display: none;">
                <div id="create-account-form">
                    <div class="card-title">Crear Nueva Cuenta (Admin)</div>
                    <div class="form-group"><label for="createEmail">Correo Electrónico Cliente</label><input type="email" id="createEmail" placeholder="cliente@ejemplo.com"></div>
                    <div class="form-group"><label for="createPassword">Contraseña Temporal</label><input type="password" id="createPassword"></div>
                    <button id="btnCreateAccount" class="btn-secondary" style="width: 100%;">Crear Cuenta</button>
                    <p id="createError" style="color: red; font-size: 12px; margin-top: 8px; text-align: center;"></p>
                </div>
            </div> 
            
            <div id="admin-dashboard-card" class="card" style="display: none;">
                <div class="card-title">Dashboard de Administrador</div>
                
                <div class="form-group">
                    <label for="adminSearch">Buscar usuario por email</label>
                    <input type="text" id="adminSearch" placeholder="cliente@ejemplo.com">
                </div>
                
                <div id="admin-user-list-loading" style="text-align: center; padding: 20px; color: #6b7280;">
                    <div class="spinner" style="margin: 0 auto;"></div>
                    Cargando usuarios...
                </div>
                
                <div id="admin-user-list" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
            
            <button id="btnLogout" class="btn-danger-light" style="width: 100%; padding: 12px; margin-top: 20px; font-size: 14px;">Cerrar Sesión</button>
        
        </div> 
        
        <div style="text-align: center; font-size: 11px; color: #6b7280; margin-top: 20px; margin-bottom: 20px;">
            <p>TC Venta BCCR: <span id="tcFooter">N/A</span></p>
        </div>

    </div> 
    
    <div id="toast" class="toast"></div>
    
    <!-- IMPORTANTE: Carga el archivo de configuración de Firebase ANTES del script principal -->
    <!-- <script src="firebase-config.js"></script> -->
    
    <script>
    // ==== CONFIGURACIÓN DE FIREBASE ====
const firebaseConfig = {
  apiKey: "AIzaSyBF4CP3vGJ-aJveo93QKR4kbYjDkxQYrVY",
  authDomain: "calculos-cr.firebaseapp.com",
  projectId: "calculos-cr",
  storageBucket: "calculos-cr.firebasestorage.app",
  messagingSenderId: "502237422177",
  appId: "1:502237422177:web:6974139fc782d52a1e8020"
};
// ==== INICIALIZACIÓN DE FIREBASE ====
let auth;
let db;
let functions;
let consultarFn;

try {
    // Verificar que Firebase SDK esté cargado
    if (typeof firebase === 'undefined') {
        throw new Error('Firebase SDK no se cargó correctamente. Verifica tu conexión a internet.');
    }

    // Inicializar Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
        console.log('✅ Firebase App inicializado');
    } else {
        console.log('✅ Firebase App ya estaba inicializado');
    }

    // Inicializar servicios
    auth = firebase.auth();
    console.log('✅ Firebase Auth inicializado:', typeof auth);

    db = firebase.firestore();
    console.log('✅ Firebase Firestore inicializado:', typeof db);

    functions = firebase.functions();
    console.log('✅ Firebase Functions inicializado:', typeof functions);
    
    if (typeof functions !== 'undefined' && functions.httpsCallable) {
        consultarFn = functions.httpsCallable('consultaPlacaRNP');
        console.log('✅ Cloud Function consultaPlacaRNP configurada');
    } else {
        console.warn('⚠️ Firebase Functions no disponible o sin método httpsCallable');
    }
    
    console.log('✅✅✅ Firebase inicializado COMPLETAMENTE');

} catch (e) {
    console.error('❌❌❌ Error CRÍTICO al inicializar Firebase:', e);
    console.error('Detalles del error:', {
        message: e.message,
        stack: e.stack,
        firebaseDisponible: typeof firebase !== 'undefined',
        firebaseConfigValido: typeof firebaseConfig !== 'undefined'
    });
    
    // Mostrar error al usuario
    document.addEventListener('DOMContentLoaded', () => {
        const loginError = document.getElementById('loginError');
        if (loginError) {
            loginError.textContent = 'Error crítico: No se pudo conectar con Firebase. Verifica tu conexión.';
            loginError.style.display = 'block';
        }
    });
}

    // ==== VARIABLES GLOBALES ====
    let historial = JSON.parse(localStorage.getItem('impuestosHistorial')) || [];
    let modoComparacion = false;
    let vehiculosSeleccionados = new Set();
    let calculoActual = null;
    let vinDecodeTimeout;
    let codeReader = null; 
    let toastTimeout; 
    let currentVinInfo = { make: '', model: '', year: '' }; 
    let adminUserCache = [];

    const anoActual = new Date().getFullYear();

    const COSTOS_FIJOS = {
        SEGURO_1: 0.011, SEGURO_2: 0.007, PAPELEO_USA: 250,
        DECLARACION_CR: 106000, DEKRA: 45000, ALMACENAMIENTO: 65000
    };

    const MILLAS_POR_KM = 0.621371;
    const KM_POR_MILLA = 1.60934;
    const PROMEDIO_MILLAS_ANO = 15000;
    const PROMEDIO_KMS_ANO = 17000;
    const PORCENTAJE_TIMBRES = 0.035;
    const HONORARIOS_TRASPASO = 65000;

    // ==== EVENT LISTENERS ====
    document.addEventListener('DOMContentLoaded', () => {
        const anoInput = document.getElementById('ano');
        if (anoInput) {
            anoInput.addEventListener('change', validarAno);
            anoInput.addEventListener('input', validarInicioAno);
            anoInput.max = anoActual + 1;
        }

        const vinInput = document.getElementById('vin');
        if (vinInput) vinInput.addEventListener('input', handleVinInput);
        
        const btnCalcular = document.getElementById('btnCalcular');
        if (btnCalcular) btnCalcular.addEventListener('click', calcular);
        
        const btnLimpiarFormulario = document.getElementById('btnLimpiarFormulario');
        if (btnLimpiarFormulario) btnLimpiarFormulario.addEventListener('click', limpiarFormulario);

        const btnLimpiarVIN = document.getElementById('btnLimpiarVIN');
        if (btnLimpiarVIN) btnLimpiarVIN.addEventListener('click', limpiarVIN);
        
        const btnVerDetalle = document.getElementById('btnVerDetalle');
        if (btnVerDetalle) btnVerDetalle.addEventListener('click', mostrarDetalle);
        
        const btnGuardarHistorial = document.getElementById('btnGuardarHistorial');
        if (btnGuardarHistorial) btnGuardarHistorial.addEventListener('click', guardarHistorial);
        
        const btnDescargar = document.getElementById('btnDescargar');
        if (btnDescargar) btnDescargar.addEventListener('click', descargarPDF);
        
        const btnWhatsApp = document.getElementById('btnWhatsApp');
        if (btnWhatsApp) btnWhatsApp.addEventListener('click', enviarWhatsApp);
        
        const btnHistorial = document.getElementById('btnHistorial');
        if (btnHistorial) btnHistorial.addEventListener('click', toggleHistorial);
        
        const btnLimpiarHistorial = document.getElementById('btnLimpiarHistorial');
        if (btnLimpiarHistorial) btnLimpiarHistorial.addEventListener('click', limpiarHistorial);
        
        const btnComparar = document.getElementById('btnComparar');
        if (btnComparar) btnComparar.addEventListener('click', toggleComparacion);
        
        const btnActualizarTC = document.getElementById('btnActualizarTC');
        if (btnActualizarTC) btnActualizarTC.addEventListener('click', fetchTipoDeCambio);
        
        const btnMillasAKm = document.getElementById('btnMillasAKm');
        if (btnMillasAKm) btnMillasAKm.addEventListener('click', convertirMillaje);
        
        const btnKmsAMillas = document.getElementById('btnKmsAMillas');
        if (btnKmsAMillas) btnKmsAMillas.addEventListener('click', convertirMillaje);
        
        const btnCalcularTraspaso = document.getElementById('btnCalcularTraspaso');
        if (btnCalcularTraspaso) btnCalcularTraspaso.addEventListener('click', calcularTraspaso);
        
        const btnConsultarPlaca = document.getElementById('btnConsultarPlaca');
        if (btnConsultarPlaca) btnConsultarPlaca.addEventListener('click', consultarPlacaRNP);

        const btnScanVIN = document.getElementById('btnScanVIN');
        if (btnScanVIN) btnScanVIN.addEventListener('click', iniciarScanner);
        
        const btnStopScan = document.getElementById('btnStopScan');
        if (btnStopScan) btnStopScan.addEventListener('click', detenerScanner);

        const btnLogin = document.getElementById('btnLogin');
        if (btnLogin) btnLogin.addEventListener('click', iniciarSesion);

        const btnForgotPassword = document.getElementById('btnForgotPassword');
        if (btnForgotPassword) btnForgotPassword.addEventListener('click', enviarResetPassword);

        const btnCreate = document.getElementById('btnCreateAccount');
        if (btnCreate) btnCreate.addEventListener('click', crearCuenta);

        const btnLogout = document.getElementById('btnLogout');
        if (btnLogout) btnLogout.addEventListener('click', cerrarSesion);
        
        document.querySelectorAll('.collapsible-header').forEach(header => {
            header.addEventListener('click', () => {
                const targetId = header.dataset.target;
                const content = document.getElementById(targetId);
                if (content) {
                    header.classList.toggle('open');
                    content.classList.toggle('open');
                }
            });
        });

        const rememberedEmail = localStorage.getItem('rememberedEmail');
        if (rememberedEmail) {
            const loginEmailInput = document.getElementById('loginEmail');
            const rememberMeCheckbox = document.getElementById('rememberMe');
            if (loginEmailInput) loginEmailInput.value = rememberedEmail;
            if (rememberMeCheckbox) rememberMeCheckbox.checked = true;
        }

        actualizarHistorialUI();
        fetchTipoDeCambio();
    });

    // ==== FUNCIONES DE AUTENTICACIÓN ====
    function crearCuenta() {
       if (typeof auth === 'undefined' || typeof db === 'undefined') { 
           console.error("Firebase no inicializado"); 
           showToast("Error de servicio", "error"); 
           return; 
       }
       
       const emailInput = document.getElementById('createEmail');
       const passwordInput = document.getElementById('createPassword');
       const errorElement = document.getElementById('createError');
       if (!emailInput || !passwordInput || !errorElement) return;
       
       const email = emailInput.value;
       const password = passwordInput.value;
       errorElement.textContent = '';
       
       if (!email || !password) { 
           errorElement.textContent = 'Ingresa correo y contraseña.'; 
           return; 
       }
       
       auth.createUserWithEmailAndPassword(email, password)
           .then(userCredential => {
               const user = userCredential.user;
               console.log('Cuenta creada en Auth:', user.uid);
               const userDocRef = db.collection('usuarios').doc(user.uid);
               const hoy = new Date();
               const fechaExpiracion = new Date(hoy);
               fechaExpiracion.setDate(hoy.getDate() + 30); 

               return userDocRef.set({ 
                   email: user.email, 
                   suscripcionActiva: true, 
                   fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(), 
                   fechaExpiracionSuscripcion: firebase.firestore.Timestamp.fromDate(fechaExpiracion), 
                   metodoPago: 'manual_admin',
                   rol: 'cliente'
               });
           })
           .then(() => {
               console.log("Doc Firestore creado correctamente.");
               showToast(`✅ Cuenta creada para ${emailInput.value}`, 'success');
               emailInput.value = ''; 
               passwordInput.value = '';
               
               const adminDashboard = document.getElementById('admin-dashboard-card');
               if (adminDashboard && adminDashboard.style.display !== 'none') {
                   cargarDashboardAdmin();
               }
           })
           .catch(error => {
               console.error("Error al crear cuenta:", error);
               if (error.code === 'auth/email-already-in-use') { 
                   errorElement.textContent = 'Este correo ya está registrado.'; 
               }
               else if (error.code === 'auth/weak-password'){ 
                   errorElement.textContent = 'La contraseña debe tener al menos 6 caracteres.'; 
               }
               else { 
                   errorElement.textContent = `Error: ${error.message}`; 
               }
               showToast(`❌ Error al crear cuenta`, 'error');
           });
    }

    function iniciarSesion() {
       if (typeof auth === 'undefined') { 
           console.error("Firebase no inicializado"); 
           showToast("Error de servicio", "error"); 
           return; 
       }
       
       const emailInput = document.getElementById('loginEmail');
       const passwordInput = document.getElementById('loginPassword');
       const errorElement = document.getElementById('loginError');
       const btnLogin = document.getElementById('btnLogin'); 
       const rememberMeCheckbox = document.getElementById('rememberMe');
       const rememberMe = rememberMeCheckbox ? rememberMeCheckbox.checked : false;
       
       if (!emailInput || !passwordInput || !errorElement || !btnLogin) return; 
       
       const email = emailInput.value;
       const password = passwordInput.value;
       errorElement.textContent = 'Verificando...';
       
       if (!email || !password) { 
           errorElement.textContent = 'Ingresa correo y contraseña.'; 
           return; 
       }
       
        if (rememberMe) {
            localStorage.setItem('rememberedEmail', email);
        } else {
            localStorage.removeItem('rememberedEmail');
        }

       btnLogin.disabled = true;
       btnLogin.textContent = 'Verificando...';
       
       auth.signInWithEmailAndPassword(email, password)
           .then(userCredential => { 
               console.log('Usuario inició sesión:', userCredential.user.email); 
           })
           .catch(error => {
               console.error("Error al iniciar sesión:", error);
               if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') { 
                   errorElement.textContent = 'Correo o contraseña incorrectos.'; 
               }
               else { 
                   errorElement.textContent = `Error: ${error.message}`; 
               }
               
               btnLogin.disabled = false;
               btnLogin.textContent = 'Ingresar';
           });
    }

    function enviarResetPassword() {
       if (typeof auth === 'undefined') { 
           showToast("Error de servicio", "error"); 
           return; 
       }
       
       const emailInput = document.getElementById('loginEmail');
       const errorElement = document.getElementById('loginError');
       if (!emailInput || !errorElement) return;
       const email = emailInput.value;

       if (!email) {
           errorElement.textContent = 'Por favor, ingresa tu correo para restablecer la contraseña.';
           emailInput.focus();
           return;
       }

       errorElement.textContent = 'Enviando correo...';
       
       auth.sendPasswordResetEmail(email)
           .then(() => {
               errorElement.textContent = ''; 
               showToast(`✅ Correo enviado a ${email}`, 'success', 5000);
           })
           .catch((error) => {
               console.error("Error al enviar correo:", error);
               if (error.code === 'auth/user-not-found') {
                   errorElement.textContent = 'No se encontró un usuario con ese correo.';
               } else {
                   errorElement.textContent = `Error: ${error.message}`;
               }
           });
    }

    function cerrarSesion() {
       if (typeof auth === 'undefined') { 
           console.error("Firebase no inicializado"); 
           return; 
       }
       
        const emailInput = document.getElementById('loginEmail');
        const passwordInput = document.getElementById('loginPassword');
        const rememberMeCheckbox = document.getElementById('rememberMe');
        
        if (rememberMeCheckbox && !rememberMeCheckbox.checked) {
             if (emailInput) emailInput.value = '';
        }
        if (passwordInput) passwordInput.value = '';

       auth.signOut().catch(error => { 
           console.error('Error al cerrar sesión:', error); 
           showToast('Error al cerrar sesión', 'error'); 
       });
    }

    // ==== AUTH STATE OBSERVER ====
    if (typeof auth !== 'undefined' && typeof db !== 'undefined') {
        auth.onAuthStateChanged(user => {
            console.log("onAuthStateChanged:", user ? user.email : "No user");
            
            const authSection = document.getElementById('auth-section');
            const appContent = document.getElementById('app-content');
            const loginError = document.getElementById('loginError');
            const headerButtons = document.getElementById('main-header-buttons');
            const userInfoDisplay = document.getElementById('userInfoDisplay'); 
            const createAccountWrapper = document.getElementById('create-account-form-wrapper');
            const adminDashboard = document.getElementById('admin-dashboard-card');
            
            if (!authSection || !appContent || !loginError || !headerButtons || !userInfoDisplay || !createAccountWrapper || !adminDashboard) { 
                console.error("Elementos UI Auth no encontrados."); 
                return; 
            }

            if (user) {
                console.log("Usuario detectado:", user.email);
                loginError.textContent = 'Verificando suscripción...';
                headerButtons.style.display = 'none';
                
                const userDocRef = db.collection('usuarios').doc(user.uid);

                userDocRef.get().then(doc => {
                    const datosUsuario = doc.exists ? doc.data() : null;
                    let esAdmin = datosUsuario && datosUsuario.rol === 'admin';
                    
                    if (esAdmin) {
                        createAccountWrapper.style.display = 'block';
                        adminDashboard.style.display = 'block';
                        cargarDashboardAdmin(); 
                        setupAdminSearch(); 
                    } else {
                        createAccountWrapper.style.display = 'none';
                        adminDashboard.style.display = 'none';
                    }
                    
                    const hoy = new Date();
                    let suscripcionValida = false;
                    
                    if (datosUsuario && datosUsuario.suscripcionActiva === true && datosUsuario.fechaExpiracionSuscripcion) {
                        const fechaExpiracion = datosUsuario.fechaExpiracionSuscripcion.toDate();
                        if (fechaExpiracion >= hoy) {
                            suscripcionValida = true;
                        } else {
                            loginError.textContent = 'Tu suscripción ha expirado.';
                        }
                    } else if (!datosUsuario) {
                         loginError.textContent = 'Error de configuración de cuenta.';
                    } else if (datosUsuario.suscripcionActiva !== true) {
                         loginError.textContent = 'Necesitas una suscripción activa.';
                    } else if (!datosUsuario.fechaExpiracionSuscripcion) {
                         loginError.textContent = 'Error de configuración de cuenta.';
                    }

                    if (suscripcionValida) {
                        authSection.style.display = 'none';
                        appContent.style.display = 'block';
                        headerButtons.style.display = 'flex';
                        loginError.textContent = '';
                        
                        const userInfoEmail = document.getElementById('userInfoEmail');
                        const userInfoExpiry = document.getElementById('userInfoExpiry');
                        if (userInfoEmail && userInfoExpiry && datosUsuario.fechaExpiracionSuscripcion) {
                            userInfoEmail.textContent = user.email;
                            const fechaExp = datosUsuario.fechaExpiracionSuscripcion.toDate();
                            const hoyMedianoche = new Date();
                            hoyMedianoche.setHours(0, 0, 0, 0);
                            const diffTime = fechaExp.getTime() - hoyMedianoche.getTime();
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                            
                            if (diffDays < 0) {
                                 userInfoExpiry.textContent = `Vencida`;
                                 userInfoExpiry.style.color = '#dc2626';
                            } else if (diffDays === 0) {
                                 userInfoExpiry.textContent = `Vence Hoy`;
                                 userInfoExpiry.style.color = '#dc2626';
                            } else if (diffDays === 1) {
                                 userInfoExpiry.textContent = `1 día restante`;
                                 userInfoExpiry.style.color = '#f59e0b';
                            } else {
                                 userInfoExpiry.textContent = `${diffDays} días restantes`;
                                 userInfoExpiry.style.color = diffDays <= 7 ? '#f59e0b' : '#15803d';
                            }
                            userInfoDisplay.style.display = 'block';
                        } else {
                            userInfoDisplay.style.display = 'none';
                        }

                    } else {
                        authSection.style.display = 'block'; 
                        appContent.style.display = 'none';
                        headerButtons.style.display = 'none';
                        userInfoDisplay.style.display = 'none';
                    }
                }).catch(error => {
                    console.error("Error Firestore:", error);
                    authSection.style.display = 'block';
                    appContent.style.display = 'none';
                    headerButtons.style.display = 'none';
                    userInfoDisplay.style.display = 'none';
                    loginError.textContent = 'Error verificando suscripción.';
                });
            } else {
                console.log("No hay usuario logueado.");
                authSection.style.display = 'block';
                appContent.style.display = 'none';
                headerButtons.style.display = 'none';
                loginError.textContent = '';
                userInfoDisplay.style.display = 'none'; 
                createAccountWrapper.style.display = 'none';
                adminDashboard.style.display = 'none';
                
                const btnLogin = document.getElementById('btnLogin');
                if (btnLogin) {
                    btnLogin.disabled = false;
                    btnLogin.textContent = 'Ingresar';
                }
            }
        });
    } else {
        console.error("Firebase Auth/Firestore no definidos.");
    }

    // ==== FUNCIONES DE FORMATO ====
    function formatUSD(num) { return ' + Math.round(num).toLocaleString('en-US'); }
    function formatCRC(num) { return '₡' + Math.round(num).toLocaleString('es-CR'); }

    function showToast(message, type = 'info', duration = 3000) {
        const toast = document.getElementById('toast');
        if (!toast) return;
        clearTimeout(toastTimeout);
        toast.textContent = message;
        toast.className = 'toast'; 
        toast.classList.add(type); 
        toast.classList.add('show'); 
        toastTimeout = setTimeout(() => {
            toast.classList.remove('show');
        }, duration);
    }
    
    // ==== VALIDACIÓN ====
    function validarInicioAno() {
        const anoInput = document.getElementById('ano');
        const ayudaAno = document.getElementById('ayudaAno');
        if (!anoInput || !ayudaAno) return;
        const valor = anoInput.value;
        if (valor.length > 0 && valor[0] !== '1' && valor[0] !== '2') {
            ayudaAno.innerHTML = '<span style="color: #dc2626;">El año debe comenzar con 1 o 2</span>';
        } else {
            if (ayudaAno.innerHTML.includes('comenzar con 1 o 2')) {
                ayudaAno.innerHTML = '';
            }
        }
    }

    function validarAno() {
        const anoInput = document.getElementById('ano');
        const ayudaAno = document.getElementById('ayudaAno');
        if (!anoInput || !ayudaAno) return;
        const ano = parseInt(anoInput.value);
        if (!ano || ano < 1980 || ano > anoActual + 1) {
            ayudaAno.innerHTML = '<span style="color: #dc2626;">Año inválido (1980 - ' + (anoActual + 1) + ')</span>';
        } else {
            const antiguedad = anoActual - ano;
            const porcentaje = antiguedad <= 6 ? '48.37%' : '68.37%';
            ayudaAno.textContent = `${antiguedad} años | Impuesto: ${porcentaje}`;
        }
    }

    function calcular() {
        const anoInput = document.getElementById('ano');
        const valorInput = document.getElementById('valor');
        const fleteInput = document.getElementById('flete');
        const tcInput = document.getElementById('tipoCambio');
        const resultadoTotalEl = document.getElementById('resultadoTotal');
        const resultadoDiv = document.getElementById('resultado');
        const tcFooterEl = document.getElementById('tcFooter');

        if (!anoInput || !valorInput || !fleteInput || !tcInput || !resultadoTotalEl || !resultadoDiv || !tcFooterEl) {
            showToast('Error interno: elementos no encontrados.', 'error');
            return;
        }

        const ano = parseInt(anoInput.value);
        const valor = parseFloat(valorInput.value) || 0;
        const flete = parseFloat(fleteInput.value) || 0;
        const tc = parseFloat(tcInput.value) || 0;
        
         if (!ano || ano < 1980 || ano > anoActual + 1) {
             showToast('Por favor, ingrese un año válido', 'error');
             anoInput.focus();
             return;
         }
        if (valor <= 0 || flete <= 0 || tc <= 0) { 
            showToast('Faltan campos obligatorios', 'error'); 
            return; 
        }
        
        const antiguedad = anoActual - ano;
        const porcentajeImpuesto = antiguedad <= 6 ? 0.4837 : 0.6837;
        const valorPlusFlete = valor + flete;
        const totalSeguros = valorPlusFlete * (COSTOS_FIJOS.SEGURO_1 + COSTOS_FIJOS.SEGURO_2);
        const baseImpuestos = valorPlusFlete + totalSeguros; 
        const impuestosUSD = baseImpuestos * porcentajeImpuesto;
        const subtotalVehiculoCRC = valorPlusFlete * tc; 
        const impuestosCRC = impuestosUSD * tc;
        const papeleoUSACRC = COSTOS_FIJOS.PAPELEO_USA * tc;
        const gastosFijosCRC = COSTOS_FIJOS.DECLARACION_CR + COSTOS_FIJOS.DEKRA + COSTOS_FIJOS.ALMACENAMIENTO;
        const totalColones = subtotalVehiculoCRC + impuestosCRC + papeleoUSACRC + gastosFijosCRC;

        calculoActual = { 
            ano, valor, flete, antiguedad, 
            totalSeguros, baseImpuestos, impuestosUSD, 
            papeleoUSA: COSTOS_FIJOS.PAPELEO_USA, 
            declaracion: COSTOS_FIJOS.DECLARACION_CR, 
            dekra: COSTOS_FIJOS.DEKRA, 
            almacenamiento: COSTOS_FIJOS.ALMACENAMIENTO, 
            tc, totalColones, 
            fecha: new Date().toLocaleString('es-CR'),
            vinInfo: { ...currentVinInfo } 
        };
        
        resultadoTotalEl.textContent = formatCRC(totalColones);
        resultadoDiv.classList.remove('hidden');
        tcFooterEl.textContent = tc.toFixed(2);
        
        const detalleDiv = document.getElementById('detalle');
        if(detalleDiv) detalleDiv.classList.add('hidden');
    }

    function mostrarDetalle() {
        const detalleContentEl = document.getElementById('detalleContent');
        const detalleDiv = document.getElementById('detalle');
        if (!calculoActual || !detalleContentEl || !detalleDiv) return;
        
        const d = calculoActual;
        const gastosAdminColones = (d.papeleoUSA * d.tc) + d.declaracion + d.dekra + d.almacenamiento;
        let html = `
            <div class="section-header">VALORES EN DÓLARES</div>
            <div class="detail-row"><span class="detail-label">Valor vehículo</span><span class="detail-value">${formatUSD(d.valor)}</span></div>
            <div class="detail-row"><span class="detail-label">Flete</span><span class="detail-value">${formatUSD(d.flete)}</span></div>
            <div class="detail-row subtotal" style="border-bottom: none;"><span class="detail-label">Subtotal USD</span><span class="detail-value">${formatUSD(d.valor + d.flete)}</span></div>
            <div class="section-header" style="margin-top: 20px;">VALORES EN COLONES</div>
            <div class="detail-row"><span class="detail-label">Vehículo+Flete</span><span class="detail-value">${formatCRC((d.valor + d.flete) * d.tc)}</span></div>
            <div class="detail-row"><span class="detail-label">Impuestos (${d.antiguedad <= 6 ? '48.37%' : '68.37%'})</span><span class="detail-value">${formatCRC(d.impuestosUSD * d.tc)}</span></div>
            <div class="detail-row" style="border-bottom: none;"><span class="detail-label">Gastos Admin.</span><span class="detail-value">${formatCRC(gastosAdminColones)}</span></div>
            <div class="total-row"><span>GRAN TOTAL</span><span>${formatCRC(d.totalColones)}</span></div>`;
        detalleContentEl.innerHTML = html;
        detalleDiv.classList.remove('hidden');
    }

    // ==== HERRAMIENTAS ====
    function convertirMillaje(event) {
        const millajeInput = document.getElementById('millaje');
        const anoInput = document.getElementById('ano');
        const resultadoCard = document.getElementById('millajeInfoCard');
        const resultadoLabel = document.getElementById('millajeResultadoLabel');
        const resultadoValor = document.getElementById('millajeResultadoValor');
        const promedioLabel = document.getElementById('millajePromedioLabel');
        const promedioValor = document.getElementById('millajePromedioValor');
        const promedioStatus = document.getElementById('millajePromedioStatus');
        const btnMillas = document.getElementById('btnMillasAKm');
        const btnKms = document.getElementById('btnKmsAMillas');

        if (!millajeInput || !anoInput || !resultadoCard || !resultadoLabel || !resultadoValor || !promedioLabel || !promedioValor || !promedioStatus || !btnMillas || !btnKms) return;

        if (btnMillas) btnMillas.classList.remove('active');
        if (btnKms) btnKms.classList.remove('active');
        if (event && event.target) event.target.classList.add('active');
        
        const valorInput = parseFloat(millajeInput.value);
        const ano = parseInt(anoInput.value);

        if (isNaN(valorInput) || valorInput < 0) { 
            showToast('Ingrese un valor de millaje válido', 'error'); 
            if (event && event.target) event.target.classList.remove('active');
            resultadoCard.classList.add('hidden');
            return; 
        }
        if (isNaN(ano) || ano < 1980 || ano > anoActual + 1) { 
            showToast('Ingrese un año de vehículo válido', 'error'); 
            if (event && event.target) event.target.classList.remove('active');
            resultadoCard.classList.add('hidden');
            return; 
        }
        
        const antiguedad = Math.max(1, anoActual - ano + 1);
        let resultadoNum, promedio, esSobrePromedio, promedioPorAno;
        let esMillasAKm = event.target.id === 'btnMillasAKm';

        if (esMillasAKm) {
            resultadoNum = valorInput * KM_POR_MILLA;
            promedio = PROMEDIO_MILLAS_ANO * antiguedad;
            esSobrePromedio = valorInput > promedio;
            promedioPorAno = valorInput / antiguedad;
            resultadoLabel.textContent = "Total KMs";
            resultadoValor.textContent = Math.round(resultadoNum).toLocaleString('es-CR');
            promedioLabel.textContent = `Promedio (${Math.round(PROMEDIO_MILLAS_ANO/1000)}k Millas/Año)`;
            promedioValor.textContent = Math.round(promedioPorAno).toLocaleString('en-US');
        } else {
            resultadoNum = valorInput * MILLAS_POR_KM;
            promedio = PROMEDIO_KMS_ANO * antiguedad;
            esSobrePromedio = valorInput > promedio;
            promedioPorAno = valorInput / antiguedad;
            resultadoLabel.textContent = "Total Millas";
            resultadoValor.textContent = Math.round(resultadoNum).toLocaleString('en-US');
            promedioLabel.textContent = `Promedio (${Math.round(PROMEDIO_KMS_ANO/1000)}k KMs/Año)`;
            promedioValor.textContent = Math.round(promedioPorAno).toLocaleString('es-CR');
        }
        promedioStatus.textContent = esSobrePromedio ? 'Sobre el promedio' : 'Debajo del promedio';
        promedioStatus.style.color = esSobrePromedio ? '#dc2626' : '#15803d';
        resultadoCard.classList.remove('hidden');
    }

    function calcularTraspaso() {
        const valorFiscalInput = document.getElementById('valorFiscal');
        const resultadoEl = document.getElementById('resultadoTraspaso');
        if (!valorFiscalInput || !resultadoEl) return;

        const valorFiscal = parseFloat(valorFiscalInput.value);
        if (isNaN(valorFiscal) || valorFiscal <= 0) {
            showToast('Ingrese un valor fiscal válido', 'error'); 
            resultadoEl.innerHTML = '<p style="color:#dc2626; font-size:12px;">Ingrese un valor fiscal válido</p>'; 
            return;
        }
        const timbres = valorFiscal * PORCENTAJE_TIMBRES;
        const total = timbres + HONORARIOS_TRASPASO;
        resultadoEl.style.color = '#1f2937';
        resultadoEl.innerHTML = `
            <div class="detail-row"><span class="detail-label">Timbres (${(PORCENTAJE_TIMBRES * 100).toFixed(1)}%)</span><span class="detail-value">${formatCRC(timbres)}</span></div>
            <div class="detail-row" style="border:none;"><span class="detail-label">Honorarios Aprox.</span><span class="detail-value">${formatCRC(HONORARIOS_TRASPASO)}</span></div>
            <div class="total-row" style="margin-top: 8px;"><span>TOTAL APROX.</span><span>${formatCRC(total)}</span></div>`;
    }

    async function consultarPlacaRNP() {
        if (typeof consultarFn !== 'function') {
            showToast("Error: Servicio de consulta no disponible.", "error");
            console.error("consultarFn no está definida.");
            return;
        }

        const placaInput = document.getElementById('consultaPlacaInput');
        const resultadoEl = document.getElementById('resultadoConsultaPlaca');
        const btnConsultar = document.getElementById('btnConsultarPlaca');
        const valorFiscalInput = document.getElementById('valorFiscal');

        if (!placaInput || !resultadoEl || !btnConsultar || !valorFiscalInput) {
            showToast("Error interno: elementos no encontrados.", "error");
            return;
        }

        const placa = placaInput.value.trim().toUpperCase();
        if (!placa) {
            showToast("Por favor, ingresa una placa.", "info");
            placaInput.focus();
            return;
        }

        if (!auth || !auth.currentUser) {
            showToast("Debes iniciar sesión para usar esta función.", "error");
            return;
        }

        resultadoEl.textContent = "Consultando RNP...";
        btnConsultar.disabled = true;
        btnConsultar.textContent = 'Consultando...';

        try {
            console.log(`Llamando a consultaPlacaRNP con placa: ${placa}`);
            const resp = await consultarFn({ placa: placa });
            console.log("Respuesta de la función:", resp);

            if (resp.data && resp.data.ok && resp.data.data) {
                const d = resp.data.data;
                resultadoEl.textContent = JSON.stringify(d, null, 2);

                if (d.valorFiscal) {
                    const valorNumerico = parseFloat(String(d.valorFiscal).replace(/[₡,\s]/g, ''));
                    if (!isNaN(valorNumerico)) {
                        valorFiscalInput.value = valorNumerico.toFixed(0);
                        showToast(`Valor fiscal ${formatCRC(valorNumerico)} encontrado.`, "success");
                    } else {
                        showToast(`Valor fiscal encontrado, formato no reconocido: ${d.valorFiscal}`, "info");
                    }
                } else {
                    showToast("Consulta exitosa, pero no se encontró valor fiscal.", "info");
                }
                 if (d.gravamen) {
                    showToast(`¡Alerta! Indicio de gravamen. Detalles: ${d.detallesGravamen || 'Revisar RNP'}`, "error", 6000);
                 }

            } else if (resp.data && resp.data.message) {
                 resultadoEl.textContent = `Error del servidor: ${resp.data.message}`;
                 showToast("Error en la consulta RNP", "error");
            } else {
                resultadoEl.textContent = "Respuesta inesperada: " + JSON.stringify(resp.data);
                showToast("Respuesta inesperada del servidor", "error");
            }

        } catch (err) {
            console.error("Error al llamar Cloud Function:", err);
            let errorMsg = err.message || JSON.stringify(err);

            if (err.code === 'unauthenticated') {
                errorMsg = "No autenticado. Inicia sesión de nuevo.";
            } else if (err.code === 'permission-denied') {
                errorMsg = "Permiso denegado.";
            } else if (err.message && err.message.includes("timeout")) {
                 errorMsg = "Tiempo agotado. Intenta de nuevo.";
            }

            resultadoEl.textContent = `Error: ${errorMsg}`;
            showToast(`Error en la consulta: ${errorMsg}`, 'error', 5000);

        } finally {
            btnConsultar.disabled = false;
            btnConsultar.textContent = 'Consultar Placa';
        }
    }

    // ==== HISTORIAL ====
    function guardarHistorial() { 
        const anoInput = document.getElementById('ano');
        const vinMakeEl = document.getElementById('vinMake');
        const vinModelEl = document.getElementById('vinModel');
        
        if (!calculoActual || !anoInput || !vinMakeEl || !vinModelEl) {
            showToast('Primero debes calcular un vehículo', 'error');
            return;
        } 
        
        let infoAno = anoInput.value || 'N/D';
        calculoActual.vinInfo = { 
            make: vinMakeEl.textContent || 'N/D',
            model: vinModelEl.textContent || 'N/D',
            year: infoAno
        };
        
        historial.unshift({id: Date.now(), ...calculoActual }); 
        
        try {
            localStorage.setItem('impuestosHistorial', JSON.stringify(historial)); 
            showToast('✅ Cálculo guardado', 'success'); 
            actualizarHistorialUI(); 
        } catch (e) {
            console.error("Error guardando historial:", e);
            showToast('Error al guardar historial', 'error');
        }
    }

    function actualizarHistorialUI() { 
        const card = document.getElementById('historialCard'); 
        const content = document.getElementById('historialContent'); 
        if (!card || !content) return;

        if (historial.length === 0) { 
            content.innerHTML = '<p style="text-align:center; color:#6b7280; font-size:13px;">No hay cálculos guardados.</p>';
            return; 
        } 
        
        let html = ''; 
        historial.forEach(item => { 
            const isSelected = vehiculosSeleccionados.has(item.id); 
            const cardClass = `comparison-card ${isSelected ? 'selected' : ''}`; 
            let vehicleInfoText = '';
            if (item.vinInfo && item.vinInfo.make && item.vinInfo.make !== 'N/D' && item.vinInfo.model && item.vinInfo.model !== 'N/D') {
                vehicleInfoText = `${item.vinInfo.year || ''} ${item.vinInfo.make} ${item.vinInfo.model}`;
            } else if (item.ano) { 
                vehicleInfoText = `Año: ${item.ano}`;
            } else {
                vehicleInfoText = "Vehículo (sin info)";
            }
            html += `
                <div class="${cardClass}" data-id="${item.id}" onclick="seleccionarComparacion(${item.id})">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="historial-vehicle-info">${vehicleInfoText.trim()}</div>
                        <div style="font-weight: bold; color: #2563eb;">${formatCRC(item.totalColones)}</div>
                    </div>
                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Valor: ${formatUSD(item.valor || 0)} + Flete: ${formatUSD(item.flete || 0)}</div>
                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">${item.fecha || ''}</div>
                    ${isSelected ? '<div style="font-size: 11px; color: #1e40af; margin-top: 4px; font-weight: 500;">✓ Comparando</div>' : ''}
                </div>`; 
        }); 
        content.innerHTML = html; 
    }

    function seleccionarComparacion(id) { 
        if (!modoComparacion) return;
        if (vehiculosSeleccionados.has(id)) { 
            vehiculosSeleccionados.delete(id); 
        } else if (vehiculosSeleccionados.size < 2) { 
            vehiculosSeleccionados.add(id); 
        } else {
            showToast('Puedes comparar máximo 2 vehículos', 'info');
        }
        actualizarHistorialUI(); 
        mostrarComparacion(); 
    }

    function mostrarComparacion() { 
        const compDiv = document.getElementById('comparador'); 
        const compContent = document.getElementById('comparacionContent');
        if (!compDiv || !compContent) return;

        if (vehiculosSeleccionados.size < 2) { 
            compDiv.classList.add('hidden'); 
            return; 
        } 
        
        const sel = historial.filter(v => vehiculosSeleccionados.has(v.id)); 
        if (sel.length < 2) {
             compDiv.classList.add('hidden'); 
             return;
        }

        let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">'; 
        sel.forEach((v, idx) => { 
            let vehicleInfoText = 'Vehículo';
            if (v.vinInfo && v.vinInfo.make && v.vinInfo.make !== 'N/D' && v.vinInfo.model && v.vinInfo.model !== 'N/D') {
                vehicleInfoText = `${v.vinInfo.year || ''} ${v.vinInfo.make} ${v.vinInfo.model}`;
            } else if (v.ano) {
                vehicleInfoText = `Año: ${v.ano}`;
            }
            html += `
            <div style="border: 1px solid #dbeafe; border-radius: 8px; padding: 10px;">
                <div style="font-weight: bold; color: #1e40af; font-size: 13px; margin-bottom: 8px; min-height: 2.5em;">${vehicleInfoText.trim()}</div>
                <div style="font-size: 11px; padding: 8px; background: #f3f4f6; border-radius: 6px;">
                    Valor: ${formatUSD(v.valor || 0)}<br>
                    Flete: ${formatUSD(v.flete || 0)}<br><br>
                    <strong style="font-size: 13px;">${formatCRC(v.totalColones || 0)}</strong>
                </div>
            </div>
        `; 
        html += '</div>'; 

        const diff = Math.abs(sel[0].totalColones - sel[1].totalColones); 
        html += `<div style="background: #eff6ff; padding: 12px; border-radius: 8px; text-align: center; font-weight: bold; color: #1e40af; margin-top: 12px;">Diferencia: ${formatCRC(diff)}</div>`; 
        
        compContent.innerHTML = html; 
        compDiv.classList.remove('hidden');
    }

    function toggleComparacion() { 
        const btnComparar = document.getElementById('btnComparar');
        const compDiv = document.getElementById('comparador'); 
        if (!btnComparar || !compDiv) return;

        modoComparacion = !modoComparacion; 
        btnComparar.classList.toggle('active', modoComparacion); 
        vehiculosSeleccionados.clear();
        if (!modoComparacion) {
             compDiv.classList.add('hidden');
        } else {
             showToast('Modo Comparación: Selecciona 2 cálculos', 'info', 4000);
        }
        actualizarHistorialUI();
    }

    function toggleHistorial() { 
         const card = document.getElementById('historialCard'); 
         if (card) card.classList.toggle('hidden'); 
     }

    function limpiarHistorial() { 
        if (confirm('¿Borrar todo el historial?')) { 
            historial = []; 
            vehiculosSeleccionados.clear(); 
            try {
                localStorage.removeItem('impuestosHistorial'); 
                actualizarHistorialUI(); 
                const compDiv = document.getElementById('comparador');
                if (compDiv) compDiv.classList.add('hidden'); 
                showToast('Historial limpiado', 'info');
            } catch (e) {
                 console.error("Error limpiando historial:", e);
                 showToast('Error al limpiar historial', 'error');
            }
        } 
    }

    // ==== VIN API ====
    function handleVinInput() {
        clearTimeout(vinDecodeTimeout);
        const vinInput = document.getElementById('vin');
        const vinStatus = document.getElementById('vinStatus');
        if (!vinInput || !vinStatus) return;

        const vin = vinInput.value.toUpperCase().trim(); 
        limpiarFichaVIN();
        currentVinInfo = { make: '', model: '', year: '' }; 

        if (vin.length === 0) {
            vinStatus.innerHTML = ''; return;
        }
        if (vin.length < 17) {
            vinStatus.innerHTML = `<span style="color: #f59e0b;">VIN debe tener 17 caracteres (${vin.length}/17)</span>`; return;
        }
        if (vin.length === 17) {
            vinStatus.innerHTML = `<div class="spinner" style="display:inline-block; vertical-align: middle; margin-right: 5px;"></div><span style="vertical-align: middle;">Decodificando VIN...</span>`;
            vinDecodeTimeout = setTimeout(() => { fetchVinData(vin); }, 500);
        }
    }
    
    async function fetchVinData(vin) {
        const vinStatus = document.getElementById('vinStatus');
        const anoInput = document.getElementById('ano');
        if (!vinStatus || !anoInput) return;

        try {
            const apiUrl = `https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVinValues/${vin}?format=json`;
            const response = await fetch(apiUrl);
            if (!response.ok) { throw new Error(`Error de red (${response.status})`); }
            const data = await response.json();
            
            if (data && data.Results && data.Results[0]) {
                const result = data.Results[0];
                if (result.ErrorCode === "0" && result.Make && result.Model && result.ModelYear) { 
                    vinStatus.innerHTML = '<span style="color: #059669;">✓ VIN decodificado</span>';
                    displayVinData(result);
                    currentVinInfo = {
                        make: result.Make || 'N/D',
                        model: result.Model || 'N/D',
                        year: result.ModelYear || 'N/D'
                    };
                    anoInput.value = result.ModelYear;
                    validarAno();
                    
                } else {
                    let errorText = result.ErrorText || "VIN no encontrado";
                    if (errorText.includes('(0 VINs decoded)')) errorText = "VIN no encontrado en la base de datos.";
                    vinStatus.innerHTML = `<span style="color: #dc2626;">Error: ${errorText}</span>`;
                    limpiarFichaVIN();
                    currentVinInfo = { make: '', model: '', year: '' }; 
                }
            } else {
                throw new Error("Formato de respuesta API inesperado.");
            }
        } catch (error) {
            console.error('Error fetching VIN:', error);
            vinStatus.innerHTML = `<span style="color: #dc2626;">Error: ${error.message}</span>`;
            limpiarFichaVIN();
            currentVinInfo = { make: '', model: '', year: '' }; 
        }
    }

    async function fetchTipoDeCambio() {
        const tcInput = document.getElementById('tipoCambio');
        const tcHelp = document.getElementById('tipoCambioHelp');
        const tcFooterEl = document.getElementById('tcFooter');
        if (!tcInput || !tcHelp || !tcFooterEl) return;

        tcHelp.innerHTML = `<div class="spinner" style="display:inline-block; vertical-align: middle; margin-right: 5px;"></div><span style="vertical-align: middle;">Actualizando TC...</span>`;
        const url = `https://api.hacienda.go.cr/indicadores/tc`;
        
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Error API Hacienda');
            const data = await response.json();
            const valorVenta = data?.dolar?.venta?.valor;
            
            if (valorVenta && typeof valorVenta === 'number') {
                const tcValue = valorVenta.toFixed(2);
                tcInput.value = tcValue;
                const fecha = data.dolar.venta.fecha ? new Date(data.dolar.venta.fecha).toLocaleString('es-CR', { dateStyle: 'short', timeStyle: 'short' }) : 'Fecha N/D';
                tcHelp.innerHTML = `<span style="color:#059669">✓ TC Actualizado (${fecha})</span>`;
                tcFooterEl.textContent = tcValue;
            } else {
                throw new Error('Formato API inesperado.');
            }
        } catch (error) {
            console.error("Error fetching TC:", error);
            tcHelp.innerHTML = `<span style="color:#dc2626">Error. Ingréselo manual.</span>`;
            tcFooterEl.textContent = 'Error';
             if (!tcInput.value) tcInput.value = '520.00'; 
        }
    }

    function displayVinData(data) {
         const vinMakeEl = document.getElementById('vinMake');
         const vinModelEl = document.getElementById('vinModel');
         const vinTrimEl = document.getElementById('vinTrim');
         const vinEngineEl = document.getElementById('vinEngine');
         const vinCountryEl = document.getElementById('vinCountry');
         const vinInfoCard = document.getElementById('vinInfoCard');
         if (!vinMakeEl || !vinModelEl || !vinTrimEl || !vinEngineEl || !vinCountryEl || !vinInfoCard) return;

        let engineInfo = data.EngineCylinders ? `${data.EngineCylinders} Cilindros` : '';
        if (data.DisplacementL) engineInfo += ` ${data.DisplacementL}L`;
        
        vinMakeEl.textContent = data.Make || 'N/D';
        vinModelEl.textContent = data.Model || 'N/D';
        vinTrimEl.textContent = data.Trim || 'N/D';
        vinEngineEl.textContent = engineInfo.trim() || 'N/D';
        vinCountryEl.textContent = data.PlantCountry || 'N/D';
        vinInfoCard.classList.remove('hidden');
    }

    // ==== EXPORTACIÓN ====
    function generarTextoDesglose(esParaWhatsapp = false) {
        if (!calculoActual) return "Error: No hay cálculo.";
        const d = calculoActual;
        const gastosAdminColones = (d.papeleoUSA * d.tc) + d.declaracion + d.dekra + d.almacenamiento;
        const b = esParaWhatsapp ? '*' : '';
        const line = '---------------------------------';
        const doubleLine = '=====================';
        let vinDisplay = '';
        if (d.vinInfo && d.vinInfo.make && d.vinInfo.make !== 'N/D' && d.vinInfo.model && d.vinInfo.model !== 'N/D') {
            vinDisplay = `Vehículo: ${d.vinInfo.year || ''} ${d.vinInfo.make} ${d.vinInfo.model}\n`;
        } else if (d.ano) {
            vinDisplay = `Año: ${d.ano}\n`;
        }
        const texto = `
${b}CÁLCULO IMPUESTOS VEHÍCULO CR${b}
${vinDisplay}TC (Ref.): ${d.tc.toFixed(2)}
${doubleLine}

${b}Base (USD):${b}
Valor: ${formatUSD(d.valor)}
Flete: ${formatUSD(d.flete)}
*Subtotal USD:* ${formatUSD(d.valor + d.flete)}
${line}

${b}Costos (CRC):${b}
Vehículo+Flete: ${formatCRC((d.valor + d.flete) * d.tc)}
Impuestos (${d.antiguedad <= 6 ? '48.37%' : '68.37%'}): ${formatCRC(d.impuestosUSD * d.tc)}
Gastos Admin.: ${formatCRC(gastosAdminColones)}
${doubleLine}
${b}TOTAL: ${formatCRC(d.totalColones)}${b}
${doubleLine}
Fecha: ${d.fecha}
Calculadora CR
`.trim().split('\n').map(line => line.trim()).join('\n');
        return texto;
    }

    function descargarPDF() {
        if (!calculoActual) { showToast('Primero calcula un vehículo', 'info'); return; }
        try {
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                throw new Error("jsPDF no cargado.");
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'p',
                unit: 'pt',
                format: 'a4'
            });
            
            const contenido = generarTextoDesglose(false);
            doc.setFont("Helvetica", "normal");
            doc.setFontSize(10);
            
            const lines = doc.splitTextToSize(contenido, 500);
            doc.text(lines, 40, 60);
            
            let fileName = 'Nacionalizacion';
            if (calculoActual.vinInfo && calculoActual.vinInfo.year && calculoActual.vinInfo.make) {
                 fileName = `Nacionalizacion-${calculoActual.vinInfo.year}-${calculoActual.vinInfo.make}`;
            } else if (calculoActual.ano) {
                 fileName = `Nacionalizacion-${calculoActual.ano}`;
            }
            fileName += `-${Date.now()}.pdf`;

            doc.save(fileName.replace(/ /g, '_'));
            showToast('PDF generado', 'success');

        } catch (e) {
            console.error("Error PDF:", e);
            showToast(`❌ Error al generar PDF: ${e.message}`, 'error', 5000);
        }
    }

    function enviarWhatsApp() {
        if (!calculoActual) { showToast('Primero calcula un vehículo', 'info'); return; }
        const mensaje = generarTextoDesglose(true);
        const whatsappURL = 'https://wa.me/?text=' + encodeURIComponent(mensaje);
        window.open(whatsappURL, '_blank', 'noopener,noreferrer');
    }

    // ==== LIMPIEZA ====
    function limpiarFichaVIN() { 
         const vinInfoCard = document.getElementById('vinInfoCard');
         if(vinInfoCard) vinInfoCard.classList.add('hidden'); 
    }
    
    function limpiarFormulario() {
        ['vin', 'ano', 'valor', 'flete', 'tipoCambio', 'millaje', 'valorFiscal', 'consultaPlacaInput'].forEach(id => {
            const element = document.getElementById(id);
            if (element) element.value = '';
        });
        
        ['vinStatus', 'ayudaAno', 'tipoCambioHelp', 'resultadoTraspaso', 'detalleContent', 'resultadoConsultaPlaca'].forEach(id => {
            const element = document.getElementById(id);
            if (element) element.innerHTML = '';
        });
        
         const tcFooterEl = document.getElementById('tcFooter');
         if (tcFooterEl) tcFooterEl.textContent = 'N/A';

        ['resultado', 'detalle', 'vinInfoCard', 'millajeInfoCard'].forEach(id => {
            const element = document.getElementById(id);
            if (element) element.classList.add('hidden');
        });
        
        const btnMillas = document.getElementById('btnMillasAKm');
        const btnKms = document.getElementById('btnKmsAMillas');
        if (btnMillas) btnMillas.classList.remove('active');
        if (btnKms) btnKms.classList.remove('active');
        
        calculoActual = null;
        currentVinInfo = { make: '', model: '', year: '' }; 

        fetchTipoDeCambio(); 
        showToast('Formulario limpiado', 'info');
    }
    
    function limpiarVIN() {
        const vinInput = document.getElementById('vin');
        if (vinInput) {
            vinInput.value = '';
            handleVinInput.call(vinInput);
        }
    }

    // ==== ADMIN DASHBOARD ====
    async function cargarDashboardAdmin() {
        const listContainer = document.getElementById('admin-user-list');
        const loadingEl = document.getElementById('admin-user-list-loading');
        if (!listContainer || !loadingEl || !db) return;

        listContainer.innerHTML = '';
        loadingEl.style.display = 'block';

        try {
            const snapshot = await db.collection('usuarios').get();
            adminUserCache = []; 
            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.email && data.rol) {
                     adminUserCache.push({ id: doc.id, ...data });
                }
            });
            
            adminUserCache.sort((a, b) => a.email.localeCompare(b.email));
            loadingEl.style.display = 'none';
            renderizarListaUsuarios(adminUserCache); 

        } catch (error) {
            console.error("Error cargando usuarios:", error);
            loadingEl.innerHTML = `<span style="color:#dc2626">Error: ${error.message}</span>`;
            showToast('Error al cargar dashboard', 'error');
        }
    }

    function renderizarListaUsuarios(usuarios) {
        const listContainer = document.getElementById('admin-user-list');
        if (!listContainer) return;
        listContainer.innerHTML = ''; 
        
        const usuariosFiltrados = usuarios.filter(user => user.rol !== 'admin');

        if (usuariosFiltrados.length === 0) {
            listContainer.innerHTML = '<p style="text-align:center; color: #6b7280; font-size: 14px;">No se encontraron clientes.</p>';
            return;
        }
        
        const hoy = new Date();
        hoy.setHours(0,0,0,0);
        
        usuariosFiltrados.forEach(user => {
            let diasRestantes = 'N/D';
            let colorVigencia = '#6b7280';
            
            if (user.fechaExpiracionSuscripcion) {
                const fechaExp = user.fechaExpiracionSuscripcion.toDate();
                fechaExp.setHours(0,0,0,0);
                
                const diffTime = fechaExp.getTime() - hoy.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                
                if (!user.suscripcionActiva) {
                    diasRestantes = 'Desactivada';
                    colorVigencia = '#dc2626';
                } else if (diffDays < 0) {
                    diasRestantes = 'Vencida';
                    colorVigencia = '#dc2626';
                } else if (diffDays === 0) {
                     diasRestantes = 'Vence Hoy';
                     colorVigencia = '#dc2626';
                } else {
                    diasRestantes = `${diffDays} día${diffDays > 1 ? 's' : ''}`;
                    colorVigencia = diffDays <= 7 ? '#f59e0b' : '#15803d';
                }
            } else {
                 diasRestantes = 'Sin Fecha';
                 colorVigencia = '#f59e0b';
            }

            const userCardHTML = `
                <div class="card" style="margin-bottom: 12px; background: #f9fafb; padding: 12px; border: 1px solid #e5e7eb;">
                    <p style="font-weight: 600; font-size: 14px; color: #1f2937; word-break: break-all;">${user.email || 'Sin email'}</p>
                    <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                        Estado: <strong style="color: ${colorVigencia};">${diasRestantes}</strong>
                        ${user.fechaExpiracionSuscripcion ? ` (Vence: ${user.fechaExpiracionSuscripcion.toDate().toLocaleDateString('es-CR')})` : ''}
                    </p>
                    
                    <div class="button-group" style="margin-top: 10px; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 6px;">
                        <button class="btn-update-tc" onclick="adminActualizarSuscripcion('${user.id}', 30)">+30d</button>
                        <button class="btn-update-tc" onclick="adminActualizarSuscripcion('${user.id}', 365)">+1 Año</button>
                        
                        ${user.suscripcionActiva ?
                             `<button class="btn-danger-light" style="padding: 6px 10px;" onclick="adminAlternarSuscripcion('${user.id}', false)">Desactivar</button>` :
                             `<button class="btn-success-light" style="padding: 6px 10px; color: #166534;" onclick="adminAlternarSuscripcion('${user.id}', true)">Activar</button>`
                        }
                    </div>
                </div>
            `;
            listContainer.innerHTML += userCardHTML;
        });
    }

    function setupAdminSearch() {
        const searchInput = document.getElementById('adminSearch');
        if (!searchInput) return;
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();
            const filtrados = adminUserCache.filter(user => 
                 user.rol !== 'admin' && 
                 (user.email && user.email.toLowerCase().includes(query))
            );
            renderizarListaUsuarios(filtrados);
        });
    }

    // Hacer funciones admin globales para onclick
    window.adminActualizarSuscripcion = async function(userId, diasParaAnadir) {
        if (!db) return;
        if (!confirm(`¿Añadir ${diasParaAnadir} días?`)) return;

        const userDoc = db.collection('usuarios').doc(userId);
        let nuevaFecha;
        
        try {
            const doc = await userDoc.get();
            if (!doc.exists) {
                showToast('Usuario no encontrado.', 'error');
                return;
            }
            const data = doc.data();
            const hoy = new Date();
            hoy.setHours(0,0,0,0);
            let fechaInicio = hoy;
            
            if (data.fechaExpiracionSuscripcion && data.suscripcionActiva) {
                 const fechaExpActual = data.fechaExpiracionSuscripcion.toDate();
                 fechaExpActual.setHours(0,0,0,0);
                 if (fechaExpActual >= hoy) {
                     fechaInicio = data.fechaExpiracionSuscripcion.toDate();
                 }
            }
            
            nuevaFecha = new Date(fechaInicio);
            nuevaFecha.setDate(nuevaFecha.getDate() + diasParaAnadir);
            
            await userDoc.update({
                fechaExpiracionSuscripcion: firebase.firestore.Timestamp.fromDate(nuevaFecha),
                suscripcionActiva: true
            });
            
            showToast(`+${diasParaAnadir} días añadidos`, 'success');
            
            const userIndex = adminUserCache.findIndex(u => u.id === userId);
            if (userIndex !== -1) {
                adminUserCache[userIndex].fechaExpiracionSuscripcion = firebase.firestore.Timestamp.fromDate(nuevaFecha);
                adminUserCache[userIndex].suscripcionActiva = true;
                
                const searchInput = document.getElementById('adminSearch');
                const query = searchInput ? searchInput.value.toLowerCase().trim() : '';
                 const filtrados = adminUserCache.filter(user => 
                     user.rol !== 'admin' && 
                     (query === '' || (user.email && user.email.toLowerCase().includes(query)))
                 );
                renderizarListaUsuarios(filtrados);
            } else {
                 cargarDashboardAdmin();
            }
            
        } catch (error) {
            console.error("Error actualizando suscripción:", error);
            showToast(`Error: ${error.message}`, 'error');
        }
    }

    window.adminAlternarSuscripcion = async function(userId, nuevoEstado) {
         if (!db) return;
        const accion = nuevoEstado ? 'ACTIVAR' : 'DESACTIVAR';
        if (!confirm(`¿${accion} esta cuenta?`)) return;

        try {
            await db.collection('usuarios').doc(userId).update({
                suscripcionActiva: nuevoEstado
            });
            showToast(`Cuenta ${nuevoEstado ? 'Activada' : 'Desactivada'}`, 'success');
            
            const userIndex = adminUserCache.findIndex(u => u.id === userId);
            if (userIndex !== -1) {
                adminUserCache[userIndex].suscripcionActiva = nuevoEstado;
                
                 const searchInput = document.getElementById('adminSearch');
                const query = searchInput ? searchInput.value.toLowerCase().trim() : '';
                 const filtrados = adminUserCache.filter(user => 
                     user.rol !== 'admin' && 
                     (query === '' || (user.email && user.email.toLowerCase().includes(query)))
                 );
                renderizarListaUsuarios(filtrados);
            } else {
                 cargarDashboardAdmin(); 
            }
        } catch (error) {
            console.error(`Error al ${accion}:`, error);
            showToast(`Error: ${error.message}`, 'error');
        }
    }

    // Hacer función global para onclick en historial
    window.seleccionarComparacion = seleccionarComparacion;

    // ==== SCANNER ====
    async function iniciarScanner() {
        const videoElement = document.getElementById('videoElement');
        const scannerContainer = document.getElementById('scanner-container');
        if (!videoElement || !scannerContainer) return;

        detenerScanner(); 
        try {
            if (typeof screen.orientation?.lock === 'function') {
                 try { await screen.orientation.lock('landscape'); } catch (err) { console.warn("No se pudo bloquear orientación:", err); }
            }
            if (typeof ZXingBrowser === 'undefined' || !ZXingBrowser || !ZXingBrowser.BrowserMultiFormatReader) {
                 throw new Error('ZXingBrowser no cargado.');
            }
            const hints = new Map();
            const formats = [
                ZXingBrowser.BarcodeFormat.CODE_39, 
                ZXingBrowser.BarcodeFormat.CODE_128,
                ZXingBrowser.BarcodeFormat.DATA_MATRIX
            ];
             const hintType = ZXingBrowser.DecodeHintType ? ZXingBrowser.DecodeHintType.POSSIBLE_FORMATS : 1; 
             hints.set(hintType, formats);
              const tryHarderHint = ZXingBrowser.DecodeHintType ? ZXingBrowser.DecodeHintType.TRY_HARDER : 3; 
              hints.set(tryHarderHint, true);

            const constraints = {
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 }, 
                    height: { ideal: 720 } 
                }
            };
            codeReader = new ZXingBrowser.BrowserMultiFormatReader(hints, 500);
            
            scannerContainer.classList.remove('hidden');
            
            codeReader.decodeFromConstraints(constraints, videoElement, (result, err) => {
                if (result) {
                    console.log("VIN Scanned:", result.text);
                    if (navigator.vibrate) { navigator.vibrate(100); }
                    const vinInput = document.getElementById('vin');
                    if (vinInput) {
                         const potentialVin = result.text.toUpperCase().replace(/[^A-Z0-9]/g, '');
                         if (potentialVin.length >= 11 && potentialVin.length <= 17) {
                             vinInput.value = potentialVin.substring(0, 17);
                             handleVinInput.call(vinInput);
                             showToast('VIN Escaneado', 'success', 1500);
                             setTimeout(detenerScanner, 150);
                         } else {
                            console.warn("Código no parece VIN:", result.text);
                         }
                    }
                }
                if (err && !(err instanceof ZXingBrowser.NotFoundException)) {
                     console.error("Error durante escaneo:", err); 
                }
            }).catch(err => {
                console.error("Error al iniciar scanner:", err);
                handleScannerError(err);
                detenerScanner(); 
            });

            videoElement.addEventListener('loadedmetadata', async () => {
                if (videoElement.srcObject) {
                    const stream = videoElement.srcObject;
                    const track = stream.getVideoTracks()[0];
                    if (track && 'applyConstraints' in track) {
                         try {
                             const capabilities = track.getCapabilities();
                             if (capabilities.torch) {
                                  await track.applyConstraints({ advanced: [{ torch: true }] });
                                  console.log("Linterna encendida.");
                             }
                         } catch (torchErr) {
                            console.warn("No se pudo encender linterna:", torchErr);
                         }
                    }
                }
            });

        } catch (error) {
            console.error("Error en iniciarScanner:", error);
            handleScannerError(error);
            detenerScanner(); 
        }
    }

    function handleScannerError(error) {
        let errorMsg = `Error: ${error.message || 'Desconocido'}`;
        const errorName = error.name || '';

        if (errorName === 'NotAllowedError' || errorName === 'SecurityError') {
            errorMsg = "Permiso de cámara denegado.";
        } else if (errorName === 'NotFoundError' || errorName === 'DevicesNotFoundError') {
            errorMsg = "No se encontró cámara.";
        } else if (errorName === 'NotReadableError' || errorName === 'TrackStartError') {
            errorMsg = "Cámara en uso o error al iniciar.";
        } else if (errorName === 'OverconstrainedError' || errorName === 'ConstraintNotSatisfiedError') {
             errorMsg = "Cámara no soporta resolución.";
        } else if (errorName === 'AbortError') {
             errorMsg = "Inicio cancelado.";
        } else if (error.message && error.message.includes("ZXingBrowser")) {
             errorMsg = "Error al cargar librería de escaneo.";
        }
        
        showToast(`❌ ${errorMsg}`, 'error', 6000); 
        detenerScanner(); 
    }

    function detenerScanner() {
        const scannerContainer = document.getElementById('scanner-container');
        const videoElement = document.getElementById('videoElement');

         if (videoElement && videoElement.srcObject) {
              const stream = videoElement.srcObject;
              const track = stream.getVideoTracks()[0];
              if (track && 'applyConstraints' in track) {
                   const capabilities = track.getCapabilities();
                   if (capabilities.torch) {
                       track.applyConstraints({ advanced: [{ torch: false }] })
                           .then(() => console.log("Linterna apagada."))
                           .catch(e => console.warn("No se pudo apagar linterna:", e));
                   }
              }
         }

        if (codeReader) {
            try { 
                 codeReader.reset(); 
                 console.log("CodeReader reset.");
            } catch (resetError) { 
                 console.error("Error al resetear CodeReader:", resetError); 
            }
            codeReader = null;
        }
        
        if (videoElement && videoElement.srcObject) {
            try {
                videoElement.srcObject.getTracks().forEach(track => track.stop());
                console.log("Video tracks stopped.");
            } catch (e) { 
                 console.warn("Error al detener tracks:", e); 
            }
            videoElement.srcObject = null;
        }
        
        if (videoElement) {
            videoElement.pause();
            videoElement.removeAttribute('src'); 
        }
        
        if (scannerContainer) scannerContainer.classList.add('hidden');
        
        if (typeof screen.orientation?.unlock === 'function') {
            try { screen.orientation.unlock(); }
            catch (err) { console.warn("No se pudo desbloquear orientación:", err); }
        }
    }

    </script>
    
    <script>
      // Service Worker Registration
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('service-worker.js')
            .then(registration => { 
                console.log('✅ Service Worker registrado:', registration.scope); 
            })
            .catch(error => { 
                console.log('❌ Error al registrar Service Worker:', error); 
            });
        });
      }
    </script>
</body>
</html>
