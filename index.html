<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nacionalizaci√≥n CR">

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="icon-192.png">

    <title>C√°lculo de Impuestos con VIN</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@zxing/browser@latest/umd/zxing-browser.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        /* [!] TUS ESTILOS CSS COMPLETOS VAN AQU√ç (Sin cambios respecto a tu versi√≥n anterior) */
        /* ... (Aseg√∫rate de copiar todos tus estilos aqu√≠) ... */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(to bottom right, #e0f2fe, #e0e7ff); }
        .header { background: linear-gradient(135deg, #2563eb 0%, #4f46e5 100%); color: white; padding: 16px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .header-title { display: flex; align-items: center; gap: 8px; }
        .header-logo { width: 36px; height: 36px; }
        .header-title h1 { font-size: 18px; font-weight: bold; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.25); }
        .header-title p { font-size: 12px; color: #86efac; opacity: 1; }
        .header-buttons { display: flex; gap: 8px; }
        button { border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .btn-icon { background: rgba(255,255,255,0.2); color: white; width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .btn-icon:active { background: rgba(255,255,255,0.3); }
        .btn-header { background: rgba(255,255,255,0.2); color: white; width: auto; padding: 8px 12px; font-size: 12px; }
        .btn-header.active { background: #fbbf24; color: #1f2937; }
        .btn-secondary { background: #e5e7eb; color: #374151; padding: 12px; }
        .btn-secondary:active { background: #d1d5db; }
        .btn-primary { background: linear-gradient(135deg, #2563eb 0%, #4f46e5 100%); color: white; grid-column: 1 / -1; padding: 12px; }
        .btn-primary:disabled { background: #d1d5db; cursor: not-allowed; }
        .btn-result { background: rgba(255,255,255,0.2); color: white; padding: 12px; font-size: 12px; font-weight: 600; }
        .btn-result:active { background: rgba(255,255,255,0.3); }
        .btn-danger-light { background: #fee2e2; color: #dc2626; padding: 4px 8px; font-size: 11px; border-radius: 4px; }
        .btn-info-light { background: #dbeafe; color: #1e40af; padding: 12px; border-radius: 8px; }
        .btn-success-light { background: #dcfce7; color: #15803d; padding: 12px; border-radius: 8px; }
        .btn-update-tc { background: #dbeafe; color: #2563eb; font-size: 11px; padding: 6px 10px; font-weight: bold; }
        .btn-update-tc:active { background: #bfdbfe; }
        .container { max-width: 500px; margin: 0 auto; padding: 16px; }
        .card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .card-title { font-size: 16px; font-weight: bold; margin-bottom: 12px; color: #1f2937; }
        .form-group { margin-bottom: 12px; }
        .form-group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        label { display: block; font-size: 12px; font-weight: 600; color: #374151; }
        input { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; font-family: inherit; }
        input:focus { outline: none; border-color: #2563eb; background: #f0f9ff; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .help-text { font-size: 11px; color: #6b7280; margin-top: 4px; display: flex; align-items: center; gap: 6px;}
        .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
        .info-card { background-color: #eff6ff; border: 2px solid #93c5fd; padding: 12px; margin-top: 16px; }
        .info-card-title { font-size: 14px; font-weight: bold; color: #1e40af; margin-bottom: 10px; }
        .info-card .detail-row { padding: 8px 0; font-size: 14px; }
        .info-card .detail-label { color: #374151; }
        .info-card .detail-value { color: #1f2937; }
        .spinner { width: 14px; height: 14px; border: 2px solid #93c5fd; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .result-card { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; margin-bottom: 16px; padding: 16px; border-radius: 12px; }
        .result-amount { font-size: 32px; font-weight: bold; margin-bottom: 16px; }
        .result-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .detail-row { display: flex; justify-content: space-between; padding: 10px 0; font-size: 13px; border-bottom: 1px solid #e5e7eb; }
        .detail-row.subtotal { font-weight: bold; color: #1e40af; }
        .detail-label { color: #6b7280; }
        .detail-value { font-weight: 600; color: #1f2937; }
        .section-header { background: #dbeafe; color: #1e40af; padding: 8px 12px; border-radius: 6px; font-size: 11px; font-weight: bold; margin-top: 12px; margin-bottom: 8px; }
        .total-row { background: #f0fdf4; padding: 12px; border-radius: 6px; margin-top: 12px; font-weight: bold; display: flex; justify-content: space-between; font-size: 16px; }
        .comparison-card { background: white; border: 2px solid #93c5fd; border-radius: 8px; padding: 12px; margin-bottom: 12px; cursor: pointer; }
        .comparison-card:active { background: #eff6ff; border-color: #3b82f6; }
        .comparison-card.selected { border-color: #2563eb; background: #eff6ff; border-width: 3px; }
        .historial-vehicle-info { font-size: 13px; color: #4b5563; margin-top: 4px; font-weight: 500; }
        .hidden { display: none !important; }
        #scanner-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #videoElement { position: absolute; top: 50%; left: 50%; width: 100%; height: 100%; object-fit: cover; transform: translate(-50%, -50%); z-index: 201; }
        #scanner-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 202; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #scanner-viewfinder { width: 90%; max-width: 600px; height: 100px; position: relative; border: 2px solid rgba(255, 255, 255, 0.7); box-shadow: 0 0 0 9999px rgba(0,0,0,0.7); }
        .scanner-red-line { position: absolute; width: 100%; height: 2px; background: #dc2626; box-shadow: 0 0 8px #dc2626; top: 50%; transform: translateY(-50%); }
        .scanner-text { color: white; font-weight: 600; margin-top: 24px; font-size: 14px; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        #btnStopScan { margin-top: 24px; padding: 12px 24px; font-size: 16px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.5); z-index: 203; }
        #btnStopScan:active { background: rgba(255,255,255,0.3); }
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 8px; background: #2d3748; color: white; font-size: 14px; font-weight: 600; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); visibility: hidden; opacity: 0; transition: opacity 0.3s, visibility 0.3s, transform 0.3s; }
        #toast.show { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0); }
        #toast.success { background: #059669; }
        #toast.error   { background: #dc2626; }
        #toast.info    { background: #2563eb; }
        .collapsible-header { display: flex; justify-content: space-between; align-items: center; background: #f0f9ff; padding: 12px 16px; border-radius: 8px; margin-bottom: 12px; cursor: pointer; font-weight: bold; color: #1f2937; box-shadow: 0 1px 4px rgba(0,0,0,0.05); transition: background 0.2s ease-in-out; }
        .collapsible-header:hover { background: #e0f2fe; }
        .collapsible-header .arrow-icon { width: 18px; height: 18px; transition: transform 0.3s ease-in-out; }
        .collapsible-header.open .arrow-icon { transform: rotate(180deg); }
        .collapsible-content { overflow: hidden; max-height: 0; opacity: 0; transition: max-height 0.3s ease-out, opacity 0.3s ease-out; }
        .collapsible-content.open { max-height: 500px; opacity: 1; margin-bottom: 12px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-title">
            <img src="new-logo.png" alt="Logo" class="header-logo">
            <div><h1>Calculadora</h1><p>Importaci√≥n de Veh√≠culos</p></div>
        </div>
        <div class="header-buttons">
            <button class="btn-header" id="btnComparar">Compare</button>
            <button class="btn-header" id="btnHistorial">Historial</button>
        </div>
    </div>

    <div id="scanner-container" class="hidden">
        <video id="videoElement" playsinline></video>
        <div id="scanner-overlay">
             <div id="scanner-viewfinder"><div class="scanner-red-line"></div></div>
             <div class="scanner-text">Centre el c√≥digo de barras en la l√≠nea roja</div>
             <button id="btnStopScan">Cancelar</button>
        </div>
    </div>

    <div class="container">

        <div id="auth-section" class="card">
            <div id="login-form">
                <div class="card-title">Iniciar Sesi√≥n</div>
                <div class="form-group"><label for="loginEmail">Correo Electr√≥nico</label><input type="email" id="loginEmail" placeholder="usuario@ejemplo.com"></div>
                <div class="form-group"><label for="loginPassword">Contrase√±a</label><input type="password" id="loginPassword"></div>
                <button id="btnLogin" class="btn-primary" style="width: 100%;">Ingresar</button>
                <p id="loginError" style="color: red; font-size: 12px; margin-top: 8px; text-align: center; min-height: 16px;"></p>
            </div>
            <div id="create-account-form" style="border-top: 1px solid #e5e7eb; margin-top: 20px; padding-top: 20px;">
                 <div class="card-title">Crear Nueva Cuenta (Admin)</div>
                 <div class="form-group"><label for="createEmail">Correo Electr√≥nico Cliente</label><input type="email" id="createEmail" placeholder="cliente@ejemplo.com"></div>
                 <div class="form-group"><label for="createPassword">Contrase√±a Temporal</label><input type="password" id="createPassword"></div>
                 <button id="btnCreateAccount" class="btn-secondary" style="width: 100%;">Crear Cuenta</button>
                 <p id="createError" style="color: red; font-size: 12px; margin-top: 8px; text-align: center;"></p>
            </div>
        </div>
        <div id="app-content" style="display: none;">

            <div id="comparador" class="card hidden">
                <div class="card-title">Comparar Veh√≠culos</div>
                <div id="comparacionContent"></div>
            </div>

            <div id="historialCard" class="card hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div class="card-title" style="margin: 0;">Historial</div>
                    <button id="btnLimpiarHistorial" class="btn-danger-light">Limpiar</button>
                </div>
                <div id="historialContent"></div>
            </div>

            <div class="card"> <div class="card-title">Ingrese datos del Veh√≠culo</div>
                <div class="form-group">
                    <label for="vin">VIN Number</label>
                    <input type="text" id="vin" placeholder="Ej: 5FNRL6H73LB123456" maxlength="17" autocapitalize="characters">
                    <div class="help-text" id="vinStatus"></div>
                    <div class="button-group" style="margin-top: 8px;"><button id="btnScanVIN" class="btn-secondary">‚ïë‚ñå‚ïë Escanear VIN</button><button id="btnLimpiarVIN" class="btn-danger-light" style="padding: 12px;">Limpiar VIN</button></div>
                </div>
                <div class="form-group"><label for="ano">A√±o del Veh√≠culo</label><input type="number" id="ano" placeholder="2022" min="1980" inputmode="numeric"><div class="help-text" id="ayudaAno"></div></div>
                <div id="vinInfoCard" class="card info-card hidden">
                     <div class="card-title info-card-title">Informaci√≥n del Veh√≠culo</div>
                     <div class="detail-row"><span class="detail-label">Marca</span><span class="detail-value" id="vinMake"></span></div>
                     <div class="detail-row"><span class="detail-label">Modelo</span><span class="detail-value" id="vinModel"></span></div>
                     <div class="detail-row"><span class="detail-label">Versi√≥n</span><span class="detail-value" id="vinTrim"></span></div>
                     <div class="detail-row"><span class="detail-label">Motor</span><span class="detail-value" id="vinEngine"></span></div>
                     <div class="detail-row" style="border-bottom: none;"><span class="detail-label">Pa√≠s</span><span class="detail-value" id="vinCountry"></span></div>
                 </div>
                <hr style="border:none; border-top: 1px solid #e5e7eb; margin: 20px 0;">
                <div class="collapsible-header" data-target="collapsible-millaje">
                     <span>Convertidor de Distancia</span>
                     <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor"><path d="M207 416c11.3 0 22.1-4.3 30.2-12.3L400.2 248.2c12.1-12.1 12.1-31.7 0-43.8s-31.7-12.1-43.8 0L224 334.3 91.8 204.2c-12.1-12.1-31.7-12.1-43.8 0s-12.1 31.7 0 43.8L176.8 403.7c8.1 8 18.9 12.3 30.2 12.3z"/></svg>
                </div>
                 <div id="collapsible-millaje" class="collapsible-content">
                     <div class="form-group"><label for="millaje">Millaje / Kilometraje</label><input type="number" id="millaje" placeholder="30000" inputmode="numeric"><div class="help-text">El color indica si est√° sobre (rojo) o bajo (verde) el promedio para el a√±o del veh√≠culo.</div></div>
                     <div class="button-group"><button class="btn-secondary" id="btnMillasAKm">Millas a Kms</button><button class="btn-secondary" id="btnKmsAMillas">Kms a Millas</button></div>
                     <div id="millajeInfoCard" class="card info-card hidden" style="margin-top: 16px;">
                         <div class="card-title info-card-title">Resultado de Conversi√≥n</div>
                         <div class="detail-row"><span class="detail-label" id="millajeResultadoLabel"></span><span class="detail-value" id="millajeResultadoValor"></span></div>
                         <div class="detail-row" style="border-bottom: none;"><span class="detail-label" id="millajePromedioLabel"></span><span class="detail-value" id="millajePromedioValor"></span></div>
                         <div id="millajePromedioStatus" style="font-size: 12px; font-weight: bold; text-align: center; margin-top: 10px;"></div>
                     </div>
                     <hr style="border:none; border-top: 1px solid #e5e7eb; margin: 20px 0;">
                 </div>
                <div class="collapsible-header" data-target="collapsible-traspaso">
                     <span>C√°lculo de Traspaso</span>
                     <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor"><path d="M207 416c11.3 0 22.1-4.3 30.2-12.3L400.2 248.2c12.1-12.1 12.1-31.7 0-43.8s-31.7-12.1-43.8 0L224 334.3 91.8 204.2c-12.1-12.1-31.7-12.1-43.8 0s-12.1 31.7 0 43.8L176.8 403.7c8.1 8 18.9 12.3 30.2 12.3z"/></svg>
                 </div>
                 <div id="collapsible-traspaso" class="collapsible-content">
                     <div class="form-group"><label for="valorFiscal">Valor Fiscal (‚Ç°)</label><input type="number" id="valorFiscal" placeholder="10000000" inputmode="numeric"></div>
                     <button class="btn-primary" id="btnCalcularTraspaso" style="width: 100%;">Calcular Traspaso</button>
                     <div id="resultadoTraspaso" style="margin-top: 12px;"></div>
                     <hr style="border:none; border-top: 1px solid #e5e7eb; margin: 20px 0;">
                 </div>
                <div class="form-group"><label for="valor">Valor (USD)</label><input type="number" id="valor" placeholder="25000" inputmode="numeric"></div>
                <div class="form-group"><label for="flete">Flete (USD)</label><input type="number" id="flete" placeholder="1500" inputmode="numeric"></div>
                <div class="form-group">
                    <div class="form-group-header"><label for="tipoCambio">Tipo de Cambio (‚Ç°/USD)</label><button id="btnActualizarTC" class="btn-update-tc">Actualizar TC</button></div>
                    <input type="number" id="tipoCambio" placeholder="520" inputmode="numeric"><div class="help-text" id="tipoCambioHelp"></div>
                </div>
                <div class="button-group"><button class="btn-secondary" id="btnLimpiarFormulario">Limpiar</button><button class="btn-primary" id="btnCalcular">Calcular</button></div>
            </div> <div id="resultado" class="hidden">
                 <div class="result-card">...</div> <div id="detalle" class="card hidden">...</div>
             </div>
            <button id="btnLogout" class="btn-danger-light" style="width: 100%; padding: 12px; margin-top: 20px; font-size: 14px;">Cerrar Sesi√≥n</button>
        </div> <div style="text-align: center; font-size: 11px; color: #6b7280; margin-top: 20px; margin-bottom: 20px;"><p>TC Venta BCCR: <span id="tcFooter">N/A</span></p></div>

    </div> <div id="toast" class="toast"></div>

    <script>
        // ==== INICIO: CONFIGURACI√ìN E INICIALIZACI√ìN DE FIREBASE ====
        // ¬°¬°¬° ASEG√öRATE DE QUE ESTA ES TU √öNICA firebaseConfig !!!
        const firebaseConfig = {
          // üî•üî•üî• PEGA AQU√ç TU CONFIGURACI√ìN DE FIREBASE üî•üî•üî•
          apiKey: "AIzaSy...",
          authDomain: "...",
          projectId: "...",
          storageBucket: "...",
          messagingSenderId: "...",
          appId: "..."
        };
        // Inicializar Firebase (UNA SOLA VEZ)
        try {
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth(); // Objeto global para autenticaci√≥n
            const db = firebase.firestore(); // Objeto global para Firestore
            console.log("Firebase inicializado correctamente.");
        } catch (e) {
            console.error("Error inicializando Firebase:", e);
            // Mostrar un error al usuario si Firebase no carga
             const loginError = document.getElementById('loginError');
             if(loginError) loginError.textContent = 'Error al cargar servicios. Refresca la p√°gina.';
        }
        // ==== FIN: CONFIGURACI√ìN E INICIALIZACI√ìN DE FIREBASE ====


        // --- VARIABLES GLOBALES Y CONSTANTES --- (Definidas fuera de DOMContentLoaded)
        let historial = JSON.parse(localStorage.getItem('impuestosHistorial')) || [];
        let modoComparacion = false;
        let vehiculosSeleccionados = new Set();
        let calculoActual = null;
        let vinDecodeTimeout;
        let codeReader = null;
        let toastTimeout;
        let currentVinInfo = { make: '', model: '', year: '' };
        const anoActual = new Date().getFullYear();
        const COSTOS_FIJOS = { SEGURO_1: 0.011, SEGURO_2: 0.007, PAPELEO_USA: 250, DECLARACION_CR: 106000, DEKRA: 45000, ALMACENAMIENTO: 65000 };
        const MILLAS_POR_KM = 0.621371;
        const KM_POR_MILLA = 1.60934;
        const PROMEDIO_MILLAS_ANO = 15000;
        const PROMEDIO_KMS_ANO = 17000;
        const PORCENTAJE_TIMBRES = 0.035;
        const HONORARIOS_TRASPASO = 65000;

        // --- MANEJO DE EVENTOS ---
        // Esperar a que TODO el HTML est√© listo antes de buscar elementos y a√±adir listeners
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM completamente cargado y parseado. Adjuntando listeners...");

            try { // Envolver en try-catch por si acaso
                // Listeners originales
                document.getElementById('ano').addEventListener('change', validarAno);
                document.getElementById('ano').addEventListener('input', validarInicioAno);
                document.getElementById('vin').addEventListener('input', handleVinInput);
                document.getElementById('btnCalcular').addEventListener('click', calcular);
                document.getElementById('btnLimpiarFormulario').addEventListener('click', limpiarFormulario);
                document.getElementById('btnLimpiarVIN').addEventListener('click', limpiarVIN);
                document.getElementById('btnVerDetalle').addEventListener('click', mostrarDetalle);
                document.getElementById('btnGuardarHistorial').addEventListener('click', guardarHistorial);
                document.getElementById('btnDescargar').addEventListener('click', descargarPDF);
                document.getElementById('btnWhatsApp').addEventListener('click', enviarWhatsApp);
                document.getElementById('btnHistorial').addEventListener('click', toggleHistorial);
                document.getElementById('btnLimpiarHistorial').addEventListener('click', limpiarHistorial);
                document.getElementById('btnComparar').addEventListener('click', toggleComparacion);
                document.getElementById('btnActualizarTC').addEventListener('click', fetchTipoDeCambio);
                document.getElementById('btnMillasAKm').addEventListener('click', convertirMillaje);
                document.getElementById('btnKmsAMillas').addEventListener('click', convertirMillaje);
                document.getElementById('btnCalcularTraspaso').addEventListener('click', calcularTraspaso);
                document.getElementById('btnScanVIN').addEventListener('click', iniciarScanner);
                document.getElementById('btnStopScan').addEventListener('click', detenerScanner);

                // Listeners Auth con VERIFICACI√ìN EXPL√çCITA
                const btnLogin = document.getElementById('btnLogin');
                if (btnLogin) { btnLogin.addEventListener('click', iniciarSesion); console.log("Listener a√±adido a btnLogin."); }
                else { console.error("¬°ERROR! No se encontr√≥ el elemento #btnLogin."); }

                const btnCreate = document.getElementById('btnCreateAccount');
                if (btnCreate) { btnCreate.addEventListener('click', crearCuenta); console.log("Listener a√±adido a btnCreateAccount."); }
                else { console.warn("Elemento #btnCreateAccount no encontrado (¬øFormulario admin oculto?)."); }

                const btnLogout = document.getElementById('btnLogout');
                if (btnLogout) { btnLogout.addEventListener('click', cerrarSesion); console.log("Listener a√±adido a btnLogout."); }
                else { console.error("¬°ERROR! No se encontr√≥ el elemento #btnLogout."); }

                // Listeners Colapsables
                document.querySelectorAll('.collapsible-header').forEach(header => {
                    header.addEventListener('click', () => {
                        const targetId = header.dataset.target;
                        const content = document.getElementById(targetId);
                        if (content) {
                            header.classList.toggle('open');
                            content.classList.toggle('open');
                            if (content.classList.contains('open')) {
                                setTimeout(() => content.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 300);
                            }
                        }
                    });
                });

                // Configuraci√≥n inicial que depende del DOM
                document.getElementById('ano').max = anoActual + 1;
                actualizarHistorialUI(); // Actualizar UI del historial si hay datos
                fetchTipoDeCambio(); // Cargar tipo de cambio inicial
                console.log("Listeners y configuraci√≥n inicial completados.");

            } catch (error) {
                console.error("Error al adjuntar listeners o configuraci√≥n inicial:", error);
                 const loginError = document.getElementById('loginError');
                 if(loginError) loginError.textContent = 'Error al iniciar la app. Refresca.';
            }

        }); // FIN DEL DOMContentLoaded

        // --- FUNCIONES DE AUTENTICACI√ìN --- (Definidas fuera de DOMContentLoaded)
        function crearCuenta() {
            // ... (C√≥digo de crearCuenta sin cambios) ...
             const email = document.getElementById('createEmail').value;
             const password = document.getElementById('createPassword').value;
             const errorElement = document.getElementById('createError');
             errorElement.textContent = '';
             if (!email || !password) { errorElement.textContent = 'Ingresa correo y contrase√±a.'; return; }

             auth.createUserWithEmailAndPassword(email, password)
                 .then((userCredential) => {
                     const user = userCredential.user;
                     console.log('Cuenta creada en Auth:', user.uid, user.email);
                     const userDocRef = db.collection('usuarios').doc(user.uid);
                     return userDocRef.set({
                         email: user.email,
                         suscripcionActiva: true,
                         fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
                         metodoPago: 'manual_sinpe'
                     });
                 })
                 .then(() => {
                     console.log("Documento de usuario creado en Firestore.");
                     showToast(`‚úÖ Cuenta creada y activada para ${email}`, 'success');
                     document.getElementById('createEmail').value = '';
                     document.getElementById('createPassword').value = '';
                 })
                 .catch((error) => {
                     console.error("Error al crear cuenta o doc Firestore:", error);
                     if (error.code === 'auth/email-already-in-use') { errorElement.textContent = 'Este correo ya est√° registrado.'; }
                     else if (error.code === 'auth/weak-password'){ errorElement.textContent = 'La contrase√±a debe tener al menos 6 caracteres.'; }
                     else { errorElement.textContent = `Error: ${error.message}`; }
                     showToast(`‚ùå Error al crear cuenta`, 'error');
                 });
        }

        function iniciarSesion() {
            // ... (C√≥digo de iniciarSesion sin cambios) ...
             const email = document.getElementById('loginEmail').value;
             const password = document.getElementById('loginPassword').value;
             const errorElement = document.getElementById('loginError');
             errorElement.textContent = 'Verificando...';
             if (!email || !password) { errorElement.textContent = 'Ingresa correo y contrase√±a.'; return; }

             auth.signInWithEmailAndPassword(email, password)
                 .then((userCredential) => { console.log('Usuario inici√≥ sesi√≥n:', userCredential.user.email); })
                 .catch((error) => {
                     console.error("Error al iniciar sesi√≥n:", error);
                     if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') { errorElement.textContent = 'Correo o contrase√±a incorrectos.'; }
                     else { errorElement.textContent = `Error: ${error.message}`; }
                 });
        }

        function cerrarSesion() {
            // ... (C√≥digo de cerrarSesion sin cambios) ...
             auth.signOut().catch((error) => {
                 console.error('Error al cerrar sesi√≥n:', error);
                 showToast('Error al cerrar sesi√≥n', 'error');
             });
        }

        // --- GESTI√ìN DEL ESTADO DE AUTENTICACI√ìN Y SUSCRIPCI√ìN --- (Definida fuera, pero interact√∫a con DOM)
        // Es importante que esta funci√≥n exista antes de que `DOMContentLoaded` termine
         if (typeof auth !== 'undefined') { // Solo adjuntar si Firebase Auth se inicializ√≥
             auth.onAuthStateChanged((user) => {
                 const authSection = document.getElementById('auth-section');
                 const appContent = document.getElementById('app-content');
                 const loginError = document.getElementById('loginError');

                 // Asegurarse de que los elementos existan antes de manipularlos
                 if (!authSection || !appContent || !loginError) {
                     console.error("Elementos de UI (auth/app) no encontrados en onAuthStateChanged");
                     return;
                 }


                 if (user) { // Usuario logueado en Auth
                     console.log('Estado: Logueado como', user.email, user.uid);
                     loginError.textContent = 'Verificando suscripci√≥n...';
                     const userDocRef = db.collection('usuarios').doc(user.uid);

                     userDocRef.get().then((doc) => {
                         if (doc.exists && doc.data().suscripcionActiva === true) {
                             console.log("Suscripci√≥n activa encontrada.");
                             authSection.style.display = 'none';
                             appContent.style.display = 'block';
                             loginError.textContent = '';
                         } else {
                             console.log("Suscripci√≥n no activa o documento no encontrado.");
                             authSection.style.display = 'block';
                             appContent.style.display = 'none';
                             loginError.textContent = 'Necesitas una suscripci√≥n activa para usar la app.';
                             // auth.signOut(); // Descomentar si quieres desloguear autom√°ticamente
                         }
                     }).catch((error) => {
                         console.error("Error al obtener datos de Firestore:", error);
                         authSection.style.display = 'block';
                         appContent.style.display = 'none';
                         loginError.textContent = 'Error al verificar suscripci√≥n. Intenta de nuevo.';
                         // auth.signOut(); // Descomentar si quieres desloguear autom√°ticamente
                     });
                 } else { // Usuario DESLOGUEADO
                     console.log('Estado: Deslogueado');
                     authSection.style.display = 'block';
                     appContent.style.display = 'none';
                     loginError.textContent = '';
                     // Llamar a limpiarFormulario solo si appContent era visible podr√≠a ser m√°s seguro
                     // if (appContent.style.display === 'block') { limpiarFormulario(); }
                 }
             });
         } else {
             console.error("Firebase Auth no est√° definido. No se puede adjuntar onAuthStateChanged.");
             // Mostrar error al usuario
             const loginError = document.getElementById('loginError');
             if(loginError) loginError.textContent = 'Error al cargar sistema de autenticaci√≥n.';
         }


        // --- OTRAS FUNCIONES (Formato, Toast, Validaciones, C√°lculo, etc.) ---
        // [!] ASEG√öRATE DE QUE TODAS TUS FUNCIONES ORIGINALES EST√âN AQU√ç, UNA SOLA VEZ
        function formatUSD(num) { return '$' + Math.round(num).toLocaleString('en-US'); }
        function formatCRC(num) { return '‚Ç°' + Math.round(num).toLocaleString('es-CR'); }
        function showToast(message, type = 'info', duration = 3000) { /* ... */ }
        function validarInicioAno() { /* ... */ }
        function validarAno() { /* ... */ }
        function calcular() { /* ... */ }
        function mostrarDetalle() { /* ... */ }
        function convertirMillaje(event) { /* ... */ }
        function calcularTraspaso() { /* ... */ }
        function guardarHistorial() { /* ... */ }
        function actualizarHistorialUI() { /* ... */ }
        function seleccionarComparacion(id) { /* ... */ }
        function mostrarComparacion() { /* ... */ }
        function toggleComparacion() { /* ... */ }
        function toggleHistorial() { /* ... */ }
        function limpiarHistorial() { /* ... */ }
        function handleVinInput() { /* ... */ }
        async function fetchVinData(vin) { /* ... */ }
        async function fetchTipoDeCambio() { /* ... */ }
        function displayVinData(data) { /* ... */ }
        function generarTextoDesglose(esParaWhatsapp = false) { /* ... */ }
        function descargarPDF() { /* ... */ }
        function enviarWhatsApp() { /* ... */ }
        function limpiarFichaVIN() { /* ... */ }
        function limpiarFormulario() { /* ... (c√≥digo ajustado para seguridad) */ }
        function limpiarVIN() { /* ... (c√≥digo ajustado para seguridad) */ }
        async function iniciarScanner() { /* ... */ }
        function handleScannerError(error) { /* ... */ }
        function detenerScanner() { /* ... */ }

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('service-worker.js')
            .then(registration => { console.log('Service Worker registrado:', registration.scope); })
            .catch(error => { console.log('Error al registrar Service Worker:', error); });
        });
      }
    </script>
</body>
</html>
