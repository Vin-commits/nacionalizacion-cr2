<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nacionalizaci√≥n CR">
    <title>C√°lculo de Impuestos con VIN</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@zxing/browser@latest/umd/zxing-browser.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(to bottom right, #e0f2fe, #e0e7ff); }
        .header { background: linear-gradient(135deg, #2563eb 0%, #4f46e5 100%); color: white; padding: 16px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .header-title { display: flex; align-items: center; gap: 8px; }
        .header-logo { width: 36px; height: 36px; }
        .header-title h1 {
            font-size: 18px;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.25);
        }
        .header-title p {
            font-size: 12px;
            color: #fecdd3;
            opacity: 1;
        }
        .header-buttons { display: flex; gap: 8px; }
        button { border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }

        .btn-icon { background: rgba(255,255,255,0.2); color: white; width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .btn-icon:active { background: rgba(255,255,255,0.3); }

        .btn-header { background: rgba(255,255,255,0.2); color: white; width: auto; padding: 8px 12px; font-size: 12px; }
        .btn-header.active { background: #fbbf24; color: #1f2937; }

        .btn-secondary { background: #e5e7eb; color: #374151; padding: 12px; }
        .btn-secondary:active { background: #d1d5db; }

        .btn-primary { background: linear-gradient(135deg, #2563eb 0%, #4f46e5 100%); color: white; grid-column: 1 / -1; padding: 12px; }
        .btn-primary:disabled { background: #d1d5db; cursor: not-allowed; }

        .btn-result { background: rgba(255,255,255,0.2); color: white; padding: 12px; font-size: 12px; font-weight: 600; }
        .btn-result:active { background: rgba(255,255,255,0.3); }

        .btn-danger-light { background: #fee2e2; color: #dc2626; padding: 4px 8px; font-size: 11px; border-radius: 4px; }
        .btn-info-light { background: #dbeafe; color: #1e40af; padding: 12px; border-radius: 8px; }
        .btn-success-light { background: #dcfce7; color: #15803d; padding: 12px; border-radius: 8px; }
        .btn-update-tc { background: #dbeafe; color: #2563eb; font-size: 11px; padding: 6px 10px; font-weight: bold; }
        .btn-update-tc:active { background: #bfdbfe; }

        .container { max-width: 500px; margin: 0 auto; padding: 16px; }
        .card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .card-title { font-size: 16px; font-weight: bold; margin-bottom: 12px; color: #1f2937; }

        .form-group { margin-bottom: 12px; }
        .form-group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        label { display: block; font-size: 12px; font-weight: 600; color: #374151; }
        input { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; font-family: inherit; }
        input:focus { outline: none; border-color: #2563eb; background: #f0f9ff; }
        .help-text { font-size: 11px; color: #6b7280; margin-top: 4px; display: flex; align-items: center; gap: 6px;}
        .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }

        .info-card { background-color: #eff6ff; border: 2px solid #93c5fd; padding: 12px; margin-top: 16px; }
        .info-card-title { font-size: 14px; font-weight: bold; color: #1e40af; margin-bottom: 10px; }
        .info-card .detail-row { padding: 8px 0; font-size: 14px; }
        .info-card .detail-label { color: #374151; }
        .info-card .detail-value { color: #1f2937; }

        .spinner {
            width: 14px; height: 14px;
            border: 2px solid #93c5fd; border-top-color: #3b82f6;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .result-card { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; margin-bottom: 16px; padding: 16px; border-radius: 12px; }
        .result-amount { font-size: 32px; font-weight: bold; margin-bottom: 16px; }
        .result-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

        .detail-row { display: flex; justify-content: space-between; padding: 10px 0; font-size: 13px; border-bottom: 1px solid #e5e7eb; }
        .detail-row.subtotal { font-weight: bold; color: #1e40af; }
        .detail-label { color: #6b7280; }
        .detail-value { font-weight: 600; color: #1f2937; }
        .section-header { background: #dbeafe; color: #1e40af; padding: 8px 12px; border-radius: 6px; font-size: 11px; font-weight: bold; margin-top: 12px; margin-bottom: 8px; }
        .total-row { background: #f0fdf4; padding: 12px; border-radius: 6px; margin-top: 12px; font-weight: bold; display: flex; justify-content: space-between; font-size: 16px; }

        .comparison-card { background: white; border: 2px solid #93c5fd; border-radius: 8px; padding: 12px; margin-bottom: 12px; cursor: pointer; }
        .comparison-card:active { background: #eff6ff; border-color: #3b82f6; }
        .comparison-card.selected { border-color: #2563eb; background: #eff6ff; border-width: 3px; }

        .hidden { display: none !important; }

        #scanner-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #videoElement {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: translate(-50%, -50%);
            z-index: 201;
        }
        #scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 202;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #scanner-viewfinder {
            width: 90%;
            max-width: 600px;
            height: 100px;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.7);
        }
        .scanner-red-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #dc2626;
            box-shadow: 0 0 8px #dc2626;
            top: 50%;
            transform: translateY(-50%);
        }
        .scanner-text {
            color: white;
            font-weight: 600;
            margin-top: 24px;
            font-size: 14px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        #btnStopScan {
            margin-top: 24px;
            padding: 12px 24px;
            font-size: 16px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.5);
            z-index: 203;
        }
        #btnStopScan:active {
            background: rgba(255,255,255,0.3);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="white" class="header-logo">
                <path d="M136.1,234.4c-15,0-27.2,12.2-27.2,27.2s12.2,27.2,27.2,27.2s27.2-12.2,27.2-27.2S151.1,234.4,136.1,234.4z M375.9,234.4
                c-15,0-27.2,12.2-27.2,27.2s12.2,27.2,27.2,27.2s27.2-12.2,27.2-27.2S390.9,234.4,375.9,234.4z M464,176H48c-23.2,0-41,14.3-46.8,34.4
                c-2.4,8.2-3.1,16.7-2.9,25.2v122.3c0,23.3,18.9,42.2,42.2,42.2H96v21.1c0,11.7,9.5,21.1,21.1,21.1h21.1c11.7,0,21.1-9.5,21.1-21.1
                v-21.1h192v21.1c0,11.7,9.5,21.1,21.1,21.1h21.1c11.7,0,21.1-9.5,21.1-21.1v-21.1h53.8c23.3,0,42.2-18.9,42.2-42.2V235.5
                c0.3-8.4-0.5-16.9-2.9-25.2C505,190.3,487.2,176,464,176z M144,304c-22.1,0-40-17.9-40-40s17.9-40,40-40s40,17.9,40,40S166.1,304,144,304
                z M368,304c-22.1,0-40-17.9-40-40s17.9-40,40-40s40,17.9,40,40S390.1,304,368,304z M488,235.5c-0.1,4.5-1.1,8.9-2.9,12.9
                c-4.3,9.5-13.4,15.6-23.7,15.6h-48.4c-6-30.8-32.1-53.5-63.5-56.1l48.6-48.6c3.3-3.3,3.3-8.6,0-11.8l-15.8-15.8
                c-3.3-3.3-8.6-3.3-11.8,0l-65,65.1c-1.3,1.3-2.3,2.8-2.9,4.4c-11.8-1.7-23.9-2.6-36.1-2.6s-24.3,0.9-36.1,2.6
                c-0.6-1.6-1.6-3.1-2.9-4.4l-65-65.1c-3.3-3.3-8.6-3.3-11.8,0l-15.8,15.8c-3.3-3.3-3.3,8.6,0,11.8l48.6,48.6
                c-31.4,2.6-57.5,25.3-63.5,56.1H48.5c-10.3,0-19.4-6.2-23.7-15.6c-1.9-4-2.8-8.4-2.9-12.9V235c0-0.2,0-0.3,0-0.5
                c0-8.5,3.4-16.7,9.4-22.6c6-6,14.1-9.4,22.6-9.4H464c8.5,0,16.6,3.4,22.6,9.4c6,6,9.4,14.1,9.4,22.6C488,235.1,488,235.3,488,235.5
                z"/>
            </svg>
            <div>
                <h1>C√°lculo de Impuestos</h1>
                <p>Importaci√≥n de Veh√≠culos</p>
            </div>
        </div>
        <div class="header-buttons">
            <button class="btn-header" id="btnComparar">Compare</button>
            <button class="btn-header" id="btnHistorial">Historial</button>
        </div>
    </div>

    <div id="scanner-container" class="hidden">
        <video id="videoElement" playsinline></video>
        <div id="scanner-overlay">
            <div id="scanner-viewfinder">
                <div class="scanner-red-line"></div>
            </div>
            <div class="scanner-text">Centre el c√≥digo de barras en la l√≠nea roja</div>
            <button id="btnStopScan">Cancelar</button>
        </div>
    </div>
    
    <div class="container">
        <div id="comparador" class="card hidden">
            <div class="card-title">Comparar Veh√≠culos</div>
            <div id="comparacionContent"></div>
        </div>

        <div id="historialCard" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div class="card-title" style="margin: 0;">Historial</div>
                <button id="btnLimpiarHistorial" class="btn-danger-light">Limpiar</button>
            </div>
            <div id="historialContent"></div>
        </div>

        <div class="card">
            <div class="card-title">Ingrese datos del Veh√≠culo</div>

            <div class="form-group">
                <label for="vin">VIN Number</label>
                <input type="text" id="vin" placeholder="Ej: 5FNRL6H73LB123456" maxlength="17" autocapitalize="characters">
                <div class="help-text" id="vinStatus"></div>

                <div class="button-group" style="margin-top: 8px;">
                    <button id="btnScanVIN" class="btn-secondary">üì∏ Escanear VIN</button>
                    <button id="btnLimpiarVIN" class="btn-danger-light" style="padding: 12px;">Limpiar VIN</button>
                </div>
            </div>

            <div class="form-group">
                <label for="ano">A√±o del Veh√≠culo</label>
                <input type="number" id="ano" placeholder="2022" min="1980">
                <div class="help-text" id="ayudaAno"></div>
            </div>

            <div id="vinInfoCard" class="card info-card hidden">
                <div class="card-title info-card-title">Informaci√≥n del Veh√≠culo</div>
                <div class="detail-row"><span class="detail-label">Marca</span><span class="detail-value" id="vinMake"></span></div>
                <div class="detail-row"><span class="detail-label">Modelo</span><span class="detail-value" id="vinModel"></span></div>
                <div class="detail-row"><span class="detail-label">Versi√≥n</span><span class="detail-value" id="vinTrim"></span></div>
                <div class="detail-row"><span class="detail-label">Motor</span><span class="detail-value" id="vinEngine"></span></div>
                <div class="detail-row" style="border-bottom: none;"><span class="detail-label">Pa√≠s</span><span class="detail-value" id="vinCountry"></span></div>
            </div>

            <hr style="border:none; border-top: 1px solid #e5e7eb; margin: 20px 0;">

            <div class="card-title" style="font-size: 14px; margin-bottom: 8px;">Convertidor de Distancia</div>
            <div class="form-group">
                <label for="millaje">Millaje / Kilometraje</label>
                <input type="number" id="millaje" placeholder="30000">
                <div class="help-text">El color indica si est√° sobre (rojo) o bajo (verde) el promedio para el a√±o del veh√≠culo.</div>
            </div>
            <div class="button-group">
                <button class="btn-secondary" id="btnMillasAKm">Millas a Kms</button>
                <button class="btn-secondary" id="btnKmsAMillas">Kms a Millas</button>
            </div>

            <div id="millajeInfoCard" class="card info-card hidden" style="margin-top: 16px;">
                <div class="card-title info-card-title">Resultado de Conversi√≥n</div>
                <div class="detail-row">
                    <span class="detail-label" id="millajeResultadoLabel"></span>
                    <span class="detail-value" id="millajeResultadoValor"></span>
                </div>
                <div class="detail-row" style="border-bottom: none;">
                    <span class="detail-label" id="millajePromedioLabel"></span>
                    <span class="detail-value" id="millajePromedioValor"></span>
                </div>
                <div id="millajePromedioStatus" style="font-size: 12px; font-weight: bold; text-align: center; margin-top: 10px;"></div>
            </div>

            <hr style="border:none; border-top: 1px solid #e5e7eb; margin: 20px 0;">

            <div class="card-title" style="font-size: 14px; margin-bottom: 8px;">Herramienta: C√°lculo de Traspaso</div>
            <div class="form-group">
                <label for="valorFiscal">Valor Fiscal (‚Ç°)</label>
                <input type="number" id="valorFiscal" placeholder="10000000">
            </div>
            <button class="btn-primary" id="btnCalcularTraspaso" style="width: 100%;">Calcular Traspaso</button>
            <div id="resultadoTraspaso" style="margin-top: 12px;"></div>

            <hr style="border:none; border-top: 1px solid #e5e7eb; margin: 20px 0;">
            <div class="form-group">
                <label for="valor">Valor (USD)</label>
                <input type="number" id="valor" placeholder="25000">
            </div>

            <div class="form-group">
                <label for="flete">Flete (USD)</label>
                <input type="number" id="flete" placeholder="1500">
            </div>

            <div class="form-group">
                <div class="form-group-header">
                    <label for="tipoCambio">Tipo de Cambio (‚Ç°/USD)</label>
                    <button id="btnActualizarTC" class="btn-update-tc">Actualizar TC</button>
                </div>
                <input type="number" id="tipoCambio" placeholder="520">
                <div class="help-text" id="tipoCambioHelp"></div>
            </div>

            <div class="button-group">
                <button class="btn-secondary" id="btnLimpiarFormulario">Limpiar</button>
                <button class="btn-primary" id="btnCalcular">Calcular</button>
            </div>
        </div>

        <div id="resultado" class="hidden">
            <div class="result-card">
                <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;">COSTO TOTAL</div>
                <div class="result-amount" id="resultadoTotal"></div>
                <div class="result-buttons">
                    <button class="btn-result" id="btnVerDetalle">Ver Detalle</button>
                    <button class="btn-result" id="btnGuardarHistorial">Guardar</button>
                </div>
            </div>

            <div id="detalle" class="card hidden">
                <div class="card-title">Desglose</div>
                <div id="detalleContent"></div>
                <div class="button-group" style="margin-top: 16px;">
                    <button id="btnDescargar" class="btn-info-light">Exportar (PDF)</button>
                    <button id="btnWhatsApp" class="btn-success-light">WhatsApp</button>
                </div>
            </div>
        </div>

        <div style="text-align: center; font-size: 11px; color: #6b7280; margin-top: 20px; margin-bottom: 20px;">
            <p>TC Venta BCCR: <span id="tcFooter">N/A</span></p>
        </div>
    </div>

    <script>
        // ==========================================
        // VARIABLES GLOBALES Y CONSTANTES
        // ==========================================
        let historial = JSON.parse(localStorage.getItem('impuestosHistorial')) || [];
        let modoComparacion = false;
        let vehiculosSeleccionados = new Set();
        let calculoActual = null;
        let vinDecodeTimeout;
        let codeReader = null;

        const anoActual = new Date().getFullYear();

        const COSTOS_FIJOS = {
            SEGURO_1: 0.011, 
            SEGURO_2: 0.007, 
            PAPELEO_USA: 250,
            DECLARACION_CR: 106000, 
            DEKRA: 45000, 
            ALMACENAMIENTO: 65000
        };

        const MILLAS_POR_KM = 0.621371;
        const KM_POR_MILLA = 1.60934;
        const PROMEDIO_MILLAS_ANO = 15000;
        const PROMEDIO_KMS_ANO = 17000;
        const PORCENTAJE_TIMBRES = 0.035;
        const HONORARIOS_TRASPASO = 65000;

        // ==========================================
        // FUNCIONES DE FORMATO
        // ==========================================
        function formatUSD(num) { 
            return '$' + Math.round(num).toLocaleString('en-US'); 
        }
        
        function formatCRC(num) { 
            return '‚Ç°' + Math.round(num).toLocaleString('es-CR'); 
        }

        // ==========================================
        // MANEJO DE VIN - NUEVA IMPLEMENTACI√ìN
        // ==========================================
        function procesarVIN() {
            const vinInput = document.getElementById('vin');
            const vinStatus = document.getElementById('vinStatus');
            const vin = vinInput.value.toUpperCase().trim();
            
            clearTimeout(vinDecodeTimeout);
            limpiarFichaVIN();

            if (vin.length === 0) {
                vinStatus.innerHTML = '';
                return;
            }

            if (vin.length < 17) {
                vinStatus.innerHTML = `<span>VIN debe tener 17 caracteres (${vin.length}/17)</span>`;
                return;
            }

            if (vin.length === 17) {
                vinStatus.innerHTML = `<div class="spinner"></div><span>Decodificando VIN...</span>`;
                vinDecodeTimeout = setTimeout(() => {
                    fetchVinData(vin);
                }, 500);
            }
        }

        async function fetchVinData(vin) {
            const vinStatus = document.getElementById('vinStatus');
            try {
                const apiUrl = `https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVinValues/${vin}?format=json`;
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`Error de red (${response.status})`);
                }
                
                const data = await response.json();

                if (data && data.Results && data.Results[0]) {
                    const vehicleInfo = data.Results[0];
                    
                    if (vehicleInfo.ErrorCode === "0" && vehicleInfo.Make && vehicleInfo.Model) {
                        vinStatus.innerHTML = '<span style="color: #059669;">‚úì VIN decodificado</span>';
                        displayVinData(vehicleInfo);
                        
                        if (vehicleInfo.ModelYear) {
                            const anoInput = document.getElementById('ano');
                            anoInput.value = vehicleInfo.ModelYear;
                            validarAno();
                        }
                    } else {
                        vinStatus.innerHTML = `<span style="color: #dc2626;">Error: ${vehicleInfo.ErrorText || "VIN no encontrado o inv√°lido"}</span>`;
                        limpiarFichaVIN();
                    }
                } else {
                    throw new Error("Formato de respuesta inesperado");
                }
            } catch (error) {
                console.error('Error fetching VIN data:', error);
                vinStatus.innerHTML = `<span style="color: #dc2626;">Error al decodificar: ${error.message}</span>`;
                limpiarFichaVIN();
            }
        }

        function displayVinData(data) {
            let engineInfo = data.EngineCylinders ? `${data.EngineCylinders} Cilindros` : '';
            if (data.DisplacementL) engineInfo += ` ${data.DisplacementL}L`;
            
            document.getElementById('vinMake').textContent = data.Make || 'N/D';
            document.getElementById('vinModel').textContent = data.Model || 'N/D';
            document.getElementById('vinTrim').textContent = data.Trim || 'N/D';
            document.getElementById('vinEngine').textContent = engineInfo.trim() || 'N/D';
            document.getElementById('vinCountry').textContent = data.PlantCountry || 'N/D';
            document.getElementById('vinInfoCard').classList.remove('hidden');
        }

        function limpiarFichaVIN() { 
            document.getElementById('vinInfoCard').classList.add('hidden'); 
        }

        function limpiarVIN() {
            const vinInput = document.getElementById('vin');
            vinInput.value = '';
            document.getElementById('vinStatus').innerHTML = '';
            limpiarFichaVIN();
        }

        // ==========================================
        // VALIDACI√ìN DE A√ëO
        // ==========================================
        function validarAno() {
            const anoInput = document.getElementById('ano');
            const ayudaAno = document.getElementById('ayudaAno');
            const ano = parseInt(anoInput.value);
            
            if (!ano || ano < 1980 || ano > anoActual + 1) {
                ayudaAno.textContent = 'A√±o inv√°lido';
                return;
            }
            
            const antiguedad = anoActual - ano
