<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nacionalizaci√≥n CR">
    <meta name="theme-color" content="#2563eb">
    <title>Nacionalizaci√≥n CR</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(to bottom right, #e0f2fe, #e0e7ff); }
        .header { background: linear-gradient(135deg, #2563eb 0%, #4f46e5 100%); color: white; padding: 16px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; }
        .header-title { display: flex; align-items: center; gap: 8px; }
        .header-title h1 { font-size: 18px; font-weight: bold; }
        .header-title p { font-size: 12px; opacity: 0.9; }
        .header-buttons { display: flex; gap: 8px; }
        button { border: none; border-radius: 8px; padding: 8px 12px; font-size: 12px; cursor: pointer; font-weight: 600; background: #e5e7eb; color: #374151; }
        .btn-icon { background: rgba(255,255,255,0.2); color: white; width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .btn-icon:active { background: rgba(255,255,255,0.3); }
        .btn-icon.active { background: #fbbf24; color: #1f2937; }
        .container { max-width: 500px; margin: 0 auto; padding: 16px; }
        .card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .card-title { font-size: 16px; font-weight: bold; margin-bottom: 12px; color: #1f2937; }
        .form-group { margin-bottom: 12px; }
        label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: #374151; }
        input { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; font-family: inherit; }
        input:focus { outline: none; border-color: #2563eb; background: #f0f9ff; }
        .help-text { font-size: 11px; color: #6b7280; margin-top: 4px; }
        .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
        .btn-secondary { background: #e5e7eb; color: #374151; padding: 12px; }
        .btn-secondary:active { background: #d1d5db; }
        .btn-primary { background: linear-gradient(135deg, #2563eb 0%, #4f46e5 100%); color: white; grid-column: 1 / -1; padding: 12px; }
        .btn-primary:disabled { background: #d1d5db; color: #9ca3af; cursor: not-allowed; }
        .result-card { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; margin-bottom: 16px; }
        .result-amount { font-size: 28px; font-weight: bold; margin-bottom: 12px; }
        .result-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn-result { background: rgba(255,255,255,0.2); color: white; padding: 10px; font-size: 12px; }
        .btn-result:active { background: rgba(255,255,255,0.3); }
        .detail-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 13px; border-bottom: 1px solid #e5e7eb; }
        .detail-label { color: #6b7280; }
        .detail-value { font-weight: 600; color: #1f2937; }
        .section-header { background: #dbeafe; color: #1e40af; padding: 8px 12px; border-radius: 6px; font-size: 12px; font-weight: bold; margin-bottom: 8px; }
        .detail-row.highlight { background: white; padding: 12px; border-radius: 4px; font-weight: bold; }
        .hidden { display: none !important; }
        .comparison-card { background: white; border: 2px solid #93c5fd; border-radius: 8px; padding: 12px; margin-bottom: 12px; cursor: pointer; }
        .comparison-card:active { background: #eff6ff; border-color: #3b82f6; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-title">
            <div style="font-size: 20px;">üöó</div>
            <div>
                <h1>Nacionalizaci√≥n CR</h1>
                <p>Calculadora de Veh√≠culos</p>
            </div>
        </div>
        <div class="header-buttons">
            <button class="btn-icon" id="btnComparar" onclick="toggleComparacion()">‚öñÔ∏è</button>
            <button class="btn-icon" id="btnHistorial" onclick="toggleHistorial()">‚è±Ô∏è</button>
        </div>
    </div>

    <div class="container">
        <div id="comparador" class="card hidden">
            <div class="card-title">‚öñÔ∏è Comparaci√≥n</div>
            <div id="comparacionContent"></div>
        </div>

        <div id="historialCard" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div class="card-title" style="margin: 0;">Historial</div>
                <button onclick="limpiarHistorial()" style="background: #fee2e2; color: #dc2626; padding: 4px 8px; font-size: 11px;">üóëÔ∏è</button>
            </div>
            <div id="historialContent"></div>
        </div>

        <div class="card">
            <div class="card-title">üìã Datos del Veh√≠culo</div>
            
            <div class="form-group">
                <label>A√±o del Veh√≠culo</label>
                <input type="number" id="ano" placeholder="Ej: 2022" min="1980" max="2026">
                <div class="help-text" id="ayudaAno"></div>
            </div>

            <div class="form-group">
                <label>Valor (USD) üíµ</label>
                <input type="number" id="valor" placeholder="25000">
            </div>

            <div class="form-group">
                <label>Flete (USD) üö¢</label>
                <input type="number" id="flete" placeholder="1500">
            </div>

            <div class="form-group">
                <label>Tipo de Cambio (‚Ç°/USD) üí±</label>
                <div style="display: flex; gap: 8px;">
                    <input type="number" id="tipoCambio" placeholder="520" style="flex: 1;">
                    <button onclick="actualizarTC()" style="background: #dbeafe; color: #1e40af; padding: 8px 12px; width: 50px;">üîÑ</button>
                </div>
                <div class="help-text">Se actualiza al cargar</div>
            </div>

            <div class="button-group">
                <button class="btn-secondary" onclick="limpiarFormulario()">üóëÔ∏è Limpiar</button>
                <button class="btn-primary" onclick="calcular()">Calcular</button>
            </div>
        </div>

        <div id="resultado" class="hidden">
            <div class="result-card">
                <div style="font-size: 12px; opacity: 0.9;">üí∞ COSTO TOTAL</div>
                <div class="result-amount" id="resultadoTotal"></div>
                <div class="result-buttons">
                    <button class="btn-result" onclick="mostrarDetalle()">Ver Detalle</button>
                    <button class="btn-result" onclick="guardarHistorial()">Guardar</button>
                </div>
            </div>

            <div id="detalle" class="card hidden">
                <div class="card-title">üìä Desglose</div>
                <div id="detalleContent"></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px;">
                    <button onclick="exportar()" style="background: #dbeafe; color: #1e40af; padding: 10px;">üì• Exportar</button>
                    <button onclick="compartirWA()" style="background: #dcfce7; color: #15803d; padding: 10px;">üí¨ WhatsApp</button>
                </div>
            </div>
        </div>

        <div style="text-align: center; font-size: 11px; color: #6b7280; margin-top: 20px; margin-bottom: 20px;">
            <p>TC: ‚Ç°<span id="tcFooter">520</span> | 2025</p>
        </div>
    </div>

    <script>
        let historial = [];
        let modoComparacion = false;
        let vehiculosSeleccionados = new Set();
        const anoActual = new Date().getFullYear();

        function formatUSD(num) {
            return '$' + Math.round(num).toLocaleString('en-US');
        }

        function formatCRC(num) {
            return '‚Ç°' + Math.round(num).toLocaleString('es-CR');
        }

        async function actualizarTC() {
            try {
                const response = await fetch('https://api.hacienda.go.cr/indicadores/tc/dolar');
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        const tc = parseFloat(data[0].venta).toFixed(2);
                        document.getElementById('tipoCambio').value = tc;
                        document.getElementById('tcFooter').textContent = tc;
                    }
                }
            } catch (e) {
                console.log('No se pudo obtener TC');
            }
        }

        document.getElementById('ano').addEventListener('change', function() {
            const ano = parseInt(this.value);
            if (ano < 1980 || ano > anoActual + 1) {
                this.value = '';
                document.getElementById('ayudaAno').textContent = 'Inv√°lido';
            } else {
                const antiguedad = anoActual - ano;
                const porcentaje = antiguedad <= 6 ? '48.37%' : '68.37%';
                document.getElementById('ayudaAno').textContent = `${antiguedad} a√±os ‚Ä¢ Impuesto: ${porcentaje}`;
            }
        });

        function calcular() {
            const ano = parseInt(document.getElementById('ano').value);
            const valor = parseFloat(document.getElementById('valor').value) || 0;
            const flete = parseFloat(document.getElementById('flete').value) || 0;
            const tc = parseFloat(document.getElementById('tipoCambio').value) || 520;

            if (!ano || !valor || !flete) {
                alert('Completa todos los campos');
                return;
            }

            const antiguedad = anoActual - ano;
            const valorBase = valor + flete;
            const seguros = valorBase * 0.018;
            const baseImpuestos = valorBase + seguros;
            const impuesto = antiguedad <= 6 ? 0.4837 : 0.6837;
            const impuestos = baseImpuestos * impuesto;
            const papeleoUSA = 250;
            const declaracion = 106000;
            const dekra = 45000;
            const almacenamiento = 65000;

            const totalColones = (valor + flete + seguros + impuestos + papeleoUSA) * tc + declaracion + dekra + almacenamiento;

            const datos = { id: Date.now(), ano, valor, flete, antiguedad, seguros, baseImpuestos, impuestos, papeleoUSA, declaracion, dekra, almacenamiento, tc, totalColones };

            window.datosActuales = datos;
            document.getElementById('resultadoTotal').textContent = formatCRC(totalColones);
            document.getElementById('resultado').classList.remove('hidden');
        }

        function mostrarDetalle() {
            const d = window.datosActuales;
            const html = `
                <div class="section-header">üíµ VALORES EN D√ìLARES</div>
                <div class="detail-row"><span class="detail-label">Valor veh√≠culo</span><span class="detail-value">${formatUSD(d.valor)}</span></div>
                <div class="detail-row"><span class="detail-label">Flete</span><span class="detail-value">${formatUSD(d.flete)}</span></div>
                <div class="detail-row"><span class="detail-label">Seguros</span><span class="detail-value">${formatUSD(d.seguros)}</span></div>

                <div class="section-header" style="margin-top: 12px;">‚Ç° VALORES EN COLONES</div>
                <div class="detail-row"><span class="detail-label">Impuestos</span><span class="detail-value" style="color: #dc2626;">${formatCRC(d.impuestos * d.tc)}</span></div>
                <div class="detail-row"><span class="detail-label">Papeleo USA</span><span class="detail-value">${formatCRC(d.papeleoUSA * d.tc)}</span></div>
                <div class="detail-row"><span class="detail-label">Declaraci√≥n CR</span><span class="detail-value">${formatCRC(d.declaracion)}</span></div>
                <div class="detail-row"><span class="detail-label">Dekra</span><span class="detail-value">${formatCRC(d.dekra)}</span></div>
                <div class="detail-row"><span class="detail-label">Almacenamiento</span><span class="detail-value">${formatCRC(d.almacenamiento)}</span></div>
                <div class="detail-row highlight" style="background: linear-gradient(to right, #f0fdf4, #dbeafe); margin-top: 12px;"><span>TOTAL FINAL</span><span style="font-size: 16px;">${formatCRC(d.totalColones)}</span></div>
            `;
            document.getElementById('detalleContent').innerHTML = html;
            document.getElementById('detalle').classList.remove('hidden');
        }

        function guardarHistorial() {
            const d = window.datosActuales;
            historial.unshift({ ...d, fecha: new Date().toLocaleString('es-CR') });
            alert('‚úì Guardado');
            actualizarHistorialUI();
        }

        function actualizarHistorialUI() {
            const card = document.getElementById('historialCard');
            const content = document.getElementById('historialContent');
            
            if (historial.length === 0) {
                card.classList.add('hidden');
                return;
            }

            card.classList.remove('hidden');
            let html = '';
            historial.forEach(item => {
                const sel = vehiculosSeleccionados.has(item.id);
                html += `<div class="comparison-card" style="${sel ? 'border-color: #3b82f6; background: #eff6ff;' : ''}" onclick="seleccionarComparacion(${item.id})"><div>${item.ano} ‚Ä¢ ${formatUSD(item.valor)}</div><div style="font-size: 12px; color: #6b7280;">${item.fecha}</div><div style="font-weight: bold; color: #2563eb; margin-top: 4px;">${formatCRC(item.totalColones)}</div>${sel ? '<div style="font-size: 11px; color: #2563eb; margin-top: 4px;">‚úì</div>' : ''}</div>`;
            });
            content.innerHTML = html;
        }

        function seleccionarComparacion(id) {
            if (!modoComparacion) return;
            if (vehiculosSeleccionados.has(id)) {
                vehiculosSeleccionados.delete(id);
            } else if (vehiculosSeleccionados.size < 2) {
                vehiculosSeleccionados.add(id);
            }
            actualizarHistorialUI();
            mostrarComparacion();
        }

        function mostrarComparacion() {
            const comp = document.getElementById('comparador');
            if (vehiculosSeleccionados.size < 2) {
                comp.classList.add('hidden');
                return;
            }
            
            const sel = historial.filter(v => vehiculosSeleccionados.has(v.id));
            let html = '';
            sel.forEach((v, idx) => {
                html += `<div class="comparison-card"><div style="font-weight: bold; color: #1e40af;">Veh√≠culo ${idx + 1}</div><div style="font-size: 12px; margin-top: 4px;">A√±o: ${v.ano}</div><div style="font-size: 12px;">Valor: ${formatUSD(v.valor)}</div><div style="font-size: 12px;">Flete: ${formatUSD(v.flete)}</div><div style="background: #eff6ff; padding: 8px; border-radius: 4px; margin-top: 8px; font-weight: bold; display: flex; justify-content: space-between;"><span>TOTAL:</span><span>${formatCRC(v.totalColones)}</span></div></div>`;
            });
            
            if (sel.length === 2) {
                const diff = Math.abs(sel[0].totalColones - sel[1].totalColones);
                html += `<div style="background: #eff6ff; padding: 12px; border-radius: 8px; text-align: center; font-weight: bold; color: #1e40af;">Diferencia: ${formatCRC(diff)}</div>`;
            }
            
            document.getElementById('comparacionContent').innerHTML = html;
            comp.classList.remove('hidden');
        }

        function toggleComparacion() {
            modoComparacion = !modoComparacion;
            document.getElementById('btnComparar').classList.toggle('active');
            vehiculosSeleccionados.clear();
            if (!modoComparacion) document.getElementById('comparador').classList.add('hidden');
            actualizarHistorialUI();
        }

        function toggleHistorial() {
            document.getElementById('historialCard').classList.toggle('hidden');
        }

        function limpiarFormulario() {
            document.getElementById('ano').value = '';
            document.getElementById('valor').value = '';
            document.getElementById('flete').value = '';
            document.getElementById('resultado').classList.add('hidden');
            document.getElementById('detalle').classList.add('hidden');
            document.getElementById('ayudaAno').textContent = '';
        }

        function limpiarHistorial() {
            historial = [];
            vehiculosSeleccionados.clear();
            document.getElementById('historialCard').classList.add('hidden');
            document.getElementById('comparador').classList.add('hidden');
        }

        function exportData() {
    const d = window.currentData;

    // Calculate grand total (taxes + extra expenses)
    const grandTotal = d.totalCRC + d.dekra + d.declaration + d.storage + 250 * d.exchangeRate;

    // Build the export content (Spanish titles)
    const content = 
`C√ÅLCULO DE IMPUESTOS - COSTA RICA
Fecha: ${new Date().toLocaleString('es-CR')}

A√±o: ${d.year}
Valor del veh√≠culo: ${formatUSD(d.value)}
Costo del flete: ${formatUSD(d.freight)}

TOTAL DE IMPUESTOS: ${formatCRC(d.totalCRC)}

GASTOS VARIOS:
- Papeleo (USA): ${formatUSD(250)}
- Declaraci√≥n y papeleo: ${formatCRC(106000)}
- Dekra: ${formatCRC(45000)}
- Almacenamiento: ${formatCRC(65000)}

--------------------------------
GRAN TOTAL: ${formatCRC(grandTotal)}
Tipo de cambio: ‚Ç°${d.exchangeRate}`;

    // Create and trigger file download
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Calculo-Impuestos-${d.year}.txt`;
    a.click();
    URL.revokeObjectURL(url);
}
        function compartirWA() {
            const d = window.datosActuales;
            const msg = `üöó NACIONALIZACI√ìN%0AA√±o: ${d.ano}%0AValor: ${formatUSD(d.valor)}%0AFlete: ${formatUSD(d.flete)}%0A%0ATOTAL: ${formatCRC(d.totalColones)}%0ATC: ‚Ç°${d.tc}`;
            window.open(`https://wa.me/?text=${msg}`, '_blank');
        }

        actualizarTC();
    </script>
</body>
</html>
