<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nacionalizaci√≥n CR">

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="icon-192.png">

    <title>C√°lculo de Impuestos con VIN</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@zxing/browser@latest/umd/zxing-browser.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(to bottom right, #e0f2fe, #e0e7ff); }
        .header { background: linear-gradient(135deg, #2563eb 0%, #4f46e5 100%); color: white; padding: 16px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .header-title { display: flex; align-items: center; gap: 8px; }
        .header-logo { width: 36px; height: 36px; } /* SVG o IMG. */
        .header-title h1 {
            font-size: 18px;
            font-weight: bold;
            color: white; 
            text-shadow: 0 1px 3px rgba(0,0,0,0.25);
        }
        .header-title p {
            font-size: 12px;
            color: #86efac; 
            opacity: 1;
        }
        .header-buttons { display: flex; gap: 8px; }
        button { border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }

        /* Estilos de Botones */
        .btn-icon { background: rgba(255,255,255,0.2); color: white; width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .btn-icon:active { background: rgba(255,255,255,0.3); }

        .btn-header { background: rgba(255,255,255,0.2); color: white; width: auto; padding: 8px 12px; font-size: 12px; }
        .btn-header.active { background: #fbbf24; color: #1f2937; }

        .btn-secondary { background: #e5e7eb; color: #374151; padding: 12px; }
        .btn-secondary:active, .btn-secondary:hover { background: #d1d5db; cursor: pointer; }

        .btn-primary { background: linear-gradient(135deg, #2563eb 0%, #4f46e5 100%); color: white; grid-column: 1 / -1; padding: 12px; }
        .btn-primary:disabled { background: #d1d5db; cursor: not-allowed; }

        .btn-result { background: rgba(255,255,255,0.2); color: white; padding: 12px; font-size: 12px; font-weight: 600; }
        .btn-result:active { background: rgba(255,255,255,0.3); }

        .btn-danger-light { background: #fee2e2; color: #dc2626; padding: 4px 8px; font-size: 11px; border-radius: 4px; }
        .btn-info-light { background: #dbeafe; color: #1e40af; padding: 12px; border-radius: 8px; }
        .btn-success-light { background: #dcfce7; color: #15803d; padding: 12px; border-radius: 8px; }
        .btn-update-tc { background: #dbeafe; color: #2563eb; font-size: 11px; padding: 6px 10px; font-weight: bold; }
        .btn-update-tc:active { background: #bfdbfe; }

        /* Contenedores y Tarjetas */
        .container { max-width: 500px; margin: 0 auto; padding: 16px; }
        .card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .card-title { font-size: 16px; font-weight: bold; margin-bottom: 12px; color: #1f2937; }

        /* Formulario */
        .form-group { margin-bottom: 12px; }
        .form-group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        label { display: block; font-size: 12px; font-weight: 600; color: #374151; }
        input { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; font-family: inherit; }
        input:focus { outline: none; border-color: #2563eb; background: #f0f9ff; }
        
        /* Ocultar flechas en inputs de tipo n√∫mero */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
        }

        .help-text { font-size: 11px; color: #6b7280; margin-top: 4px; display: flex; align-items: center; gap: 6px;}
        .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }

        /* NUEVA FICHA INFORMATIVA VIN */
        .info-card { background-color: #eff6ff; border: 2px solid #93c5fd; padding: 12px; margin-top: 16px; }
        .info-card-title { font-size: 14px; font-weight: bold; color: #1e40af; margin-bottom: 10px; }
        .info-card .detail-row { padding: 8px 0; font-size: 14px; }
        .info-card .detail-label { color: #374151; }
        .info-card .detail-value { color: #1f2937; }

        /* SPINNER DE CARGA */
        .spinner {
            width: 14px; height: 14px;
            border: 2px solid #93c5fd; border-top-color: #3b82f6;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Resultados y Detalles */
        .result-card { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; margin-bottom: 16px; padding: 16px; border-radius: 12px; }
        .result-amount { font-size: 32px; font-weight: bold; margin-bottom: 16px; }
        .result-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

        .detail-row { display: flex; justify-content: space-between; padding: 10px 0; font-size: 13px; border-bottom: 1px solid #e5e7eb; }
        .detail-row.subtotal { font-weight: bold; color: #1e40af; }
        .detail-label { color: #6b7280; }
        .detail-value { font-weight: 600; color: #1f2937; }
        .section-header { background: #dbeafe; color: #1e40af; padding: 8px 12px; border-radius: 6px; font-size: 11px; font-weight: bold; margin-top: 12px; margin-bottom: 8px; }
        .total-row { background: #f0fdf4; padding: 12px; border-radius: 6px; margin-top: 12px; font-weight: bold; display: flex; justify-content: space-between; font-size: 16px; }

        /* Historial y Comparador */
        .comparison-card { background: white; border: 2px solid #93c5fd; border-radius: 8px; padding: 12px; margin-bottom: 12px; cursor: pointer; }
        .comparison-card:active { background: #eff6ff; border-color: #3b82f6; }
        .comparison-card.selected { border-color: #2563eb; background: #eff6ff; border-width: 3px; }
        
        .historial-vehicle-info { 
            font-size: 13px; 
            color: #4b5563; 
            margin-top: 4px; 
            font-weight: 500;
        }

        .hidden { display: none !important; }

        /* --- CSS SCANNER --- */
        #scanner-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #videoElement {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: translate(-50%, -50%);
            z-index: 201;
        }
        #scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 202;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #scanner-viewfinder {
            width: 90%;
            max-width: 600px;
            height: 100px;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.7);
        }
        .scanner-red-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #dc2626;
            box-shadow: 0 0 8px #dc2626;
            top: 50%;
            transform: translateY(-50%);
        }
        .scanner-text {
            color: white;
            font-weight: 600;
            margin-top: 24px;
            font-size: 14px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        #btnStopScan {
            margin-top: 24px;
            padding: 12px 24px;
            font-size: 16px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.5);
            z-index: 203; 
        }
        #btnStopScan:active {
            background: rgba(255,255,255,0.3);
        }
        /* --- FIN CSS SCANNER --- */

        /* ==== INICIO: CSS DEL TOAST ==== */
        #toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            background: #2d3748; 
            color: white;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
        }

        #toast.show {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(0); 
        }
        
        #toast.success { background: #059669; }
        #toast.error   { background: #dc2626; }
        #toast.info    { background: #2563eb; }
        /* ==== FIN: CSS DEL TOAST ==== */

        /* ==== INICIO: CSS PARA SECCIONES COLAPSABLES ==== */
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f0f9ff; 
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            font-weight: bold;
            color: #1f2937;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            transition: background 0.2s ease-in-out;
        }

        .collapsible-header:hover { background: #e0f2fe; }
        .collapsible-header .arrow-icon {
            width: 18px;
            height: 18px;
            transition: transform 0.3s ease-in-out;
        }
        .collapsible-header.open .arrow-icon { transform: rotate(180deg); }
        .collapsible-content {
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        }
        .collapsible-content.open {
            max-height: 500px; 
            opacity: 1;
            margin-bottom: 12px; 
        }
        /* ==== FIN: CSS PARA SECCIONES COLAPSABLES ==== */
    </style>
</head>
<body>
    <div class="header">
        <div class="header-title">
            <img src="new-logo.png" alt="Logo" class="header-logo">
            <div>
                <h1>Calculadora</h1>
                <p>Importaci√≥n de Veh√≠culos</p>
            </div>
        </div>
        <div class="header-buttons" id="main-header-buttons" style="display: none;">
            <button class="btn-header" id="btnComparar">Compare</button>
            <button class="btn-header" id="btnHistorial">Historial</button>
        </div>
    </div>

    <div id="scanner-container" class="hidden">
        <video id="videoElement" playsinline></video>
        <div id="scanner-overlay">
            <div id="scanner-viewfinder">
                <div class="scanner-red-line"></div>
            </div>
            <div class="scanner-text">Centre el c√≥digo de barras en la l√≠nea roja</div>
            <button id="btnStopScan">Cancelar</button>
        </div>
    </div>
    
    <div class="container">
        
        <div id="auth-section" class="card" style="display: none;">
            <div id="login-form">
                <div class="card-title">Iniciar Sesi√≥n</div>
                <div class="form-group"><label for="loginEmail">Correo Electr√≥nico</label><input type="email" id="loginEmail" placeholder="usuario@ejemplo.com"></div>
                <div class="form-group"><label for="loginPassword">Contrase√±a</label><input type="password" id="loginPassword"></div>
                <button id="btnLogin" class="btn-primary" style="width: 100%;">Ingresar</button>
                <p id="loginError" style="color: red; font-size: 12px; margin-top: 8px; text-align: center; min-height: 16px;"></p>
            </div>
            
            <div id="create-account-form" style="display: none; border-top: 1px solid #e5e7eb; margin-top: 20px; padding-top: 20px;">
                 <div class="card-title">Crear Nueva Cuenta (Admin)</div>
                 <div class="form-group"><label for="createEmail">Correo Electr√≥nico Cliente</label><input type="email" id="createEmail" placeholder="cliente@ejemplo.com"></div>
                 <div class="form-group"><label for="createPassword">Contrase√±a Temporal</label><input type="password" id="createPassword"></div>
                 <button id="btnCreateAccount" class="btn-secondary" style="width: 100%;">Crear Cuenta</button>
                 <p id="createError" style="color: red; font-size: 12px; margin-top: 8px; text-align: center;"></p>
            </div>
        </div>

        <div id="app-content" style="display: none;">

            <div id="comparador" class="card hidden">
                <div class="card-title">Comparar Veh√≠culos</div>
                <div id="comparacionContent"></div>
            </div>

            <div id="historialCard" class="card hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div class="card-title" style="margin: 0;">Historial</div>
                    <button id="btnLimpiarHistorial" class="btn-danger-light">Limpiar</button>
                </div>
                <div id="historialContent"></div>
            </div>

            <div class="card">
                <div class="card-title">Ingrese datos del Veh√≠culo</div>

                <div class="form-group">
                    <label for="vin">VIN Number</label>
                    <input type="text" id="vin" placeholder="Ej: 5FNRL6H73LB123456" maxlength="17" autocapitalize="characters">
                    <div class="help-text" id="vinStatus"></div>

                    <div class="button-group" style="margin-top: 8px;">
                        <button id="btnScanVIN" class="btn-secondary">‚ïë‚ñå‚ïë Escanear VIN</button>
                        <button id="btnLimpiarVIN" class="btn-danger-light" style="padding: 12px;">Limpiar VIN</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="ano">A√±o del Veh√≠culo</label>
                    <input type="number" id="ano" placeholder="2022" min="1980" inputmode="numeric">
                    <div class="help-text" id="ayudaAno"></div>
                </div>

                <div id="vinInfoCard" class="card info-card hidden">
                    <div class="card-title info-card-title">Informaci√≥n del Veh√≠culo</div>
                    <div class="detail-row"><span class="detail-label">Marca</span><span class="detail-value" id="vinMake"></span></div>
                    <div class="detail-row"><span class="detail-label">Modelo</span><span class="detail-value" id="vinModel"></span></div>
                    <div class="detail-row"><span class="detail-label">Versi√≥n</span><span class="detail-value" id="vinTrim"></span></div>
                    <div class="detail-row"><span class="detail-label">Motor</span><span class="detail-value" id="vinEngine"></span></div>
                    <div class="detail-row" style="border-bottom: none;"><span class="detail-label">Pa√≠s</span><span class="detail-value" id="vinCountry"></span></div>
                </div>

                <hr style="border:none; border-top: 1px solid #e5e7eb; margin: 20px 0;">

                <div class="collapsible-header" data-target="collapsible-millaje">
                    <span>Convertidor de Distancia</span>
                    <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor">
                        <path d="M207 416c11.3 0 22.1-4.3 30.2-12.3L400.2 248.2c12.1-12.1 12.1-31.7 0-43.8s-31.7-12.1-43.8 0L224 334.3 91.8 204.2c-12.1-12.1-31.7-12.1-43.8 0s-12.1 31.7 0 43.8L176.8 403.7c8.1 8 18.9 12.3 30.2 12.3z"/>
                    </svg>
                </div>
                <div id="collapsible-millaje" class="collapsible-content">
                    <div class="form-group">
                        <label for="millaje">Millaje / Kilometraje</label>
                        <input type="number" id="millaje" placeholder="30000" inputmode="numeric">
                        <div class="help-text">El color indica si est√° sobre (rojo) o bajo (verde) el promedio para el a√±o del veh√≠culo.</div>
                    </div>
                    <div class="button-group">
                        <button class="btn-secondary" id="btnMillasAKm">Millas a Kms</button>
                        <button class="btn-secondary" id="btnKmsAMillas">Kms a Millas</button>
                    </div>

                    <div id="millajeInfoCard" class="card info-card hidden" style="margin-top: 16px;">
                        <div class="card-title info-card-title">Resultado de Conversi√≥n</div>
                        <div class="detail-row">
                            <span class="detail-label" id="millajeResultadoLabel"></span>
                            <span class="detail-value" id="millajeResultadoValor"></span>
                        </div>
                        <div class="detail-row" style="border-bottom: none;">
                            <span class="detail-label" id="millajePromedioLabel"></span>
                            <span class="detail-value" id="millajePromedioValor"></span>
                        </div>
                        <div id="millajePromedioStatus" style="font-size: 12px; font-weight: bold; text-align: center; margin-top: 10px;"></div>
                    </div>
                    <hr style="border:none; border-top: 1px solid #e5e7eb; margin: 20px 0;">
                </div>
                
                <div class="collapsible-header" data-target="collapsible-traspaso">
                    <span>C√°lculo de Traspaso</span>
                    <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor">
                        <path d="M207 416c11.3 0 22.1-4.3 30.2-12.3L400.2 248.2c12.1-12.1 12.1-31.7 0-43.8s-31.7-12.1-43.8 0L224 334.3 91.8 204.2c-12.1-12.1-31.7-12.1-43.8 0s-12.1 31.7 0 43.8L176.8 403.7c8.1 8 18.9 12.3 30.2 12.3z"/>
                    </svg>
                </div>
                <div id="collapsible-traspaso" class="collapsible-content">
                    <div class="form-group">
                        <label for="valorFiscal">Valor Fiscal (‚Ç°)</label>
                        <input type="number" id="valorFiscal" placeholder="10000000" inputmode="numeric">
                    </div>
                    <button class="btn-primary" id="btnCalcularTraspaso" style="width: 100%;">Calcular Traspaso</button>
                    <div id="resultadoTraspaso" style="margin-top: 12px;"></div>
                    <hr style="border:none; border-top: 1px solid #e5e7eb; margin: 20px 0;">
                </div>
                

                <div class="form-group">
                    <label for="valor">Valor (USD)</label>
                    <input type="number" id="valor" placeholder="25000" inputmode="numeric">
                </div>

                <div class="form-group">
                    <label for="flete">Flete (USD)</label>
                    <input type="number" id="flete" placeholder="1500" inputmode="numeric">
                </div>

                <div class="form-group">
                    <div class="form-group-header">
                        <label for="tipoCambio">Tipo de Cambio (‚Ç°/USD)</label>
                        <button id="btnActualizarTC" class="btn-update-tc">Actualizar TC</button>
                    </div>
                    <input type="number" id="tipoCambio" placeholder="520" inputmode="numeric">
                    <div class="help-text" id="tipoCambioHelp"></div>
                </div>

                <div class="button-group">
                    <button class="btn-secondary" id="btnLimpiarFormulario">Limpiar</button>
                    <button class="btn-primary" id="btnCalcular">Calcular</button>
                </div>
            </div>

            <div id="resultado" class="hidden">
                <div class="result-card">
                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;">COSTO TOTAL</div>
                    <div class="result-amount" id="resultadoTotal"></div>
                    <div class="result-buttons">
                        <button class="btn-result" id="btnVerDetalle">Ver Detalle</button>
                        <button class="btn-result" id="btnGuardarHistorial">Guardar</button>
                    </div>
                </div>

                <div id="detalle" class="card hidden">
                    <div class="card-title">Desglose</div>
                    <div id="detalleContent"></div>
                    <div class="button-group" style="margin-top: 16px;">
                        <button id="btnDescargar" class="btn-info-light">Exportar (PDF)</button>
                        <button id="btnWhatsApp" class="btn-success-light">WhatsApp</button>
                    </div>
                </div>
            </div>

            <button id="btnLogout" class="btn-danger-light" style="width: 100%; padding: 12px; margin-top: 20px; font-size: 14px;">Cerrar Sesi√≥n</button>
        
        </div> <div style="text-align: center; font-size: 11px; color: #6b7280; margin-top: 20px; margin-bottom: 20px;">
            <p>TC Venta BCCR: <span id="tcFooter">N/A</span></p>
        </div>
    </div>
    <div id="toast" class="toast"></div>
    
    <script>
        // ==== INICIO: CONFIGURACI√ìN E INICIALIZACI√ìN DE FIREBASE ====
        const firebaseConfig = {
            // üî•üî•üî• TU CONFIGURACI√ìN DE FIREBASE EST√Å AQU√ç üî•üî•üî•
            apiKey: "AIzaSyBF4CP3vGJ-aJveo93QKR4kbYjDkxQYrVY",
            authDomain: "calculos-cr.firebaseapp.com",
            projectId: "calculos-cr",
            storageBucket: "calculos-cr.appspot.com",
            messagingSenderId: "502237422177",
            appId: "1:502237422177:web:6974139fc782d52a1e8020"
        };
        let auth;
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            console.log("Firebase inicializado correctamente.");
        } catch (e) {
            console.error("Error inicializando Firebase:", e);
             document.addEventListener('DOMContentLoaded', () => {
                 const loginError = document.getElementById('loginError');
                 if(loginError) loginError.textContent = 'Error al cargar servicios. Refresca la p√°gina.';
             });
        }
        // ==== FIN: CONFIGURACI√ìN E INICIALIZACI√ìN DE FIREBASE ====

        // --- VARIABLES GLOBALES Y CONSTANTES ---
        let historial = JSON.parse(localStorage.getItem('impuestosHistorial')) || [];
        let modoComparacion = false;
        let vehiculosSeleccionados = new Set();
        let calculoActual = null;
        let vinDecodeTimeout;
        let codeReader = null; 
        let toastTimeout; 

        let currentVinInfo = { make: '', model: '', year: '' }; 

        const anoActual = new Date().getFullYear();

        const COSTOS_FIJOS = {
            SEGURO_1: 0.011, SEGURO_2: 0.007, PAPELEO_USA: 250,
            DECLARACION_CR: 106000, DEKRA: 45000, ALMACENAMIENTO: 65000
        };

        // --- CONSTANTES HERRAMIENTAS ---
        const MILLAS_POR_KM = 0.621371;
        const KM_POR_MILLA = 1.60934;
        const PROMEDIO_MILLAS_ANO = 15000;
        const PROMEDIO_KMS_ANO = 17000;
        const PORCENTAJE_TIMBRES = 0.035;
        const HONORARIOS_TRASPASO = 65000;

        // --- MANEJO DE EVENTOS ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('ano').addEventListener('change', validarAno);
            // CAMBIO V6: Nuevo listener para validaci√≥n de a√±o en tiempo real
            document.getElementById('ano').addEventListener('input', validarInicioAno);

            document.getElementById('vin').addEventListener('input', handleVinInput);
            document.getElementById('btnCalcular').addEventListener('click', calcular);
            document.getElementById('btnLimpiarFormulario').addEventListener('click', limpiarFormulario);
            document.getElementById('btnLimpiarVIN').addEventListener('click', limpiarVIN);
            document.getElementById('btnVerDetalle').addEventListener('click', mostrarDetalle);
            document.getElementById('btnGuardarHistorial').addEventListener('click', guardarHistorial);
            document.getElementById('btnDescargar').addEventListener('click', descargarPDF);
            document.getElementById('btnWhatsApp').addEventListener('click', enviarWhatsApp);
            document.getElementById('btnHistorial').addEventListener('click', toggleHistorial);
            document.getElementById('btnLimpiarHistorial').addEventListener('click', limpiarHistorial);
            document.getElementById('btnComparar').addEventListener('click', toggleComparacion);
            document.getElementById('btnActualizarTC').addEventListener('click', fetchTipoDeCambio);
            document.getElementById('btnMillasAKm').addEventListener('click', convertirMillaje);
            document.getElementById('btnKmsAMillas').addEventListener('click', convertirMillaje);
            document.getElementById('btnCalcularTraspaso').addEventListener('click', calcularTraspaso);

            // --- LISTENERS SCANNER ---
            document.getElementById('btnScanVIN').addEventListener('click', iniciarScanner);
            document.getElementById('btnStopScan').addEventListener('click', detenerScanner);

            // --- LISTENERS AUTH (A√ëADIDOS) ---
            const btnLogin = document.getElementById('btnLogin');
            if (btnLogin) {
                btnLogin.addEventListener('click', iniciarSesion);
                console.log("Listener a√±adido a btnLogin.");
            } else {
                console.error("¬°ERROR CR√çTICO! No se encontr√≥ el elemento #btnLogin.");
            }

            const btnCreate = document.getElementById('btnCreateAccount');
            if (btnCreate) {
                btnCreate.addEventListener('click', crearCuenta);
                console.log("Listener a√±adido a btnCreateAccount.");
            } else {
                // Esto es opcional, puede que no exista en todas las vistas
                console.warn("Elemento #btnCreateAccount no encontrado."); 
            }

            const btnLogout = document.getElementById('btnLogout');
            if (btnLogout) {
                btnLogout.addEventListener('click', cerrarSesion);
                console.log("Listener a√±adido a btnLogout.");
            } else {
                console.warn("Elemento #btnLogout no encontrado (normal si no est√° logueado).");
            }
            
            // --- LISTENERS COLAPSABLES ---
            document.querySelectorAll('.collapsible-header').forEach(header => {
                header.addEventListener('click', () => {
                    const targetId = header.dataset.target;
                    const content = document.getElementById(targetId);
                    if (content) {
                        header.classList.toggle('open');
                        content.classList.toggle('open');
                        if (content.classList.contains('open')) {
                            content.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    }
                });
            });

            document.getElementById('ano').max = anoActual + 1;
            actualizarHistorialUI();
            fetchTipoDeCambio();
        });

        // --- FUNCIONES DE AUTENTICACI√ìN (A√ëADIDAS) ---
        function crearCuenta() {
             if (typeof auth === 'undefined' || typeof db === 'undefined') { console.error("Firebase no inicializado"); showToast("Error de servicio", "error"); return; }
             const emailInput = document.getElementById('createEmail');
             const passwordInput = document.getElementById('createPassword');
             const errorElement = document.getElementById('createError');
             if (!emailInput || !passwordInput || !errorElement) return;
             const email = emailInput.value;
             const password = passwordInput.value;
             errorElement.textContent = '';
             if (!email || !password) { errorElement.textContent = 'Ingresa correo y contrase√±a.'; return; }
             
             // NOTA: Esta funci√≥n crea un usuario y lo activa de inmediato.
             auth.createUserWithEmailAndPassword(email, password)
                 .then(userCredential => {
                     const user = userCredential.user;
                     console.log('Cuenta creada en Auth:', user.uid);
                     const userDocRef = db.collection('usuarios').doc(user.uid);
                     // Activa la suscripci√≥n inmediatamente al crearla
                     return userDocRef.set({ 
                         email: user.email, 
                         suscripcionActiva: true, 
                         fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(), 
                         metodoPago: 'manual_admin' // Asumiendo que el admin la crea
                     });
                 })
                 .then(() => {
                     console.log("Doc Firestore creado.");
                     showToast(`‚úÖ Cuenta creada y activada para ${email}`, 'success');
                     emailInput.value = ''; 
                     passwordInput.value = '';
                 })
                 .catch(error => {
                     console.error("Error al crear cuenta o doc Firestore:", error);
                     if (error.code === 'auth/email-already-in-use') { errorElement.textContent = 'Este correo ya est√° registrado.'; }
                     else if (error.code === 'auth/weak-password'){ errorElement.textContent = 'La contrase√±a debe tener al menos 6 caracteres.'; }
                     else { errorElement.textContent = `Error: ${error.message}`; }
                     showToast(`‚ùå Error al crear cuenta`, 'error');
                 });
        }

        function iniciarSesion() {
             if (typeof auth === 'undefined') { console.error("Firebase no inicializado"); showToast("Error de servicio", "error"); return; }
             const emailInput = document.getElementById('loginEmail');
             const passwordInput = document.getElementById('loginPassword');
             const errorElement = document.getElementById('loginError');
             if (!emailInput || !passwordInput || !errorElement) return;
             const email = emailInput.value;
             const password = passwordInput.value;
             errorElement.textContent = 'Verificando...';
             if (!email || !password) { errorElement.textContent = 'Ingresa correo y contrase√±a.'; return; }
             
             auth.signInWithEmailAndPassword(email, password)
                 .then(userCredential => { 
                     console.log('Usuario inici√≥ sesi√≥n:', userCredential.user.email); 
                     // onAuthStateChanged se encargar√° del resto
                 })
                 .catch(error => {
                     console.error("Error al iniciar sesi√≥n:", error);
                     if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') { 
                         errorElement.textContent = 'Correo o contrase√±a incorrectos.'; 
                     }
                     else { errorElement.textContent = `Error: ${error.message}`; }
                 });
        }

        function cerrarSesion() {
             if (typeof auth === 'undefined') { console.error("Firebase no inicializado"); return; }
             auth.signOut().catch(error => { 
                 console.error('Error al cerrar sesi√≥n:', error); 
                 showToast('Error al cerrar sesi√≥n', 'error'); 
             });
        }

        // --- GESTI√ìN DEL ESTADO DE AUTENTICACI√ìN Y SUSCRIPCI√ìN (A√ëADIDO) ---
        if (typeof auth !== 'undefined' && typeof db !== 'undefined') {
             auth.onAuthStateChanged(user => {
                 const authSection = document.getElementById('auth-section');
                 const appContent = document.getElementById('app-content');
                 const loginError = document.getElementById('loginError');
                 const headerButtons = document.getElementById('main-header-buttons');
                 
                 if (!authSection || !appContent || !loginError || !headerButtons) { 
                     console.error("Elementos UI Auth cruciales no encontrados. No se puede continuar."); 
                     if (document.body) document.body.innerHTML = "Error cr√≠tico de UI. Contacte al administrador.";
                     return; 
                 }

                 if (user) { // Usuario est√° Logueado
                     loginError.textContent = 'Verificando suscripci√≥n...';
                     headerButtons.style.display = 'none'; // Ocultar botones hasta verificar
                     
                     const userDocRef = db.collection('usuarios').doc(user.uid);
                     
                     userDocRef.get().then(doc => {
                         // Asumimos que la secci√≥n de admin solo la ve un admin
                         const createAccountForm = document.getElementById('create-account-form');
                         if(createAccountForm) {
                             // CAMBIA ESTO A TU EMAIL DE ADMIN O L√ìGICA DE ROLES
                             if (user.email === 'admin@ejemplo.com') { 
                                 createAccountForm.style.display = 'block';
                             } else {
                                 createAccountForm.style.display = 'none';
                             }
                         }

                         if (doc.exists && doc.data().suscripcionActiva === true) {
                             // SUSCRIPCI√ìN V√ÅLIDA
                             console.log("Suscripci√≥n activa. Mostrando app.");
                             authSection.style.display = 'none';
                             appContent.style.display = 'block';
                             headerButtons.style.display = 'flex'; // Mostrar botones del header
                             loginError.textContent = '';
                         } else {
                             // LOGUEADO PERO SIN SUSCRIPCI√ìN
                             console.log("Suscripci√≥n NO activa o doc no existe.");
                             authSection.style.display = 'block'; // Mostrar login
                             appContent.style.display = 'none';
                             headerButtons.style.display = 'none';
                             loginError.textContent = 'Necesitas una suscripci√≥n activa.';
                             // Opcional: Desloguear autom√°ticamente si no tiene suscripci√≥n
                             // auth.signOut(); 
                         }
                     }).catch(error => {
                         // ERROR AL VERIFICAR FIRESTORE
                         console.error("Error al verificar Firestore:", error);
                         authSection.style.display = 'block'; // Mostrar login
                         appContent.style.display = 'none';
                         headerButtons.style.display = 'none';
                         loginError.textContent = 'Error verificando suscripci√≥n.';
                         // Opcional: Desloguear si hay error
                         // auth.signOut(); 
                     });
                 } else { // Usuario est√° Deslogueado
                     console.log('Estado: Deslogueado');
                     authSection.style.display = 'block'; // Mostrar login
                     appContent.style.display = 'none';
                     headerButtons.style.display = 'none';
                     loginError.textContent = '';
                     
                     // Ocultar el form de crear cuenta si est√° visible
                     const createAccountForm = document.getElementById('create-account-form');
                     if(createAccountForm) createAccountForm.style.display = 'none';
                 }
             });
        } else {
             console.error("Firebase Auth o Firestore no definidos globalmente.");
             document.addEventListener('DOMContentLoaded', () => {
                 const loginError = document.getElementById('loginError');
                 if(loginError) loginError.textContent = 'Error cr√≠tico al cargar servicios.';
                 else if (document.body) document.body.innerHTML = "Error cr√≠tico de Firebase.";
             });
        }

        // --- FUNCIONES DE FORMATO ---
        function formatUSD(num) { return '$' + Math.round(num).toLocaleString('en-US'); }
        function formatCRC(num) { return '‚Ç°' + Math.round(num).toLocaleString('es-CR'); }

        // --- FUNCI√ìN DEL TOAST ---
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.getElementById('toast');
            
            clearTimeout(toastTimeout);
            toast.textContent = message;
            toast.className = 'toast'; 
            toast.classList.add(type); 
            toast.classList.add('show'); 

            toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        // --- CAMBIO V6: NUEVA FUNCI√ìN DE VALIDACI√ìN DE A√ëO ---
        function validarInicioAno() {
            const anoInput = document.getElementById('ano');
            const ayudaAno = document.getElementById('ayudaAno');
            const valor = anoInput.value;

            if (valor.length > 0 && valor[0] !== '1' && valor[0] !== '2') {
                ayudaAno.innerHTML = '<span style="color: #dc2626;">El a√±o debe comenzar con 1 o 2</span>';
            } else {
                // Si el error estaba y se corrigi√≥, limpiar el mensaje de error
                if (ayudaAno.innerHTML.includes('comenzar con 1 o 2')) {
                    ayudaAno.innerHTML = '';
                }
            }
        }
        // --- FIN CAMBIO V6 ---

        // --- L√ìGICA DE C√ÅLCULO Y VALIDACI√ìN ---
        function validarAno() {
            const anoInput = document.getElementById('ano');
            const ayudaAno = document.getElementById('ayudaAno');
            const ano = parseInt(anoInput.value);

            // CAMBIO V6: La validaci√≥n de 'inicio' se hace en 'validarInicioAno'
            // Esta funci√≥n (en 'change') hace la validaci√≥n final.
            if (!ano || ano < 1980 || ano > anoActual + 1) {
                // No limpiar el input, solo mostrar error.
                // anoInput.value = ''; // Comentado para que el usuario vea su error
                ayudaAno.innerHTML = '<span style="color: #dc2626;">A√±o inv√°lido (1980 - ' + (anoActual + 1) + ')</span>';
            } else {
                const antiguedad = anoActual - ano;
                const porcentaje = antiguedad <= 6 ? '48.37%' : '68.37%';
                ayudaAno.textContent = `${antiguedad} a√±os | Impuesto: ${porcentaje}`;
            }
        }

        function calcular() {
            const ano = parseInt(document.getElementById('ano').value);
            const valor = parseFloat(document.getElementById('valor').value) || 0;
            const flete = parseFloat(document.getElementById('flete').value) || 0;
            const tc = parseFloat(document.getElementById('tipoCambio').value) || 0;
            
            // CAMBIO V6: Validaci√≥n de a√±o m√°s estricta antes de calcular
             if (!ano || ano < 1980 || ano > anoActual + 1) {
                showToast('Por favor, ingrese un a√±o v√°lido', 'error');
                document.getElementById('ano').focus(); // Poner foco en el campo de a√±o
                return;
            }
            if (!valor || !flete || !tc) { 
                showToast('Faltan campos (A√±o, Valor, Flete, TC)', 'error'); 
                return; 
            }
            const antiguedad = anoActual - ano;
            const porcentajeImpuesto = antiguedad <= 6 ? 0.4837 : 0.6837;

            const valorPlusFlete = valor + flete;
            const totalSeguros = valorPlusFlete * (COSTOS_FIJOS.SEGURO_1 + COSTOS_FIJOS.SEGURO_2);
            const baseImpuestos = valorPlusFlete + totalSeguros; 

            const impuestosUSD = baseImpuestos * porcentajeImpuesto;
            
            const subtotalVehiculoCRC = valorPlusFlete * tc; 

            const impuestosCRC = impuestosUSD * tc;
            const papeleoUSACRC = COSTOS_FIJOS.PAPELEO_USA * tc;
            const gastosFijosCRC = COSTOS_FIJOS.DECLARACION_CR + COSTOS_FIJOS.DEKRA + COSTOS_FIJOS.ALMACENAMIENTO;
            const totalColones = subtotalVehiculoCRC + impuestosCRC + papeleoUSACRC + gastosFijosCRC;

            calculoActual = { 
                ano, valor, flete, antiguedad, 
                totalSeguros, baseImpuestos, impuestosUSD, 
                papeleoUSA: COSTOS_FIJOS.PAPELEO_USA, 
                declaracion: COSTOS_FIJOS.DECLARACION_CR, 
                dekra: COSTOS_FIJOS.DEKRA, 
                almacenamiento: COSTOS_FIJOS.ALMACENAMIENTO, 
                tc, totalColones, 
                fecha: new Date().toLocaleString('es-CR'),
                vinInfo: { ...currentVinInfo } 
            };
            document.getElementById('resultadoTotal').textContent = formatCRC(totalColones);
            document.getElementById('resultado').classList.remove('hidden');
            document.getElementById('tcFooter').textContent = tc;
        }

        function mostrarDetalle() {
            if (!calculoActual) return;
            const d = calculoActual;
            const gastosAdminColones = (d.papeleoUSA * d.tc) + d.declaracion + d.dekra + d.almacenamiento;
            let html = `
                <div class="section-header">VALORES EN D√ìLARES</div>
                <div class="detail-row"><span class="detail-label">Valor veh√≠culo</span><span class="detail-value">${formatUSD(d.valor)}</span></div>
                <div class="detail-row"><span class="detail-label">Flete</span><span class="detail-value">${formatUSD(d.flete)}</span></div>
                <div class="detail-row subtotal"><span class="detail-label">Subtotal en D√≥lares</span><span class="detail-value">${formatUSD(d.valor + d.flete)}</span></div>
                <div class="section-header">VALORES EN COLONES</div>
                <div class="detail-row"><span class="detail-label">Montos del Veh√≠culo</span><span class="detail-value">${formatCRC((d.valor + d.flete) * d.tc)}</span></div>
                <div class="detail-row"><span class="detail-label">Impuestos</span><span class="detail-value">${formatCRC(d.impuestosUSD * d.tc)}</span></div>
                <div class="detail-row"><span class="detail-label">Gastos Administrativos</span><span class="detail-value">${formatCRC(gastosAdminColones)}</span></div>
                <div class="total-row"><span>GRAN TOTAL</span><span>${formatCRC(d.totalColones)}</span></div>`;
            document.getElementById('detalleContent').innerHTML = html;
            document.getElementById('detalle').classList.remove('hidden');
        }

        // --- FUNCIONES (HERRAMIENTAS) ---
        function convertirMillaje(event) {
            const valorInput = parseFloat(document.getElementById('millaje').value);
            const ano = parseInt(document.getElementById('ano').value);
            const resultadoCard = document.getElementById('millajeInfoCard');
            const resultadoLabel = document.getElementById('millajeResultadoLabel');
            const resultadoValor = document.getElementById('millajeResultadoValor');
            const promedioLabel = document.getElementById('millajePromedioLabel');
            const promedioValor = document.getElementById('millajePromedioValor');
            const promedioStatus = document.getElementById('millajePromedioStatus');
            function mostrarError(mensaje) {
                resultadoCard.classList.remove('hidden');
                resultadoLabel.textContent = 'Error';
                resultadoValor.textContent = '-';
                promedioLabel.textContent = 'Error';
                promedioValor.textContent = '-';
                promedioStatus.textContent = mensaje;
                promedioStatus.style.color = '#dc2626';
            }
            if (!valorInput || valorInput < 0) { showToast('Ingrese un valor de millaje v√°lido', 'error'); return; }
            if (!ano || ano < 1980 || ano > anoActual + 1) { showToast('Ingrese un a√±o de veh√≠culo v√°lido', 'error'); return; }
            const antiguedad = Math.max(1, anoActual - ano);
            let resultadoNum, promedio, esSobrePromedio, promedioPorAno;
            if (event.target.id === 'btnMillasAKm') {
                resultadoNum = valorInput * KM_POR_MILLA;
                promedio = PROMEDIO_MILLAS_ANO * antiguedad;
                esSobrePromedio = valorInput > promedio;
                promedioPorAno = valorInput / antiguedad;
                resultadoLabel.textContent = "Total KMs";
                resultadoValor.textContent = Math.round(resultadoNum).toLocaleString('es-CR');
                promedioLabel.textContent = "Promedio (Millas/A√±o)";
                promedioValor.textContent = Math.round(promedioPorAno).toLocaleString('en-US');
            } else {
                resultadoNum = valorInput * MILLAS_POR_KM;
                promedio = PROMEDIO_KMS_ANO * antiguedad;
                esSobrePromedio = valorInput > promedio;
                promedioPorAno = valorInput / antiguedad;
                resultadoLabel.textContent = "Total Millas";
                resultadoValor.textContent = Math.round(resultadoNum).toLocaleString('en-US');
                promedioLabel.textContent = "Promedio (KMs/A√±o)";
                promedioValor.textContent = Math.round(promedioPorAno).toLocaleString('es-CR');
            }
            promedioStatus.textContent = esSobrePromedio ? 'Sobre el promedio' : 'Debajo del promedio';
            promedioStatus.style.color = esSobrePromedio ? '#dc2626' : '#15803d';
            resultadoCard.classList.remove('hidden');
        }

        function calcularTraspaso() {
            const valorFiscal = parseFloat(document.getElementById('valorFiscal').value);
            const resultadoEl = document.getElementById('resultadoTraspaso');
            if (!valorFiscal || valorFiscal <= 0) {
                showToast('Ingrese un valor fiscal v√°lido', 'error'); 
                resultadoEl.textContent = 'Ingrese un valor fiscal v√°lido'; 
                resultadoEl.style.color = '#dc2626';
                return;
            }
            const timbres = valorFiscal * PORCENTAJE_TIMBRES;
            const total = timbres + HONORARIOS_TRASPASO;
            resultadoEl.style.color = '#1f2937';
            resultadoEl.innerHTML = `
                <div class="detail-row"><span class="detail-label">Timbres (3.5%)</span><span class="detail-value">${formatCRC(timbres)}</span></div>
                <div class="detail-row" style="border:none;"><span class="detail-label">Honorarios</span><span class="detail-value">${formatCRC(HONORARIOS_TRASPASO)}</span></div>
                <div class="total-row" style="margin-top: 8px;"><span>TOTAL APROX.</span><span>${formatCRC(total)}</span></div>`;
        }

        // --- L√ìGICA DE HISTORIAL Y COMPARACI√ìN ---
        function guardarHistorial() { 
            if (!calculoActual) {
                showToast('Primero debes calcular un veh√≠culo', 'error');
                return;
            } 

            // Asegurarse de que el objeto currentVinInfo tenga datos relevantes para el historial
            // Si el usuario escribi√≥ el a√±o manualmente, currentVinInfo.year estar√° vac√≠o.
            let infoAno = document.getElementById('ano').value || 'N/D';
            
            calculoActual.vinInfo = { 
                make: document.getElementById('vinMake').textContent || 'N/D',
                model: document.getElementById('vinModel').textContent || 'N/D',
                year: infoAno
            };

            historial.unshift({id: Date.now(), ...calculoActual }); 
            localStorage.setItem('impuestosHistorial', JSON.stringify(historial)); 
            showToast('‚úÖ C√°lculo guardado con √©xito', 'success'); 
            actualizarHistorialUI(); 
        }

        function actualizarHistorialUI() { 
            const card = document.getElementById('historialCard'); 
            const content = document.getElementById('historialContent'); 
            if (historial.length === 0) { 
                card.classList.add('hidden'); 
                return; 
            } 
            card.classList.remove('hidden'); 
            let html = ''; 
            historial.forEach(item => { 
                const isSelected = vehiculosSeleccionados.has(item.id); 
                const cardClass = isSelected ? 'comparison-card selected' : 'comparison-card'; 
                
                let vehicleInfoText = '';
                if (item.vinInfo && item.vinInfo.make !== 'N/D' && item.vinInfo.model !== 'N/D') {
                    vehicleInfoText = `${item.vinInfo.year} ${item.vinInfo.make} ${item.vinInfo.model}`;
                } else if (item.ano) { 
                    vehicleInfoText = `A√±o: ${item.ano}`;
                } else {
                    vehicleInfoText = "Veh√≠culo (sin info)";
                }


                html += `
                    <div class="${cardClass}" data-id="${item.id}">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div class="historial-vehicle-info">${vehicleInfoText}</div>
                            <div style="font-weight: bold; color: #2563eb;">${formatCRC(item.totalColones)}</div>
                        </div>
                        <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Valor: ${formatUSD(item.valor)} + Flete: ${formatUSD(item.flete)}</div>
                        <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">${item.fecha}</div>
                        ${isSelected ? '<div style="font-size: 11px; color: #2563eb; margin-top: 4px;">Seleccionado</div>' : ''}
                    </div>`; 
            }); 
            content.innerHTML = html; 
            content.querySelectorAll('.comparison-card').forEach(card => { 
                card.addEventListener('click', () => seleccionarComparacion(Number(card.dataset.id))); 
            }); 
        }

        function seleccionarComparacion(id) { 
            if (!modoComparacion) return; 
            if (vehiculosSeleccionados.has(id)) { 
                vehiculosSeleccionados.delete(id); 
            } else if (vehiculosSeleccionados.size < 2) { 
                vehiculosSeleccionados.add(id); 
            } 
            actualizarHistorialUI(); 
            mostrarComparacion(); 
        }
        function mostrarComparacion() { 
            const comp = document.getElementById('comparador'); 
            if (vehiculosSeleccionados.size < 2) { 
                comp.classList.add('hidden'); 
                return; 
            } 
            const sel = historial.filter(v => vehiculosSeleccionados.has(v.id)); 
            let html = ''; 
            sel.forEach((v, idx) => { 
                let vehicleInfoText = 'Veh√≠culo';
                if (v.vinInfo && v.vinInfo.make !== 'N/D' && v.vinInfo.model !== 'N/D') {
                    vehicleInfoText = `${v.vinInfo.year} ${v.vinInfo.make} ${v.vinInfo.model}`;
                } else if (v.ano) {
                    vehicleInfoText = `A√±o: ${v.ano}`;
                }
                html += `<div style="border: none; margin-bottom: 12px;"><div style="font-weight: bold; color: #1e40af; margin-bottom: 8px;">${vehicleInfoText}</div><div style="font-size: 12px; padding: 8px; background: #f3f4f6; border-radius: 6px;">Valor: ${formatUSD(v.valor)}<br>Flete: ${formatUSD(v.flete)}<br><br><strong>${formatCRC(v.totalColones)}</strong></div></div>`; 
            }); 
            if (sel.length === 2) { 
                const diff = Math.abs(sel[0].totalColones - sel[1].totalColones); 
                html += `<div style="background: #eff6ff; padding: 12px; border-radius: 8px; text-align: center; font-weight: bold; color: #1e40af;">Diferencia: ${formatCRC(diff)}</div>`; 
            } 
            document.getElementById('comparacionContent').innerHTML = html; 
            comp.classList.remove('hidden');
        }
        function toggleComparacion() { 
            modoComparacion = !modoComparacion; 
            document.getElementById('btnComparar').classList.toggle('active', modoComparacion); 
            vehiculosSeleccionados.clear(); 
            if (!modoComparacion) document.getElementById('comparador').classList.add('hidden'); 
            actualizarHistorialUI(); 
        }
        function toggleHistorial() { document.getElementById('historialCard').classList.toggle('hidden'); }
        function limpiarHistorial() { 
            if (confirm('¬øEst√°s seguro de que deseas borrar todo el historial?')) { 
                historial = []; 
                vehiculosSeleccionados.clear(); 
                localStorage.removeItem('impuestosHistorial'); 
                actualizarHistorialUI(); 
                document.getElementById('comparador').classList.add('hidden'); 
                showToast('Historial limpiado', 'info');
            } 
        }

        // --- L√ìGICA DE API (VIN Y TIPO DE CAMBIO) ---
        
        function handleVinInput() {
            clearTimeout(vinDecodeTimeout);
            
            const vin = this.value.toUpperCase().trim(); 
            const vinStatus = document.getElementById('vinStatus');
            limpiarFichaVIN();
            currentVinInfo = { make: '', model: '', year: '' }; 

            if (vin.length === 0) {
                vinStatus.innerHTML = '';
                return;
            }
            if (vin.length < 17) {
                vinStatus.innerHTML = `<span>VIN debe tener 17 caracteres (${vin.length}/17)</span>`;
                return;
            }

            if (vin.length === 17) {
                vinStatus.innerHTML = `<div class="spinner"></div><span>Decodificando VIN...</span>`;
                vinDecodeTimeout = setTimeout(() => {
                    fetchVinData(vin);
                }, 500);
            }
        }
        
        async function fetchVinData(vin) {
            const vinStatus = document.getElementById('vinStatus');
            try {
                const apiUrl = `https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVinValues/${vin}?format=json`;
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`Respuesta de red no fue OK (${response.status})`);
                }
                const data = await response.json();

                if (data && data.Results && data.Results[0]) {
                    if (data.Results[0].ErrorCode === "0" && data.Results[0].Make && data.Results[0].Model) { 
                        const vehicleInfo = data.Results[0];
                        vinStatus.innerHTML = '<span style="color: #059669;">‚úì VIN decodificado</span>';
                        displayVinData(vehicleInfo);
                        
                        currentVinInfo = {
                            make: vehicleInfo.Make || 'N/D',
                            model: vehicleInfo.Model || 'N/D',
                            year: vehicleInfo.ModelYear || 'N/D'
                        };

                        if (vehicleInfo.ModelYear) {
                            document.getElementById('ano').value = vehicleInfo.ModelYear;
                            document.getElementById('ano').dispatchEvent(new Event('change')); 
                        }
                    } else {
                        vinStatus.innerHTML = `<span style="color: #dc2626;">Error: ${data.Results[0].ErrorText || "VIN no encontrado o inv√°lido"}</span>`;
                        limpiarFichaVIN();
                        currentVinInfo = { make: '', model: '', year: '' }; 
                    }
                } else {
                    throw new Error("Formato de respuesta inesperado de la API o VIN no encontrado.");
                }
            } catch (error) {
                console.error('Error fetching VIN data:', error);
                vinStatus.innerHTML = `<span style="color: #dc2626;">Error al decodificar: ${error.message}. Revisa conexi√≥n o formato del VIN.</span>`;
                limpiarFichaVIN();
                currentVinInfo = { make: '', model: '', year: '' }; 
            }
        }
        async function fetchTipoDeCambio() {
            const tcInput = document.getElementById('tipoCambio');
            const tcHelp = document.getElementById('tipoCambioHelp');
            tcHelp.innerHTML = `<div class="spinner"></div><span>Actualizando TC desde BCCR...</span>`;
            const url = `https://api.hacienda.go.cr/indicadores/tc`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Error de red al consultar la API de Hacienda');
                const data = await response.json();
                const valorVenta = data?.dolar?.venta?.valor;
                if (valorVenta) {
                    tcInput.value = parseFloat(valorVenta).toFixed(2);
                    const fecha = new Date(data.dolar.venta.fecha).toLocaleString('es-CR', { dateStyle: 'short', timeStyle: 'short' });
                    tcHelp.innerHTML = `<span style="color:#059669">‚úì Actualizado (BCCR Ref.): ${fecha}</span>`;
                    document.getElementById('tcFooter').textContent = parseFloat(valorVenta).toFixed(2);
                } else {
                    throw new Error('La respuesta de la API no contiene el formato esperado.');
                }
            } catch (error) {
                console.error("Error fetching TC:", error);
                tcHelp.innerHTML = `<span style="color:#dc2626">Error al actualizar TC. Ingr√©selo manual.</span>`;
                document.getElementById('tcFooter').textContent = 'Error';
            }
        }
        function displayVinData(data) {
            let engineInfo = data.EngineCylinders ? `${data.EngineCylinders} Cilindros` : '';
            if (data.DisplacementL) engineInfo += ` ${data.DisplacementL}L`;
            document.getElementById('vinMake').textContent = data.Make || 'N/D';
            document.getElementById('vinModel').textContent = data.Model || 'N/Code';
            document.getElementById('vinTrim').textContent = data.Trim || 'N/D';
            document.getElementById('vinEngine').textContent = engineInfo.trim() || 'N/D';
            document.getElementById('vinCountry').textContent = data.PlantCountry || 'N/D';
            document.getElementById('vinInfoCard').classList.remove('hidden');
        }

        // --- FUNCIONES DE EXPORTACI√ìN Y AYUDA ---
        function generarTextoDesglose(esParaWhatsapp = false) {
            if (!calculoActual) return "";
            const d = calculoActual;
            const gastosAdminColones = (d.papeleoUSA * d.tc) + d.declaracion + d.dekra + d.almacenamiento;
            const b = esParaWhatsapp ? '*' : '';
            const line = '---------------------------------';
            const doubleLine = '=====================';
            
            let vinDisplay = '';
            if (d.vinInfo && d.vinInfo.make !== 'N/D' && d.vinInfo.model !== 'N/D') {
                vinDisplay = `Veh√≠culo: ${d.vinInfo.year} ${d.vinInfo.make} ${d.vinInfo.model}\n`;
            } else if (d.ano) {
                vinDisplay = `A√±o: ${d.ano}\n`;
            }

            const texto = `
${b}C√ÅLCULO IMPUESTOS VEH√çCULO CR${b}
${vinDisplay}TC: ${d.tc}
${doubleLine}

${b}Base (USD):${b}
Valor: ${formatUSD(d.valor)}
Flete: ${formatUSD(d.flete)}
*Subtotal USD:* ${formatUSD(d.valor + d.flete)}
${line}

${b}Costos (CRC):${b}
Veh√≠culo+Flete: ${formatCRC((d.valor + d.flete) * d.tc)}
Impuestos: ${formatCRC(d.impuestosUSD * d.tc)}
Gastos Admin.: ${formatCRC(gastosAdminColones)}
${doubleLine}
${b}TOTAL APROX.: ${formatCRC(d.totalColones)}${b}
${doubleLine}
Fecha c√°lculo: ${d.fecha}
            `.trim().split('\n').map(line => line.trim()).join('\n');
            return texto;
        }
        function descargarPDF() {
            if (!calculoActual) { showToast('Primero calcula un veh√≠culo', 'info'); return; }
            try {
                if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                    throw new Error("La librer√≠a jsPDF no est√° cargada.");
                }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const contenido = generarTextoDesglose();
                doc.setFont("Courier", "normal");
                doc.setFontSize(10);
                doc.text(contenido, 15, 20);
                doc.save(`Nacionalizacion-${calculoActual.ano}-${Date.now()}.pdf`);
            } catch (e) {
                console.error("Error al generar PDF:", e);
                showToast(`‚ùå No se pudo generar el PDF: ${e.message}`, 'error', 5000);
            }
        }
        function enviarWhatsApp() {
            if (!calculoActual) { showToast('Primero calcula un veh√≠culo', 'info'); return; }
            const mensaje = generarTextoDesglose(true);
            const whatsappURL = 'https://wa.me/?text=' + encodeURIComponent(mensaje);
            window.open(whatsappURL, '_blank');
        }

        // --- FUNCIONES DE LIMPIEZA ---
        function limpiarFichaVIN() { document.getElementById('vinInfoCard').classList.add('hidden'); }
        function limpiarFormulario() {
            ['vin', 'ano', 'valor', 'flete', 'tipoCambio', 'millaje', 'valorFiscal'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = '';
            });
            ['vinStatus', 'ayudaAno', 'tipoCambioHelp', 'resultadoTraspaso', 'detalleContent', 'tcFooter'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.innerHTML = '';
                if (id === 'tcFooter') element.textContent = 'N/A';
            });
            ['resultado', 'detalle', 'vinInfoCard', 'millajeInfoCard'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.classList.add('hidden');
            });
            calculoActual = null;
            currentVinInfo = { make: '', model: '', year: '' }; 
            
            handleVinInput.call(document.getElementById('vin'));

            fetchTipoDeCambio();
        }
        
        function limpiarVIN() {
            const vinInput = document.getElementById('vin');
            vinInput.value = '';

            handleVinInput.call(vinInput);
        }

        // --- *** INICIO: C√ìDIGO DEL SCANNER *** ---

        async function iniciarScanner() {
            const videoElement = document.getElementById('videoElement');
            const scannerContainer = document.getElementById('scanner-container');

            detenerScanner(); 

            try {
                if (typeof screen.orientation?.lock === 'function') {
                    try {
                        await screen.orientation.lock('landscape');
                    } catch (err) { console.warn("No se pudo bloquear la orientaci√≥n:", err); }
                }

                if (typeof ZXingBrowser === 'undefined' || !ZXingBrowser) {
                    throw new Error('Librer√≠a ZXingBrowser no cargada.');
                }

                const hints = new Map();
                const formats = [
                    ZXingBrowser.BarcodeFormat.CODE_39,
                    ZXingBrowser.BarcodeFormat.CODE_128,
                    ZXingBrowser.BarcodeFormat.QR_CODE,
                    ZXingBrowser.BarcodeFormat.DATA_MATRIX,
                    ZXingBrowser.BarcodeFormat.EAN_13,
                    ZXingBrowser.BarcodeFormat.UPC_A,
                    ZXingBrowser.BarcodeFormat.ITF,
                    ZXingBrowser.BarcodeFormat.PDF_417
                ];
                
                if (ZXingBrowser.DecodeHintType) {
                    hints.set(ZXingBrowser.DecodeHintType.POSSIBLE_FORMATS, formats);
                    hints.set(ZXingBrowser.DecodeHintType.TRY_HARDER, true);
                } else {
                    hints.set(1, formats); 
                }

                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                codeReader = new ZXingBrowser.BrowserMultiFormatReader(hints);

                scannerContainer.classList.remove('hidden');

                codeReader.decodeFromConstraints(constraints, videoElement, (result, err) => {
                    if (result) {
                        if (navigator.vibrate) { navigator.vibrate(100); }
                        
                        const vinInput = document.getElementById('vin');
                        vinInput.value = result.text; 
                        
                        handleVinInput.call(vinInput); 
                        
                        setTimeout(detenerScanner, 100); 
                    }
                    
                    if (err && err.name !== 'NotFoundException') {
                         console.error("Error durante escaneo continuo:", err); 
                    }
                }).catch(err => {
                    console.error("Error al INICIAR decodeFromConstraints:", err);
                    handleScannerError(err);
                    detenerScanner(); 
                });

                videoElement.addEventListener('loadedmetadata', () => {
                    if (videoElement.srcObject) {
                        const track = videoElement.srcObject.getVideoTracks()[0];
                        if (track && 'torch' in track.getCapabilities()) {
                            track.applyConstraints({ advanced: [{ torch: true }] })
                                .then(() => console.log("Linterna encendida."))
                                .catch(e => console.warn("No se pudo encender la linterna:", e));
                        }
                    }
                });

            } catch (error) {
                console.error("Error general en iniciarScanner:", error);
                handleScannerError(error);
                detenerScanner(); 
            }
        }

        function handleScannerError(error) {
            let errorMsg = `Error con el scanner: ${error.message}`;
            if (error.name === 'NotAllowedError') {
                errorMsg = "Debes permitir el uso de la c√°mara para continuar";
            } else if (error.name === 'NotFoundError') {
                errorMsg = "No se encontr√≥ una c√°mara compatible.";
            } else if (error.name === 'NotReadableError') {
                errorMsg = "La c√°mara est√° en uso o bloqueada.";
            } else if (error.message.includes("ZXingBrowser no cargada")) {
                errorMsg = "Error al cargar librer√≠a de escaneo.";
            }
            const scannerContainer = document.getElementById('scanner-container');
            if (scannerContainer && !scannerContainer.classList.contains('hidden')) {
                scannerContainer.classList.add('hidden');
            }
            showToast(`‚ùå ${errorMsg}`, 'error', 5000); 
        }

        function detenerScanner() {
            if (codeReader) {
                try {
                    codeReader.reset();
                } catch (resetError) { console.error("Error al resetear CodeReader:", resetError); }
                codeReader = null;
            }

            const videoElement = document.getElementById('videoElement');
            if (videoElement && videoElement.srcObject) {
                try {
                    const tracks = videoElement.srcObject.getVideoTracks();
                    tracks.forEach(track => {
                        if (track && 'torch' in track.getCapabilities()) {
                           const capabilities = track.getCapabilities();
                           const settings = track.getSettings();
                           if(capabilities.torch && settings.torch){ 
                                track.applyConstraints({ advanced: [{ torch: false }] })
                                    .then(() => console.log("Linterna apagada."))
                                    .catch(e => console.warn("No se pudo apagar la linterna:", e));
                           }
                        }
                        track.stop();
                    });
                }
                catch (e) { console.warn("Error menor al detener tracks:", e); }
                videoElement.srcObject = null;
            }
            if (videoElement) {
                videoElement.pause();
                videoElement.removeAttribute('src');
                videoElement.load();
            }


            const scannerContainer = document.getElementById('scanner-container');
            if (scannerContainer) scannerContainer.classList.add('hidden');

            if (typeof screen.orientation?.unlock === 'function') {
                try { screen.orientation.unlock(); }
                catch (err) { console.warn("No se pudo desbloquear orientaci√≥n:", err); }
            }
        }
        // --- *** FIN: C√ìDIGO DEL SCANNER *** ---

    </script>
    
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('service-worker.js')
            .then(registration => { console.log('SW registrado:', registration.scope); })
            .catch(error => { console.log('Error SW:', error); });
        });
      }
    </script>
</body>
</html>
